<?php
	session_start();
	include("configurarIdiomaJS.php");
	include("conexionBD.php");
	$idProceso=base64_decode($_GET["proc"]);
	
	
	$consulta="select valor,texto from 1004_siNo where idIdioma=".$_SESSION["leng"];
	$arrSiNo=$con->obtenerFilasArreglo($consulta);
	
	$consulta="select nombre,idTipoProceso,situacion from 4001_procesos where idProceso=".$idProceso." and situacion=1";
	$fProceso=$con->obtenerPrimeraFila($consulta);
	$tProceso=$fProceso[1];
	
	$consulta="select numEtapa,nombreEtapa from 4037_etapas where idProceso=".$idProceso;
	$resEtapas=$con->obtenerFilas($consulta);
	$arrEtapas=uEJ($con->obtenerFilasArreglo($consulta));
	
	$arrEtapasNumero="";
	while($fEtapas=mysql_fetch_row($resEtapas))
	{
		$o="['".$fEtapas[0]."','".removerCerosDerecha($fEtapas[0]).".- ".cv($fEtapas[1])."']";
		if($arrEtapasNumero=="")
			$arrEtapasNumero=$o;
		else
			$arrEtapasNumero.=",".$o;
	}
	
	$arrEtapasNumero="[".$arrEtapasNumero."]";
	
	$res5=$con->obtenerFilas("select idIdioma,idioma,imagen from 8002_idiomas where idiomaSistema=1");
	$columnas="";
	$ancho=470;
	while($fila5=mysql_fetch_row($res5))
	{
		if($columnas=="")
			$columnas= "{header:'<center><img src=\"../images/banderas/".$fila5[2]."\" title=\"".$fila5[1]."\" /></center>',width:190,dataIndex:'idioma_".$fila5[0]."',editor: new Ext.form.TextField ({  style: 'text-align:left'})}";
		else
			$columnas.=","."{header:'<center><img src=\"../images/banderas/".$fila5[2]."\" title=\"".$fila5[1]."\" /></center>',width:190,dataIndex:'idioma_".$fila5[0]."',editor: new Ext.form.TextField ({  style: 'text-align:left'})}";
	$ancho+=210;	
	}	
	if($ancho==255)
		$ancho+=210;
	$columnasDP=$columnas;
	$columnasDR=uEJ($columnas);
	$columnas.=",{header:'Pasa a etapa:',width:300,dataIndex:'numEtapa',editor:cmbPasaEtapa,renderer:formatearEtapa}";	
	$columnasDP.=",{header:'Acci&oacute;n autor:',width:200,dataIndex:'accion',editor:cmbAccion,renderer:formatearAccion},{header:'Requiere respuesta:',width:130,dataIndex:'reqRespuesta',editor:cmbSiNo,renderer:formatearSiNo}";	
	$columnas=uEJ($columnas);
	$columnasDP=uEJ($columnasDP);
	
	$campos="{name:'valorOpt'},{name:'icono'}";
	$camposOpciones="valorOpt:''";
	$filaDefault="''";
	if(mysql_data_seek($res5,0))
	{
		while($fila5=mysql_fetch_row($res5))
		{
			$campos.=",{name:'idioma_".$fila5[0]."'}";
			$camposOpciones.=",idioma_".$fila5[0].":''";
			$filaDefault.=",''";
		}	
	}
	$filaDefaultDR=$filaDefault;
	$filaDefaultDP=$filaDefault.=",'1'";
	$filaDefault.=",'0'";
	$camposDR=uEJ($campos);
	$camposDP=uEJ($campos.",{name:'accion'},{name:'reqRespuesta'}");
	$campos.=",{name:'numEtapa'}";
	$campos=uEJ($campos);
	$camposOpcionesDP=uEJ($camposOpciones.",accion:'1',reqRespuesta:'0'");
	$camposOpciones.=",numEtapa:'0'";
	$camposOpciones=uEJ($camposOpciones);
	if($tProceso!="9")
		$tOpcion=1;
	else
	{
		
		$tOpcion="9";
	}
	$consulta="select valorOpcion,opcion from 951_catalogoOpcionesVarios where tipoOpcion=".$tOpcion." and idIdioma=".$_SESSION["leng"];
	$arrOpciones=uEJ($con->obtenerFilasArreglo($consulta));
	$consulta="select valorOpcion,opcion from 951_catalogoOpcionesVarios where tipoOpcion=2 and idIdioma=".$_SESSION["leng"];
	$arrAcciones=uEJ($con->obtenerFilasArreglo($consulta));
	
	$consulta="select idTiempoPresupuestal, nombreTiempo from 524_tiemposPresupuestales";
	$arrTiempos=$con->obtenerFilasArreglo($consulta);
	
	$consulta="SELECT idCategoria,nombreCategoria FROM 908_categoriasDocumentos ORDER BY nombreCategoria";
	$arrTiposDocumentos=$con->obtenerFilasArreglo($consulta);
	$arrTiposDocumentos=substr($arrTiposDocumentos,1);
	$arrTiposDocumentos="[['0','Seleccionado por usuario'],".$arrTiposDocumentos;
	
	$arrProcesosActivos="";
	$consulta="SELECT idProceso,nombre,cveProceso FROM 4001_procesos WHERE situacion=1 AND idTipoProceso=3 ORDER BY nombre";
	$res=$con->obtenerFilas($consulta);
	while($fila=mysql_fetch_assoc($res))
	{
		$consulta="select numEtapa,nombreEtapa from 4037_etapas where idProceso=".$fila["idProceso"];
		$resEtapas=$con->obtenerFilas($consulta);
		$arrEtapasNumeroAux="";
		while($fEtapas=mysql_fetch_row($resEtapas))
		{
			$o="[parseFloat('".$fEtapas[0]."'),'".removerCerosDerecha($fEtapas[0]).".- ".cv($fEtapas[1])."']";
			if($arrEtapasNumeroAux=="")
				$arrEtapasNumeroAux=$o;
			else
				$arrEtapasNumeroAux.=",".$o;
		}
		
		$o="['".cv($fila["idProceso"])."','[".$fila["cveProceso"]."] ".cv($fila["nombre"])."',[".$arrEtapasNumeroAux."]]";
		if($arrProcesosActivos=="")
		{
			$arrProcesosActivos=$o;
		}
		else
		{
			$arrProcesosActivos.=",".$o;
		}
			
	}
	
	
	$arrProcesosActivos="[".$arrProcesosActivos."]";
	
	
	
	
	
	
	$consulta="select idValorSesion,descripcionValor,valorReemplazo from 8003_valoresSesion where tipo=1 order by descripcionValor ";
	$arrValorSesion=uEJ($con->obtenerFilasArreglo($consulta));
	$consulta="select idValorSesion,descripcionValor,valorReemplazo from 8003_valoresSesion where tipo=2 order by descripcionValor ";
	$arrValorSistema=uEJ($con->obtenerFilasArreglo($consulta));
	
	$idFormularioBase=obtenerFormularioBase($idProceso);
	
	$consulta="select * from(SELECT idGrupoElemento as idGrupoElemento,nombreCampo FROM 901_elementosFormulario WHERE idFormulario=".$idFormularioBase." AND tipoElemento IN(2,3,4,5,6,7,8,9,10,11,12,14,15,16,21,22,24,25,31)
			union
			SELECT tipoElemento as idGrupoElemento,campoUsr as nombreCampo FROM 9017_camposControlFormulario) as tmp order by nombreCampo 
		";
	$arrCamposFormularioBase=$con->obtenerFilasArreglo($consulta);
	
?>
var arrCamposFormularioBaseOrigen=<?php echo $arrCamposFormularioBase?>;
var arrCamposFormularioBaseDestino=[];
var arrValorSesionGlobal=<?php echo $arrValorSesion?>;
var arrValorSistemaGlobal=<?php echo $arrValorSistema?>;
var tiposLlenado=[['0','Ninguno'],['7','Funci\xF3n de sistema'],['6','Valor de formulario base'],['1','Valor de sesi\xF3n'],['8','Valor manual'],['2','Valor de sistema']];							
var arrProcesosActivos=<?php echo $arrProcesosActivos?>;
var arrTiposDocumentos=<?php echo $arrTiposDocumentos?>;
var arrSiNo=<?php echo $arrSiNo?>;
var arrAccionesFirma=[['10','Marcar para firma'],['1','Firmar mediante FIEL'],['6','Firmar mediante FIREL'],['4','Firmar mediante documento'],['5','Autorizar documento'],['2','Rechazar firma'],['3','Solicitar ajustes']];
var arrEtapasNumero=<?php echo $arrEtapasNumero?>;
arrEtapasNumero.splice(0,0,['0','Ninguna']);
var arrAccionesConsecuentes=[['0','Continuar dentro del proceso'],['1','Cerra ventana de proceso']];
var arrEtapas=<?php echo $arrEtapas?>;
var arrAcciones=<?php echo $arrAcciones?>;
var arrNinguna=['0','Ninguna'];
arrEtapas.push(arrNinguna);
var arrAmbito=[['0','S\xF3lo Institucion/departamento'],['1','Instituci\xF3n/departamento y subdepartamentos']];
function formatearAccion(val)
{
	var pos=existeValorMatriz(arrAcciones,val);
    if(pos>-1)
		return arrAcciones[pos][1];
    else
    	return val;
}


RegistroOpciones =Ext.data.Record.create	(
												[
													<?php 
														echo $campos;
													?>
												]
											)

function agregarActor(et)
{
	var idProceso=gE('idProceso').value;
	var arrActores=[];
	var gridActores=crearGridActores();
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Seleccione los actores a agregar:'
                                                        },
                                                        gridActores
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Agregar actores',
										width: 530,
										height:400,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var filas=gridActores.getSelectionModel().getSelections();
                                                                        if(filas.length==0)
                                                                        {
                                                                        	msgBox('Debe seleccionar al menos un actor para agregar a la etapa');
                                                                        	return;
                                                                        }
                                                                        
                                                                        var x;
                                                                        var etapa=et;
                                                                        var idProceso=gE('idProceso').value;
                                                                        var id;
                                                                        var tipo;
                                                                        var cadActores='';
                                                                        for(x=0;x<filas.length;x++)
                                                                        {
                                                                        	id=filas[x].get('idActor');
                                                                            tipo=filas[x].get('tipo');
                                                                            
                                                                            if(cadActores=='')
                                                                            	cadActores=id+'|'+tipo;
                                                                            else
                                                                            	cadActores+=','+id+'|'+tipo;
                                                                        }
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	ventanaAM.close();
                                                                                recargarTabEscenario();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=46&idProceso='+idProceso+'&numEtapa='+etapa+'&cadActores='+cadActores,true);
                                                                        
                                                                        
                                                                        
                                                                        
                                                                        
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	obtenerActoresDisponibles(et,idProceso,ventanaAM,gridActores.getStore());
}

function crearGridActores()
{
	dsDatos=[];
    alDatos=	new Ext.data.SimpleStore	(
                                                {
                                                    fields:	[
                                                                {name: 'id'},
                                                                {name: 'actor'},
                                                                {name: 'tipo'} //1 rol; 2 comite
                                                            ]
                                                }
                                            );

    alDatos.loadData(dsDatos);
	chkRow=new Ext.grid.CheckboxSelectionModel();
	
	var cModelo= new Ext.grid.ColumnModel   	(
												 	[
													 	new  Ext.grid.RowNumberer(),
														chkRow,
														{
															header:'Actor',
															width:200,
															sortable:true,
															dataIndex:'actor'
														},
                                                        {
                                                        	header:'Tipo actor',
															width:200,
															sortable:true,
															dataIndex:'tipo',
                                                            renderer:renderTipoUsuario
                                                        }
													]
												);
                                                
	var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gridActores',
                                                            store:alDatos,
                                                            frame:true,
                                                            x:10,
                                                            y:40,
                                                            cm: cModelo,
                                                            height:260,
                                                            width:490,
                                                            sm:chkRow
                                                        }
                                                    );
	return 	tblGrid;
}

function renderTipoUsuario(val)
{
	if(val=='1')
    	return "Usuario";
    else
    	return "Comit&eacute;";
}

function obtenerActoresDisponibles(etapa,idProceso,ventanaAM,almacen)
{
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var datos=eval(arrResp[1]);
            almacen.loadData(datos);
        	ventanaAM.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=45&idProceso='+idProceso+'&numEtapa='+etapa,true);
}

function agregarAccion(actor)
{
	var idProceso=gE('idProceso').value;
	var arrActores=[];
	var gridAcciones=crearGridAcciones();
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Seleccione las acciones a agregar:'
                                                        },
                                                        gridAcciones
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Agregar acci&oacute;n',
										width: 550,
										height:400,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var filas=gridAcciones.getSelectionModel().getSelections();
                                                                        if(filas.length==0)
                                                                        {
                                                                        	msgBox('Debe seleccionar al menos una acci&oacute;n para agregar al actor');
                                                                        	return;
                                                                        }
                                                                        var x;
                                                                        var cadAcciones='';
                                                                        var idGrupoAccion;
                                                                        for(x=0;x<filas.length;x++)
                                                                        {
                                                                        	idGrupoAccion=filas[x].get('idGrupoAccion');
                                                                            
                                                                            if(cadAcciones=='')
                                                                            	cadAcciones=idGrupoAccion;
                                                                            else
                                                                            	cadAcciones+=','+idGrupoAccion;
                                                                        }
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	ventanaAM.close();
                                                                                recargarTabEscenario();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=48&cadAcciones='+cadAcciones+'&actor='+actor,true);
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	
	obtenerAccionesActoresDisponibles(actor,ventanaAM,gridAcciones.getStore());
}

function crearGridAcciones()
{
	dsDatos=[];
    alDatos=	new Ext.data.SimpleStore	(
                                                {
                                                    fields:	[
                                                                {name: 'idGrupoAccion'},
                                                                {name: 'accion'}
                                                            ]
                                                }
                                            );

    alDatos.loadData(dsDatos);
	chkRow=new Ext.grid.CheckboxSelectionModel();
	
	var cModelo= new Ext.grid.ColumnModel   	(
												 	[
													 	new  Ext.grid.RowNumberer(),
														chkRow,
														{
															header:'Acci&oacute;n',
															width:410,
															sortable:true,
															dataIndex:'accion'
														}
													]
												);
                                                
	var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gridAccion',
                                                            store:alDatos,
                                                            frame:true,
                                                            x:10,
                                                            y:40,
                                                            cm: cModelo,
                                                            height:260,
                                                            width:500,
                                                            sm:chkRow
                                                        }
                                                    );
	return 	tblGrid;
}

function obtenerAccionesActoresDisponibles(actor,ventanaAM,almacen)
{
	var idProceso=gE('idProceso').value;
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var datos=eval(arrResp[1]);
            almacen.loadData(datos);
        	ventanaAM.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=47&actor='+actor+'&idProceso='+idProceso,true);
}

function removerActor(idActor)
{

	function resp(btn)
    {
		if(btn=='yes')
        {
            function funcAjax()
            {
                var resp=peticion_http.responseText;
                arrResp=resp.split('|');
                if(arrResp[0]=='1')
                {
                    var fila=gE('filaActor_'+idActor);
                    fila.parentNode.removeChild(fila);
                }
                else
                {
                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                }
            }
            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=49&idActorProcesoEtapa='+idActor,true);
        }
   }

   msgConfirmWin('Est&aacute; seguro de querer remover a este actor?',resp,330,120);
}

function removerAccion(idAccion)
{
	function resp(btn)
    {
		if(btn=='yes')
        {
            function funcAjax()
            {
                var resp=peticion_http.responseText;
                arrResp=resp.split('|');
                if(arrResp[0]=='1')
                {
                    var fila=gE('filaAccion_'+idAccion);
                    fila.parentNode.removeChild(fila);
                }
                else
                {
                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                }
            }
            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=50&idAccion='+idAccion,true);
		}
	}
    msgConfirmWin('Est&aacute; seguro de querer remover esta acci&oacute;n?',resp,330,120);       
}

function configurarSometeRevision(idAccion,numEtapa,etAct,gA)
{
	var arrEtapas=[];
    var lblEt='Seleccione la etapa a la cual pasar&aacute; el proceso:';
    var lblEtRes='Pasa a etapa: '
    gAc=0;
    if(gA!=undefined)
    {
    	gAc=gA;
    	switch(gA)
        {
        	case 12:
            	lblEt='Seleccione la etapa de la cual se somar&aacute; los posibles comit&eacute;s asignables:';
                lblEtRes='Asignar comités de la etapa:';
            break;
        }
    }
    
    
    var cmbEtapas=crearComboExt('cmbEtapas',arrEtapas,80,35);
    cmbEtapas.setWidth(300);
    if(etAct !=undefined)
    	cmbEtapas.setValue(etAct);
    var etiqueta=gE('lblEtiqueta_'+idAccion).innerHTML.trim();
    
    
    var oConf=eval('['+bD(gE('oConf_'+idAccion).value)+']')[0];

    var cmbComentariosAdicionales=crearComboExt('cmbComentariosAdicionales',[['0','No'],['1','S\xED']],230,185,120);
    cmbComentariosAdicionales.setValue(((oConf.solicitarComentarios==undefined)||(oConf.solicitarComentarios=='0'))?'0':'1');
    var cmAccionEnvio=crearComboExt('cmAccionEnvio',arrAccionesConsecuentes,320,215,210);
    cmAccionEnvio.setValue(((oConf.cerrarVentana==undefined)||(oConf.cerrarVentana=='0'))?'0':'1');
    
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:lblEt
                                                        },
                                                        {
                                                        	x:10,
                                                            y:40,
                                                            html:'Etapa:'
                                                        },
                                                        cmbEtapas,
                                                        {
                                                        	x:10,
                                                            y:70,
                                                            html:'Etiqueta:'
                                                        },
                                                        {
                                                        	x:80,
                                                            y:65,
                                                        	xtype:'textfield',
                                                            id:'txtEtiqueta',
                                                            width:200,
                                                            value:etiqueta
                                                        },
                                                        {
                                                        	x:320,
                                                            y:70,
                                                            html:'&Iacute;cono:'
                                                        },
                                                        {
                                                        	x:385,
                                                            y:65,
                                                            xtype:'textfield',
                                                            width:200,
                                                            value:oConf.icono!==undefined?oConf.icono:'',
                                                            id:'txtIcono'
                                                        },
                                                        {
                                                        	x:10,
                                                            y:100,
                                                            html:'Mensaje de confimaci&oacute;n:'
                                                        },
                                                        {
                                                        	x:140,
                                                            y:95,
                                                            xtype:'textarea',
                                                            id:'txtMensaje',
                                                            width:460,
                                                            height:80,
                                                            value:bD(gE('msgConf_'+idAccion).value)
                                                        },
                                                        {
                                                        	x:10,
                                                            y:190,
                                                            html:'Permitir agregar comentarios adicionales:'
                                                        },
                                                        cmbComentariosAdicionales,
                                                        
                                                        {
                                                        	x:10,
                                                            y:220,
                                                            html:'Acci&oacute;n a ejecutar una vez realizado el cambio de etapa:'
                                                        },
                                                        cmAccionEnvio,
                                                        {
                                                        	x:10,
                                                            y:250,
                                                            xtype:'label',
                                                            html:'Funci&oacute;n de visualizaci&oacute;n:'
                                                        },
                                                        {
                                                          xtype:'textfield',
                                                          width:350,
                                                          x:150,
                                                          y:245,
                                                          value:oConf.lblFuncionVisualizacion!==undefined?oConf.lblFuncionVisualizacion:'',
                                                          id:'txtFuncionVisualizacionDictamenFinal',
                                                          readOnly:true
                                                      },
                                                      {
                                                          xtype:'label',
                                                          x:520,
                                                          y:247,
                                                          html:'<a href="javascript:agregarFuncionControlEscenario(2)"><img src="../images/pencil.png"></a>&nbsp;&nbsp;<a href="javascript:removerFuncionControlEscenario(2)"><img src="../images/cross.png"></a>'
                                                      },
                                                         {
                                                        	x:10,
                                                            y:280,
                                                            xtype:'label',
                                                            html:'Funci&oacute;n de validaci&oacute;n:'
                                                        },
                                                        {
                                                          xtype:'textfield',
                                                          width:350,
                                                          x:150,
                                                          y:275,
                                                          value:oConf.lblFuncionValidacion!==undefined?oConf.lblFuncionValidacion:'',
                                                          id:'txtFuncionAplicacionDictamenFinal',
                                                          readOnly:true
                                                      },
                                                      {
                                                          xtype:'label',
                                                          x:520,
                                                          y:277,
                                                          html:'<a href="javascript:agregarFuncionControlEscenario(1)"><img src="../images/pencil.png"></a>&nbsp;&nbsp;<a href="javascript:removerFuncionControlEscenario(1)"><img src="../images/cross.png"></a>'
                                                      }
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Selecci&oacute;n de etapa',
										width: 650,
										height:390,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var numEt=cmbEtapas.getValue();
                                                                        var txtEtiqueta=gEx('txtEtiqueta').getValue();
                                                                        var txtMensaje=gEx('txtMensaje').getValue();
                                                                        
                                                                        if(numEt=='')
                                                                        {
                                                                        	msgBox('Debe Seleccionar la etapa a la cual pasar&aacute; el proceso');
                                                                        	return;
                                                                        }
                                                                        if(txtEtiqueta=='')
                                                                        {
                                                                        	msgBox('Debe ingresar la etiqueta a mostrar para esta acci&oacute;n');
                                                                            return;
                                                                        }
                                                                        
                                                                        if(txtMensaje=='')
                                                                        {
                                                                        	msgBox('Debe ingresar el mensaje mostrar para confirmar la acci&oacute;n');
                                                                            return;
                                                                        }
                                                                        
                                                                        var obj='{"etiqueta":"'+cv(txtEtiqueta)+'","msgConf":"'+cv(txtMensaje)+'","solicitarComentarios":"'+
                                                                        		cmbComentariosAdicionales.getValue()+'","cerrarVentana":"'+cmAccionEnvio.getValue()+
                                                                                '","icono":"'+cv(gEx('txtIcono').getValue())+'","funcionVisualizacion":"'+
                                                                                (gEx('txtFuncionVisualizacionDictamenFinal').getValue()==''?-1:gEx('txtFuncionVisualizacionDictamenFinal').idConsulta)+
                                                                                '","funcionValidacionSistema":"'+(gEx('txtFuncionAplicacionDictamenFinal').getValue()==''?-1:gEx('txtFuncionAplicacionDictamenFinal').idConsulta)+'"}';
                                                                        

                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	var spanDestino=gE('tblEtapas_'+idAccion);
                                                                                var etapaPasa= cmbEtapas.getRawValue();
                                                                                var cadSpan;
                                                                                switch(gAc)
                                                                                {
                                                                                	case 12:
                                                                                    	cadSpan="<span class='corpo8'><font color='#000055'><b>"+lblEtRes+"</b></font><br><font color='green'><b> "+etapaPasa+"</b></font></span>&nbsp;&nbsp;<a href='javascript:modificarPasoEtapa("+idAccion+","+numEtapa+","+numEt+",12)'><img src='../images/pencil.png' title='Cambiar etapa' alt='Cambiar etapa'></a>";
                                                                                    break;
                                                                                	default:
	                                                                                	cadSpan="<span class='corpo8'><font color='#000055'><b>"+lblEtRes+"</b></font><font color='green'><b> "+etapaPasa+"</b></font></span>&nbsp;&nbsp;<a href='javascript:modificarPasoEtapa("+idAccion+","+numEtapa+","+numEt+")'><img src='../images/pencil.png' title='Cambiar etapa' alt='Cambiar etapa'></a>";
                                                                                }
                                                                                spanDestino.innerHTML=cadSpan;
                                                                                var lblEtiqueta=gE('lblEtiqueta_'+idAccion);
                                                                                lblEtiqueta.innerHTML=txtEtiqueta;
                                                                                gE('msgConf_'+idAccion).value=bE(txtMensaje);
                                                                                
                                                                                obj='{"etiqueta":"'+cv(txtEtiqueta)+'","msgConf":"'+cv(txtMensaje)+'","solicitarComentarios":"'+
                                                                        		cmbComentariosAdicionales.getValue()+'","cerrarVentana":"'+cmAccionEnvio.getValue()+
                                                                                '","icono":"'+cv(gEx('txtIcono').getValue())+'","funcionVisualizacion":"'+
                                                                                (gEx('txtFuncionVisualizacionDictamenFinal').getValue()==''?-1:gEx('txtFuncionVisualizacionDictamenFinal').idConsulta)+
                                                                                '","funcionValidacionSistema":"'+(gEx('txtFuncionAplicacionDictamenFinal').getValue()==''?-1:gEx('txtFuncionAplicacionDictamenFinal').idConsulta)+
                                                                                '","lblFuncionVisualizacion":"'+cv(gEx('txtFuncionVisualizacionDictamenFinal').getValue(),false,true)+'","lblFuncionValidacion":"'+
                                                                                cv(gEx('txtFuncionAplicacionDictamenFinal').getValue(),false,true)+'"}';
                                                                        
                                                                                
                                                                                gE('oConf_'+idAccion).value=bE(obj);
                                                                            	ventanaAM.close();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=52&idAccion='+idAccion+'&numEtapa='+numEt+'&objComp='+obj,true);
                                                                        
                                                                        
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);


	gEx('txtFuncionAplicacionDictamenFinal').idConsulta=oConf.funcionValidacionSistema!==undefined?oConf.funcionValidacionSistema:'-1';
    gEx('txtFuncionVisualizacionDictamenFinal').idConsulta=oConf.funcionVisualizacion!==undefined?oConf.funcionVisualizacion:'-1';
                         
	obtenerEtapasDisponibles(idAccion,0,numEtapa,ventanaAM,cmbEtapas.getStore());                                

}

function obtenerEtapasDisponibles(idAccion,idActor,et,ventana,almacen,ninguna,grupoElemento)
{
	var idProceso=gE('idProceso').value;
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var arrEt=eval(arrResp[1]);
            if(ninguna!=undefined)
            	arrEt.push(['0','Ninguna']);
            almacen.loadData(arrEt);
            if(grupoElemento==null)
	            ventana.show();
            else
            	llenarOpcionesDictamen(idAccion,idActor,grupoElemento,ventana);
            
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=51&idProceso='+idProceso+'&numEtapa='+et,true);
}

function llenarOpcionesDictamen(idAccion,idActor,idGrupoElemento,ventana)
{
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var arrParam=eval(arrResp[1]);
			if(arrResp[2]!='')
            {
            	var objDictamen=eval('['+arrResp[2]+']')[0];
                gEx('etiquetaAccion').setValue(objDictamen.etiqueta);
                if(objDictamen.accionFinalizar!==undefined)
                {
                	gEx('cmAccionEnvio').setValue(objDictamen.accionFinalizar);
                }
                if(objDictamen.mostrarFormularioAsociado!==undefined)
                {
                	gEx('cmbMostrarFormularioAsociado').setValue(objDictamen.mostrarFormularioAsociado);
                }
                if(objDictamen.requiereTodasSecciones!==undefined)
                {
                	gEx('cmbEsperaLlenado').setValue(objDictamen.requiereTodasSecciones);	
                }
                
                if(objDictamen.funcionVisualizacion!==undefined)
                {
                	gEx('txtFuncionVisualizacionDictamenFinal').setValue(objDictamen.lblFuncionVisualizacion);	
                    gEx('txtFuncionVisualizacionDictamenFinal').idConsulta=objDictamen.funcionVisualizacion;
                }
                
                if(objDictamen.funcionValidacion!==undefined)
                {
                	gEx('txtFuncionAplicacionDictamenFinal').setValue(objDictamen.lblFuncionValidacion);	
                    gEx('txtFuncionAplicacionDictamenFinal').idConsulta=objDictamen.funcionValidacion;
                }
                
                if(objDictamen.icono!==undefined)
                {
                	 gEx('txtIcono').setValue(objDictamen.icono);
                }
                
               
                
			}
            else
            {
            	gEx('etiquetaAccion').setValue('Realiza dictamen final');
            	  
            }	
            Ext.getCmp('gridOpcionesManuales').getStore().loadData(arrParam);
        	ventana.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=54&idAccion='+bD(idAccion)+'&idElemento='+idGrupoElemento,true);


}

function modificarPasoEtapa(idAccion,numEtapa,etAct,gA)
{
	configurarSometeRevision(idAccion,numEtapa,etAct,gA)
}


function configurarDictamenFinal(iA,iAccion,e,idGrupoElemento)
{
	var cmAccionEnvio=crearComboExt('cmAccionEnvio',arrAccionesConsecuentes,250,270,195);
	cmAccionEnvio.setValue('0');
    
    var cmbMostrarFormularioAsociado=crearComboExt('cmbMostrarFormularioAsociado',arrSiNo,630,270,80);
    cmbMostrarFormularioAsociado.setValue('1');
    
    var cmbEsperaLlenado=crearComboExt('cmbEsperaLlenado',arrSiNo,250,300,80);
    cmbEsperaLlenado.setValue('0');
    
    
	var idAccion=bD(iAccion);
    var et=bD(e);
    var idActor=bD(iA);
	var arrEtapas=[];
    var grupoElemento=null;
    if(idGrupoElemento!=undefined)
    {
	    idGrupoElemento=bD(idGrupoElemento);
    	grupoElemento=idGrupoElemento;
    }
	var cmbPasaEtapa=crearComboExt('cmbPasaEtapa',arrEtapas);
    var dsOpciones= [<?php echo "[".$filaDefault."]" ?>];
    alOpciones=		new Ext.data.SimpleStore(
                                                {
                                                    fields:	[
                                                                <?php 
                                                                    echo $campos;
                                                                ?>
                                                            ]
                                                }
                                            );
    
    alOpciones.loadData(dsOpciones);
    var cmFrmDTD= new Ext.grid.ColumnModel   	(
                                                    [
                                                        new  Ext.grid.RowNumberer(),
                                                        {
                                                            header:'Clave',
                                                            width:70,
                                                            dataIndex:'valorOpt',
                                                            editor: new Ext.form.TextField   (
                                                                                                    {
                                                                                                      
                                                                                                       style: 'text-align:left'
                                                                                                    }
                                                                                                )
                                                        },
                                                        {
                                                            header:'Icono',
                                                            width:100,
                                                            dataIndex:'icono',
                                                            editor: new Ext.form.TextField   (
                                                                                                    {
                                                                                                      
                                                                                                       style: 'text-align:left'
                                                                                                    }
                                                                                                )
                                                        }
                                                        ,
                                                        <?php 
                                                            echo $columnas;
                                                        ?>
                                                    ]
                                                );
    
    
    
    tblOpciones=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gridOpcionesManuales',
                                                            store:alOpciones,
                                                            frame:false,
                                                            clicksToEdit: 1,
                                                            cm: cmFrmDTD,
                                                            height:210,
                                                            columnLines:true,
                                                            width:<?php echo $ancho+35 ?>,
                                                            title:'Ingrese los posibles valores de dict&aacute;men:',
                                                            tbar: [
                                                                    {
                                                                        text: 'Agregar opci&oacute;n',
                                                                        icon:'../images/add.png',
                                                                        handler : function()
                                                                                  {
                                                                                        var r=new RegistroOpciones	(
                                                                                                                        {
                                                                                                                            <?php echo $camposOpciones?>
                                                                                                                        }
                                                                                                                    ) 	
                                                                                        alOpciones.add(r);	
                                                                                        tblOpciones.startEditing(alOpciones.getCount()-1,1);
                                                                                  }
                                                                    }
                                                                    ,
                                                                    {
                                                                        text:'Eliminar Opci&oacute;n',
                                                                        icon:'../images/cancel_round.png',
                                                                        handler:function()
                                                                                {
                                                                                    var fila=tblOpciones.getSelectionModel().getSelectedCell();
                                                                                    if(fila!=null)
                                                                                    {
                                                                                        var posFila=alOpciones.getAt(fila[0]);
                                                                                        function funcConfirmDel(btn)
                                                                                        {
                                                                                        	
                                                                                            if(btn=="yes")
                                                                                            {
                                                                                                alOpciones.remove(posFila);
                                                                                            }
                                                                                        }
                                                                                       msgConfirmWin('Est&aacute; seguro de querer eliminar esta opci&oacute;n?',funcConfirmDel);
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        msgBox('Debe seleccionar la opci&oacute;n a remover');
                                                                                    }
                                                                                    
                                                                                }  
                                                                    }
                                                                    
                                                                  ]
                                                        }
                                                    );
    
    function funcEdicion(e)
    {
        if(e.field=='valorOpt')
        {
            var res=obtenerPosFila(e.grid.getStore(),'valorOpt',e.value);
            if((res!='-1')&&(e.row!=res))
            {
                function funcOK()
                {
                    e.record.set('valorOpt',e.originalValue);
                    e.grid.getView().refresh();
                    e.grid.startEditing(e.row,e.column);
                }
                Ext.MessageBox.alert('<?php echo $etj["lblAplicacion"]?>','La opci&oacute;n ingresada ya se encuentra registrada',funcOK);
            }
        }
    }
    tblOpciones.on('afteredit',funcEdicion);
    
    panelGrid=new Ext.Panel	(
                                {
                                    y:40,
                                    items:	[
                                                tblOpciones
                                            ]
                                }
                            );
                            
   
    var form = new Ext.form.FormPanel(	
                                        {
                                            baseCls: 'x-plain',
                                            layout:'absolute',
                                            defaultType: 'textfield',
                                            items: 	[
                                            			{
                                                        	x:10,
                                                            y:10,
                                                            xtype:'label',
                                                            html:'Etiqueta de la acci&oacute;n:'
                                                        },
                                                        {
                                                        	x:135,
                                                            y:5,
                                                            xtype:'textfield',
                                                            id:'etiquetaAccion',
                                                            width:250
                                                            
                                                        },
                                                        {
                                                        	x:420,
                                                            y:10,
                                                            xtype:'label',
                                                            html:'&Iacute;cono:'
                                                        },
                                                        {
                                                        	x:475,
                                                            y:5,
                                                            xtype:'textfield',
                                                            width:150,
                                                            id:'txtIcono'
                                                        },
                                                        panelGrid,
                                                        {
                                                        	x:10,
                                                            y:275,
                                                            xtype:'label',
                                                            html:'Acción a ejecutar una vez dictaminado:'
                                                        },
                                                        cmAccionEnvio,
                                                        {
                                                        	x:470,
                                                            y:275,
                                                            xtype:'label',
                                                            html:'Mostrar formulario asociado:'
                                                        },
                                                        cmbMostrarFormularioAsociado,
                                                        {
                                                        	x:10,
                                                            y:305,
                                                            xtype:'label',
                                                            html:'Esperar a llenado de secciones obligatorias?:'
                                                        },
                                                        cmbEsperaLlenado,
                                                        {
                                                        	x:10,
                                                            y:330,
                                                            xtype:'label',
                                                            html:'Funci&oacute;n de visualizaci&oacute;n:'
                                                        },
                                                        {
                                                          xtype:'textfield',
                                                          width:350,
                                                          x:150,
                                                          y:325,
                                                          id:'txtFuncionVisualizacionDictamenFinal',
                                                          readOnly:true
                                                      },
                                                      {
                                                          xtype:'label',
                                                          x:520,
                                                          y:327,
                                                          html:'<a href="javascript:agregarFuncionControlEscenario(2)"><img src="../images/pencil.png"></a>&nbsp;&nbsp;<a href="javascript:removerFuncionControlEscenario(2)"><img src="../images/cross.png"></a>'
                                                      },
                                                         {
                                                        	x:10,
                                                            y:360,
                                                            xtype:'label',
                                                            html:'Funci&oacute;n de validaci&oacute;n:'
                                                        },
                                                        {
                                                          xtype:'textfield',
                                                          width:350,
                                                          x:150,
                                                          y:355,
                                                          id:'txtFuncionAplicacionDictamenFinal',
                                                          readOnly:true
                                                      },
                                                      {
                                                          xtype:'label',
                                                          x:520,
                                                          y:357,
                                                          html:'<a href="javascript:agregarFuncionControlEscenario(1)"><img src="../images/pencil.png"></a>&nbsp;&nbsp;<a href="javascript:removerFuncionControlEscenario(1)"><img src="../images/cross.png"></a>'
                                                      }
                                                        
                                                    ]
                                        }
                                    );
    
    

    
    
    
    btnSiguiente=new Ext.Button	(
                                    {
                                        text: 'Aceptar',
                                        minWidth:80,
                                        id:'btnAceptar',
                                        listeners:	{
                                                        click:
                                                                {
                                                                    fn:function()
                                                                    {
                                                                    	if(gEx('etiquetaAccion').getValue()=='')
                                                                        {
                                                                        	function resp2()
                                                                            {
                                                                            	gEx('etiquetaAccion').focus();
                                                                            }
                                                                            msgBox('Debe ingresar la etiqueta de la acci&oacute;n',resp2);
                                                                            return;
                                                                        }
                                                                        var resul=validarOpciones(tblOpciones.getStore(),tblOpciones);
                                                                        
                                                                        var txtFuncionVisualizacionDictamenFinal=gEx('txtFuncionVisualizacionDictamenFinal');
                                                                        var txtFuncionAplicacionDictamenFinal=gEx('txtFuncionAplicacionDictamenFinal');
                                                                        var objConfDictamen='{"etiqueta":"'+cv(gEx('etiquetaAccion').getValue())+'","accionFinalizar":"'+cmAccionEnvio.getValue()+
                                                                        					'","mostrarFormularioAsociado":"'+gEx('cmbMostrarFormularioAsociado').getValue()+
                                                                                            '","funcionVisualizacion":"'+((txtFuncionVisualizacionDictamenFinal.getValue()=='')?'-1':txtFuncionVisualizacionDictamenFinal.idConsulta)+
                                                                                            '","funcionValidacion":"'+((txtFuncionAplicacionDictamenFinal.getValue()=='')?'-1':txtFuncionAplicacionDictamenFinal.idConsulta)+
                                                                                            '","requiereTodasSecciones":"'+cmbEsperaLlenado.getValue()+'","icono":"'+cv(gEx('txtIcono').getValue())+'"}';
                                                                            
                                                                        
                                                                            
                                                                        if(resul)
                                                                        {
                                                                            var opciones=obtenerValoresOpcionesManuales();
                                                                            
                                                                            function funcAjax()
                                                                            {
                                                                                var resp=peticion_http.responseText;
                                                                                arrResp=resp.split('|');
                                                                                if(arrResp[0]=='1')
                                                                                {
                                                                                	ventanaPregCerradas.close();
                                                                                    recargarTabEscenario();
                                                                                }
                                                                                else
                                                                                {
                                                                                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                }
                                                                            }
                                                                            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=53&objOpciones={"idActor":"'+idActor+
                                                                            '","etiqueta":"'+cv(gEx('etiquetaAccion').getValue())+'","opciones":'+opciones+'}&objConfDictamen='+objConfDictamen+
                                                                            '&idAccion='+idAccion,true);
                                                                            
                                                                            
                                                                            
                                                                        }
                                                                        
                                                                    }
                                                                }
                                                    }
                                    }
                                )
    
    var ventanaPregCerradas = new Ext.Window(
                                            {
                                                title: 'Opciones de dictamen',
                                                width: <?php echo ($ancho+65) ?> ,
                                                y:window.parent.obtenerPosicionScroll(),
                                                height:470,
                                                minWidth: 300,
                                                minHeight: 100,
                                                layout: 'fit',
                                                plain:true,
                                                modal:true,
                                                bodyStyle:'padding:5px;',
                                                buttonAlign:'center',
                                                items: 	[
                                                            form
                                                        ],
                                                listeners : {
                                                            show : {
                                                                        buffer : 10,
                                                                        fn : function() 
                                                                        {
                                                                           gEx('etiquetaAccion').focus(false,500);
                                                                        }
                                                                    }
                                                        },
                                                buttons:	[
                                                                btnSiguiente,
                                                                {
                                                                    text: 'Cancelar',
                                                                    handler:function()
                                                                    {
                                                                    	
                                                                        ventanaPregCerradas.close();
                                                                    }
                                                                }
                                                            ]
                                            }
                                        );
	
	
	obtenerEtapasDisponibles(iAccion,idActor,et,ventanaPregCerradas,cmbPasaEtapa.getStore(),true,grupoElemento);
    
}

function formatearEtapa(val)
{
	var pos=existeValorMatriz(arrEtapas,val);
    if(pos>-1)
		return removerCerosDerecha(val+'')+'.- '+arrEtapas[pos][1];
    else
    	return val;
}


 
function formatearSiNo(val)
{
	var pos=existeValorMatriz(arrSiNo,val);
    if(pos>-1)
		return arrSiNo[pos][1];
    else
    	return val;
}
 
function configurarDictamenParcial(iA,iAccion,e,idGrupoElemento)
{
	var idAccion=bD(iAccion);
    var et=bD(e);
    var idActor=bD(iA);
	var arrEtapas=[];
    var grupoElemento=null;
    if(idGrupoElemento!=undefined)
    {
	    idGrupoElemento=bD(idGrupoElemento);
    	grupoElemento=idGrupoElemento;
    }
    var grupoElemento=null;
    if(idGrupoElemento!=undefined)
    	grupoElemento=idGrupoElemento;
	var cmbAccion=crearComboExt('cmbAccion',arrAcciones);
   
    var cmbSiNo=crearComboExt('cmbSiNo',arrSiNo);
    var dsOpciones= [<?php echo "[".$filaDefaultDP."]" ?>];
    alOpciones=		new Ext.data.SimpleStore(
                                                {
                                                    fields:	[
                                                                <?php 
                                                                    echo $camposDP;
                                                                ?>
                                                            ]
                                                }
                                            );
    
    alOpciones.loadData(dsOpciones);
    var cmFrmDTD= new Ext.grid.ColumnModel   	(
                                                    [
                                                        new  Ext.grid.RowNumberer(),
                                                        {
                                                            header:'Clave',
                                                            width:100,
                                                            dataIndex:'valorOpt',
                                                            editor: new Ext.form.TextField   (
                                                                                                    {
                                                                                                      
                                                                                                       style: 'text-align:left'
                                                                                                    }
                                                                                                )
                                                        }
                                                        ,
                                                        <?php 
                                                            echo $columnasDP;
                                                        ?>
                                                    ]
                                                );
    
    
    
    tblOpciones=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gridOpcionesManuales',
                                                            store:alOpciones,
                                                            frame:true,
                                                            clicksToEdit: 1,
                                                            cm: cmFrmDTD,
                                                            height:300,
                                                            columnLines:true,
                                                            width:<?php echo $ancho+35 ?>,
                                                            title:'Ingrese los posibles valores de dict&aacute;men:',
                                                            tbar: [
                                                                    {
                                                                        text: 'Agregar opci&oacute;n',
                                                                        icon:'../images/add.png',
                                                                        handler : function()
                                                                                  {
                                                                                        var r=new RegistroOpciones	(
                                                                                                                        {
                                                                                                                            <?php echo $camposOpcionesDP?>
                                                                                                                        }
                                                                                                                    ) 	
                                                                                        alOpciones.add(r);	
                                                                                        tblOpciones.startEditing(alOpciones.getCount()-1,1);
                                                                                  }
                                                                    }
                                                                    ,
                                                                    {
                                                                        text:'Eliminar Opci&oacute;n',
                                                                        icon:'../images/cancel_round.png',
                                                                        handler:function()
                                                                                {
                                                                                    var fila=tblOpciones.getSelectionModel().getSelectedCell();
                                                                                    if(fila!=null)
                                                                                    {
                                                                                        var posFila=alOpciones.getAt(fila[0]);
                                                                                        function funcConfirmDel(btn)
                                                                                        {
                                                                                            if(btn=="yes")
                                                                                            {
                                                                                                alOpciones.remove(posFila);
                                                                                            }
                                                                                        }
                                                                                       msgConfirmWin('Est&aacute; seguro de querer eliminar esta opci&oacute;n?',funcConfirmDel);
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        msgBox('Debe seleccionar la opci&oacute;n a remover');
                                                                                    }
                                                                                    
                                                                                }  
                                                                    }
                                                                    
                                                                  ]
                                                        }
                                                    );
    
    function funcEdicion(e)
    {
        if(e.field=='valorOpt')
        {
            var res=obtenerPosFila(e.grid.getStore(),'valorOpt',e.value);
            if((res!='-1')&&(e.row!=res))
            {
                function funcOK()
                {
                    e.record.set('valorOpt',e.originalValue);
                    e.grid.getView().refresh();
                    e.grid.startEditing(e.row,e.column);
                }
                Ext.MessageBox.alert('<?php echo $etj["lblAplicacion"]?>','La opci&oacute;n ingresada ya se encuentra registrada',funcOK);
            }
        }
    }
    tblOpciones.on('afteredit',funcEdicion);
    
    panelGrid=new Ext.Panel	(
                                {
                                    y:40,
                                    items:	[
                                                tblOpciones
                                            ]
                                }
                            );
                            
   
    var form = new Ext.form.FormPanel(	
                                        {
                                            baseCls: 'x-plain',
                                            layout:'absolute',
                                            defaultType: 'textfield',
                                            items: 	[
                                            			{
                                                        	x:10,
                                                            y:10,
                                                            xtype:'label',
                                                            html:'Etiqueta de la acci&oacute;n:'
                                                        },
                                                        {
                                                        	x:135,
                                                            y:5,
                                                            xtype:'textfield',
                                                            id:'etiquetaAccion',
                                                            width:250
                                                            
                                                        },
                                                        panelGrid
                                                        
                                                    ]
                                        }
                                    );
    
    

    
    
    
    btnSiguiente=new Ext.Button	(
                                    {
                                        text: 'Aceptar',
                                        minWidth:80,
                                        id:'btnAceptar',
                                        listeners:	{
                                                        click:
                                                                {
                                                                    fn:function()
                                                                    {
                                                                    	if(gEx('etiquetaAccion').getValue()=='')
                                                                        {
                                                                        	function resp2()
                                                                            {
                                                                            	gEx('etiquetaAccion').focus();
                                                                            }
                                                                            msgBox('Debe ingresar la etiqueta de la acci&oacute;n',resp2);
                                                                            return;
                                                                        }
                                                                        var resul=validarOpciones(tblOpciones.getStore(),tblOpciones);
                                                                            
                                                                        if(resul)
                                                                        {
                                                                            var opciones=obtenerValoresOpcionesManualesDP();
                                                                            
                                                                            function funcAjax()
                                                                            {
                                                                                var resp=peticion_http.responseText;
                                                                                arrResp=resp.split('|');
                                                                                if(arrResp[0]=='1')
                                                                                {
                                                                                	ventanaPregCerradas.close();
                                                                                    recargarTabEscenario();
                                                                                }
                                                                                else
                                                                                {
                                                                                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                }
                                                                            }
                                                                            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=69&objOpciones={"idActor":"'+idActor+'","etiqueta":"'+gEx('etiquetaAccion').getValue()+'","opciones":'+opciones+'}&idAccion='+idAccion,true);
                                                                            
                                                                            
                                                                            
                                                                        }
                                                                        
                                                                    }
                                                                }
                                                    }
                                    }
                                )
    
    var ventanaPregCerradas = new Ext.Window(
                                            {
                                                title: 'Opciones de dictamen',
                                                width: <?php echo ($ancho+65) ?> ,
                                                height:470,
                                                minWidth: 300,
                                                minHeight: 100,
                                                layout: 'fit',
                                                plain:true,
                                                modal:true,
                                                bodyStyle:'padding:5px;',
                                                buttonAlign:'center',
                                                items: 	[
                                                            form
                                                        ],
                                                listeners : {
                                                            show : {
                                                                        buffer : 10,
                                                                        fn : function() 
                                                                        {
                                                                         	gEx('etiquetaAccion').focus(false,500);
                                                                        }
                                                                    }
                                                        },
                                                buttons:	[
                                                                btnSiguiente,
                                                                {
                                                                    text: 'Cancelar',
                                                                    handler:function()
                                                                    {
                                                                    	
                                                                        ventanaPregCerradas.close();
                                                                    }
                                                                }
                                                            ]
                                            }
                                        );
	llenarOpcionesDictamenParcial(idActor,ventanaPregCerradas,idGrupoElemento);

}

function llenarOpcionesDictamenParcial(idActor,ventana,idGrupoElemento)
{
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var arrDatos=eval(arrResp[1]);
            gEx('etiquetaAccion').setValue(arrResp[2]);
            Ext.getCmp('gridOpcionesManuales').getStore().loadData(arrDatos);
            ventana.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=71&idActor='+idActor+'&idGrupoElemento='+idGrupoElemento,true);
}




function configurarDictamenRevisor(idAccion,et,idGrupoElemento)
{
	
    var grupoElemento=null;
    if(idGrupoElemento!=undefined)
    	grupoElemento=idGrupoElemento;
	
    var dsOpciones= [<?php echo "[".$filaDefaultDR."]" ?>];
    alOpciones=		new Ext.data.SimpleStore(
                                                {
                                                    fields:	[
                                                                <?php 
                                                                    echo $camposDR;
                                                                ?>
                                                            ]
                                                }
                                            );
    
    alOpciones.loadData(dsOpciones);
    var cmFrmDTD= new Ext.grid.ColumnModel   	(
                                                    [
                                                        new  Ext.grid.RowNumberer(),
                                                        {
                                                            header:'Clave',
                                                            width:100,
                                                            dataIndex:'valorOpt',
                                                            editor: new Ext.form.TextField   (
                                                                                                    {
                                                                                                      
                                                                                                       style: 'text-align:left'
                                                                                                    }
                                                                                                )
                                                        }
                                                        ,
                                                        <?php 
                                                            echo $columnasDR;
                                                        ?>
                                                    ]
                                                );
    
    
    
    tblOpciones=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gridOpcionesManualesDR',
                                                            store:alOpciones,
                                                            frame:true,
                                                            clicksToEdit: 1,
                                                            cm: cmFrmDTD,
                                                            height:270,
                                                            columnLines:true,
                                                            width:<?php echo $ancho+35-350 ?>,
                                                            title:'Ingrese los posibles valores de dict&aacute;men:',
                                                            tbar: [
                                                                    {
                                                                        text: 'Agregar opci&oacute;n',
                                                                        icon:'../images/add.png',
                                                                        handler : function()
                                                                                  {
                                                                                        var r=new RegistroOpciones	(
                                                                                                                        {
                                                                                                                            <?php echo $camposOpcionesDP?>
                                                                                                                        }
                                                                                                                    ) 	
                                                                                        alOpciones.add(r);	
                                                                                        tblOpciones.startEditing(alOpciones.getCount()-1,1);
                                                                                  }
                                                                    }
                                                                    ,
                                                                    {
                                                                        text:'Eliminar Opci&oacute;n',
                                                                        icon:'../images/cancel_round.png',
                                                                        handler:function()
                                                                                {
                                                                                    var fila=tblOpciones.getSelectionModel().getSelectedCell();
                                                                                    if(fila!=null)
                                                                                    {
                                                                                        var posFila=alOpciones.getAt(fila[0]);
                                                                                        function funcConfirmDel(btn)
                                                                                        {
                                                                                            if(btn=="yes")
                                                                                            {
                                                                                                alOpciones.remove(posFila);
                                                                                            }
                                                                                        }
                                                                                       msgConfirmWin('Est&aacute; seguro de querer eliminar esta opci&oacute;n?',funcConfirmDel);
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        msgBox('Debe seleccionar la opci&oacute;n a remover');
                                                                                    }
                                                                                    
                                                                                }  
                                                                    }
                                                                    
                                                                  ]
                                                        }
                                                    );
    
    function funcEdicion(e)
    {
        if(e.field=='valorOpt')
        {
            var res=obtenerPosFila(e.grid.getStore(),'valorOpt',e.value);
            if((res!='-1')&&(e.row!=res))
            {
                function funcOK()
                {
                    e.record.set('valorOpt',e.originalValue);
                    e.grid.getView().refresh();
                    e.grid.startEditing(e.row,e.column);
                }
                Ext.MessageBox.alert('<?php echo $etj["lblAplicacion"]?>','La opci&oacute;n ingresada ya se encuentra registrada',funcOK);
            }
        }
    }
    tblOpciones.on('afteredit',funcEdicion);
    
    panelGrid=new Ext.Panel	(
                                {
                                    y:10,
                                    items:	[
                                                tblOpciones
                                            ]
                                }
                            );
                            
   
    var form = new Ext.form.FormPanel(	
                                        {
                                            baseCls: 'x-plain',
                                            layout:'absolute',
                                            defaultType: 'textfield',
                                            items: 	[
                                                        panelGrid
                                                        
                                                    ]
                                        }
                                    );
    
    

    
    
    
    btnSiguiente=new Ext.Button	(
                                    {
                                        text: 'Aceptar',
                                        minWidth:80,
                                        id:'btnAceptar',
                                        listeners:	{
                                                        click:
                                                                {
                                                                    fn:function()
                                                                    {
                                                                        var resul=validarOpciones(tblOpciones.getStore(),tblOpciones);
                                                                            
                                                                        if(resul)
                                                                        {
                                                                            var opciones=obtenerValoresOpcionesManualesDR();
                                                                            
                                                                            function funcAjax()
                                                                            {
                                                                                var resp=peticion_http.responseText;
                                                                                arrResp=resp.split('|');
                                                                                if(arrResp[0]=='1')
                                                                                {
                                                                                	ventanaPregCerradas.close();
                                                                                    recargarTabEscenario();
                                                                                }
                                                                                else
                                                                                {
                                                                                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                }
                                                                            }
                                                                            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=70&objOpciones={"opciones":'+opciones+'}&idAccion='+idAccion,true);
                                                                            
                                                                            
                                                                            
                                                                        }
                                                                        
                                                                    }
                                                                }
                                                    }
                                    }
                                )
    
    var ventanaPregCerradas = new Ext.Window(
                                            {
                                                title: 'Opciones de dictamen',
                                                width: <?php echo ($ancho+65-350) ?> ,
                                                height:400,
                                                minWidth: 300,
                                                minHeight: 100,
                                                layout: 'fit',
                                                plain:true,
                                                modal:true,
                                                bodyStyle:'padding:5px;',
                                                buttonAlign:'center',
                                                items: 	[
                                                            form
                                                        ],
                                                listeners : {
                                                            show : {
                                                                        buffer : 10,
                                                                        fn : function() 
                                                                        {
                                                                           
                                                                        }
                                                                    }
                                                        },
                                                buttons:	[
                                                                btnSiguiente,
                                                                {
                                                                    text: 'Cancelar',
                                                                    handler:function()
                                                                    {
                                                                    	
                                                                        ventanaPregCerradas.close();
                                                                    }
                                                                }
                                                            ]
                                            }
                                        );
	
    llenarOpcionesDictamenRevisores(ventanaPregCerradas,idGrupoElemento);

}

function llenarOpcionesDictamenRevisores(ventana,idGrupoElemento)
{
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var arrDatos=eval(arrResp[1]);
            Ext.getCmp('gridOpcionesManualesDR').getStore().loadData(arrDatos);
            ventana.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=72&idGrupoElemento='+idGrupoElemento,true);
}

function validarOpciones(dSet,tblEditor)
{
	var res=validarCampoNoVacio(tblOpciones.getStore(),'valorOpt');
	if(res!='-1')
	{
		function funcClickOk()
		{
			tblOpciones.startEditing(res-1,1);
			return false
		}
		Ext.MessageBox.alert('<?php echo $etj["lblAplicacion"]?>','El contenido de esta celda no puede estar vac&iacute;a',funcClickOk);
	}
	else
	{
		var cm=tblEditor.getColumnModel();
		var idIdioma=gE('hLeng').value;
		var nomColumn='idioma_'+idIdioma;
		var posCol=cm.findColumnIndex(nomColumn);
		var x;
		var res=validarCampoNoVacio(dSet,nomColumn);
		if(res!='-1')
		{
			function funcClickOk()
			{
				tblEditor.startEditing(res-1,posCol);
				return false;
			}
			Ext.MessageBox.alert('<?php echo $etj["lblAplicacion"]?>','El texto a mostrar como opci&oacute;n debe ser ingresado, al menos en su idioma',funcClickOk);	
			
		}
		else
		{
			var colName='';
            var numColums=cm.getColumnCount()-1;
           
            for(x=2;x<numColums;x++)
            {
                colName=cm.getDataIndex(x);
                if(colName!=nomColumn)
                {
                    res=validarCampoNoVacio(dSet,colName);
                    if(res!='-1')
                    {
                        function funcConfirmacion(btn)
                        {
                            if(btn=='yes')
                            {
                                for(x=2;x<cm.getColumnCount();x++)
                                {
                                    colName=cm.getDataIndex(x);
                                    if(colName!=nomColumn)
                                        rellenarValoresVaciosColumna(dSet,colName,nomColumn);
                                }
                                //Ext.getCmp('btnFinalizarPCerradas').fireEvent('click');
                            }
                            return false;
                        }
                        Ext.MessageBox.confirm('<?php echo $etj["lblAplicacion"] ?>', 'El texto a mostrar como opci&oacute;n no ha sido especificado en todos lo idiomas, desea continuar', funcConfirmacion);
                    }
                    else
                        return true;
                }
            }
            return true;
        	
		}
	}
    
    
}

function obtenerValoresOpcionesManuales()
{
	var opciones='';
    var cadTemp='';
    
    var tblOpciones=Ext.getCmp('gridOpcionesManuales');
    var cm=tblOpciones.getColumnModel();
    var ct=tblOpciones.getStore().getCount();
    var reg;
    var x;
    
    for(x=0;x<ct;x++)
    {
    	

        reg=tblOpciones.getStore().getAt(x);

        var valColumnas=obtenerValoresColumnasRegistro(cm,reg);
        cadTemp='{"vOpcion":"'+cv(reg.get('valorOpt'))+'",'+
                '"columnas":['+valColumnas+'],'+
                '"etapa":"'+reg.get('numEtapa')+'","icono":"'+cv(reg.data.icono)+'"}';
        if(opciones=='')
            opciones=cadTemp;
        else
            opciones+=','+cadTemp;
    }

    return '['+opciones+']';
}

function obtenerValoresOpcionesManualesDR()
{
	var opciones='';
    var cadTemp='';
    
    var tblOpciones=Ext.getCmp('gridOpcionesManualesDR');
    var cm=tblOpciones.getColumnModel();
    var ct=tblOpciones.getStore().getCount();
    var reg;
    var x;
    
    for(x=0;x<ct;x++)
    {
        reg=tblOpciones.getStore().getAt(x);
        var valColumnas=obtenerValoresColumnasRegistroGR(cm,reg);
        cadTemp='{"vOpcion":"'+cv(reg.get('valorOpt'))+'",'+
                '"columnas":['+valColumnas+']}';
        if(opciones=='')
            opciones=cadTemp;
        else
            opciones+=','+cadTemp;
    }
    return '['+opciones+']';
}

function obtenerValoresOpcionesManualesDP()
{
	var opciones='';
    var cadTemp='';
    
    var tblOpciones=Ext.getCmp('gridOpcionesManuales');
    var cm=tblOpciones.getColumnModel();
    var ct=tblOpciones.getStore().getCount();
    var reg;
    var x;
    
    for(x=0;x<ct;x++)
    {
        reg=tblOpciones.getStore().getAt(x);
        var valColumnas=obtenerValoresColumnasRegistro(cm,reg);
        cadTemp='{"vOpcion":"'+cv(reg.get('valorOpt'))+'",'+
                '"columnas":['+valColumnas+'],'+
                '"accion":"'+reg.get('accion')+'",'+
                '"reqRespuesta":"'+reg.get('reqRespuesta')+'"'+
                '}';
        if(opciones=='')
            opciones=cadTemp;
        else
            opciones+=','+cadTemp;
    }
    return '['+opciones+']';
}

function obtenerValoresColumnasRegistro(cm,reg)
{
	var columnas='';
	var idLeng='';
	var tColum='';
	var x;
    var nColDes=1;
//    if(cm.getColumnCount()-nColDes-2==0)
  //  	nColDes=1;
	for(x=3;x<cm.getColumnCount()-nColDes;x++)
	{

		tColumn=cm.getDataIndex(x);
		idLeng=cm.getDataIndex(x).split('_')[1];
		if(columnas=='')
			columnas='{"idLeng":"'+idLeng+'","texto":"'+cv(reg.get(tColumn))+'"}';
		else
			columnas+=',{"idLeng":"'+idLeng+'","texto":"'+cv(reg.get(tColumn))+'"}';
	}
	return columnas;
}

function obtenerValoresColumnasRegistroGR(cm,reg)
{
	var columnas='';
	var idLeng='';
	var tColum='';
	var x;
    
	for(x=2;x<cm.getColumnCount();x++)
	{
		tColumn=cm.getDataIndex(x);
		idLeng=cm.getDataIndex(x).split('_')[1];
		if(columnas=='')
			columnas='{"idLeng":"'+idLeng+'","texto":"'+cv(reg.get(tColumn))+'"}';
		else
			columnas+=',{"idLeng":"'+idLeng+'","texto":"'+cv(reg.get(tColumn))+'"}';
	}
	return columnas;
}


function verFormulario(idFormulario)
{
	var obj={};
    obj.url='../modeloPerfiles/formularios.php';
    obj.params=[['redireccionarFormulario',1],['idFormulario',idFormulario],['cPagina','sFrm=true'],['accionCancelar',bE('window.parent.cerrarVentanaFancy()')]];
    obj.ancho='100%';
    obj.alto='100%';

   window.parent.abrirVentanaFancy(obj);
}

function agregarActorProceso(iP)
{
	var idProceso=iP;
	var arrActores=[];
	var gridActores=crearGridActores();
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Seleccione los actores a agregar:'
                                                        },
                                                        gridActores
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Agregar actores',
										width: 530,
										height:400,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var filas=gridActores.getSelectionModel().getSelections();
                                                                        if(filas.length==0)
                                                                        {
                                                                        	msgBox('Debe seleccionar al menos un actor para agregar al inicio del proceso');
                                                                        	return;
                                                                        }
                                                                        
                                                                        var x;
                                                                       
                                                                        var idProceso=gE('idProceso').value;
                                                                        var id;
                                                                        var tipo;
                                                                        var cadActores='';
                                                                        for(x=0;x<filas.length;x++)
                                                                        {
                                                                        	id=filas[x].get('idActor');
                                                                            tipo=filas[x].get('tipo');
                                                                            
                                                                            if(cadActores=='')
                                                                            	cadActores=id;
                                                                            else
                                                                            	cadActores+=','+id;
                                                                        }
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	ventanaAM.close();
                                                                                recargarTabEscenario();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=56&idProceso='+idProceso+'&cadActores='+cadActores,true);
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();                                
	obtenerActoresDisponiblesProceso(idProceso,ventanaAM,gridActores.getStore());
}

function obtenerActoresDisponiblesProceso(idProceso,ventana,almacen)
{
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var datos=eval(arrResp[1]);
            almacen.loadData(datos);
        	ventana.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=55&idProceso='+idProceso,true);	
}

function removerActorInicio(idA)
{
	function respRemover(btn)
    {
       
        if(btn=='yes')
        {
            
            function funcAjax()
            {
                var resp=peticion_http.responseText;
                arrResp=resp.split('|');
                if(arrResp[0]=='1')
                {
                    var fila=gE('filaActorInicio_'+idA);
                    fila.parentNode.removeChild(fila);
                }
                else
                {
                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                }
            }
            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=57&idActor='+idA,true);
        }
    }
   	msgConfirmWin('Est&aacute; seguro de querer remover a este actor?',respRemover,330,120);
}

function agregarAccionInicio(actor)
{
	var idProceso=gE('idProceso').value;
	var arrActores=[];
	var gridAcciones=crearGridAcciones();
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Seleccione las acciones a agregar:'
                                                        },
                                                        gridAcciones
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Agregar acci&oacute;n',
										width: 550,
										height:400,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var filas=gridAcciones.getSelectionModel().getSelections();
                                                                        if(filas.length==0)
                                                                        {
                                                                        	msgBox('Debe seleccionar al menos una acción para agregar al actor');
                                                                        	return;
                                                                        }
                                                                        var x;
                                                                        var cadAcciones='';
                                                                        var idGrupoAccion;
                                                                        for(x=0;x<filas.length;x++)
                                                                        {
                                                                        	idGrupoAccion=filas[x].get('idGrupoAccion');
                                                                            
                                                                            if(cadAcciones=='')
                                                                            	cadAcciones=idGrupoAccion;
                                                                            else
                                                                            	cadAcciones+=','+idGrupoAccion;
                                                                        }
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	ventanaAM.close();
                                                                                recargarTabEscenario();
                                                                            }
                                                                            else
                                                                            {

                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=59&cadAcciones='+cadAcciones+'&actor='+actor+'&idProceso='+idProceso,true);
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	
	obtenerAccionesActoresDisponiblesInicio(actor,ventanaAM,gridAcciones.getStore());
}

function obtenerAccionesActoresDisponiblesInicio(actor,ventanaAM,almacen)
{
	var idProceso=gE('idProceso').value;
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var datos=eval(arrResp[1]);
            almacen.loadData(datos);
        	ventanaAM.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=58&actor='+actor+'&idProceso='+idProceso,true);
}

function removerAccionInicio(idAccion)
{
	function resp(btn)
    {
		if(btn=='yes')
        {
            function funcAjax()
            {
                var resp=peticion_http.responseText;
                arrResp=resp.split('|');
                if(arrResp[0]=='1')
                {
                    var fila=gE('filaAccionInicio_'+idAccion);
                    fila.parentNode.removeChild(fila);
                }
                else
                {
                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                }
            }
            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=60&idAccion='+idAccion,true);
		}
	}
    msgConfirmWin('Est&aacute; seguro de querer remover esta acci&oacute;n?',resp,330,120);       
}

function configurarVerRegistros(idAc,vReg,tAccion)
{
	var arrVerRegistros=<?php echo $arrOpciones?>;
    
    var cmbVerRegistros=crearComboExt('cmbVerRegistros',arrVerRegistros,90,15);
    cmbVerRegistros.setWidth(350);
    if(vReg !=undefined)
    	cmbVerRegistros.setValue(vReg);
    
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:20,
                                                            html:'Seleccione:'
                                                        },
                                                        cmbVerRegistros

													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Selecci&oacute;n de registros que ver&aacute; el actor',
										width: 520,
										height:150,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var verRegistro=cmbVerRegistros.getValue();
                                                                        if(verRegistro=='')
                                                                        {
                                                                        	msgBox('Debe Seleccionar el tipo de registros que ver&aacute; el actor');
                                                                        	return;
                                                                        }
                                                                        ;
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	var spanDestino=gE('tblVer_'+idAc);
                                                                                if(spanDestino==null)
                                                                                	spanDestino=gE('tblEtapas_'+idAc);
                                                                                var vRegistros= cmbVerRegistros.getRawValue();
                                                                                var cadSpan="<span class='letraAzulSubrayada7'> ("+vRegistros+") </span>&nbsp;&nbsp;<a href='javascript:configurarVerRegistros("+idAc+","+verRegistro+")'><img src='../images/pencil.png' title='Cambiar tipo de registros visto por actor' alt='Cambiar tipo de registros visto por actor'></a>";
                                                                                spanDestino.innerHTML=cadSpan;
                                                                            	ventanaAM.close();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=61&tAccion='+tAccion+'&idAccion='+idAc+'&verRegistro='+verRegistro,true);
                                                                        
                                                                        
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();                                
}

function condicionadoCambio(cmb,idAc,et)
{
	if(cmb.options[cmb.selectedIndex].value=='0')
    {
    	function resp(btn)
        {
        	if(btn=='yes')
            {
                function funcAjax()
                {
                    var resp=peticion_http.responseText;
                    arrResp=resp.split('|');
                    if(arrResp[0]=='1')
                    {
                        var fila=gE('filaTexto_'+idAc);
                        if(fila!=null)
	                        fila.parentNode.removeChild(fila);
                       
                        fila=gE('filaTablaDictamen_'+idAc);
	                  	if(fila!=null)
                        	fila.parentNode.removeChild(fila);
                    }
                    else
                    {
                        msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                    }
                }
                obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=62&idAccion='+idAc,true);
           }
           else
           	{
            	cmb.selectedIndex=1;
            }
        }
        msgConfirmWin('Est&aacute; seguro de querer remover las dependencias de dictamen?',resp);
    }
    else
    {
    	var gridActores=crearGridActores();
    	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Seleccione los actores de los cuales depender&aacute; la realizaci&oacute;n del dictamen final: '
                                                        },
                                                        gridActores
                                                        

													]
										}
									);
	
        var ventanaAM = new Ext.Window(
                                        {
                                            title: 'Configuraci&oacute;n dictamen final',
                                            width: 500,
                                            height:450,
                                            layout: 'fit',
                                            plain:true,
                                            modal:true,
                                            bodyStyle:'padding:5px;',
                                            buttonAlign:'center',
                                            items: form,
                                            listeners : {
                                                        show : {
                                                                    buffer : 10,
                                                                    fn : function() 
                                                                    {
                                                                    }
                                                                }
                                                    },
                                            buttons:	[
                                                            {
                                                                id:'btnAceptar',
                                                                text: '<?php echo $etj["lblBtnAceptar"]?>',
                                                                handler: function()
                                                                        {
                                                                            var filas=gridActores.getSelectionModel().getSelections();
                                                                            var x;
                                                                            
                                                                            if(filas.length==0)
                                                                            {
                                                                            	msgBox('Debe seleccionar al menos un actor que condicionar&aacute; el proceso de dictamen final')
                                                                                return;
                                                                            }
                                                                            var arrActores='';
                                                                            for(x=0;x<filas.length;x++)
                                                                            {
                                                                            	if(arrActores=='')
                                                                                	arrActores=filas[x].get('idActor');
                                                                                else
                                                                                	arrActores+=','+filas[x].get('idActor');
                                                                            }
                                                                            
                                                                            
                                                                            function funcAjax()
                                                                            {
                                                                                var resp=peticion_http.responseText;
                                                                                arrResp=resp.split('|');
                                                                                if(arrResp[0]=='1')
                                                                                {
                                                                                	ventanaAM.close();
                                                                                	recargarTabEscenario();
                                                                                    
                                                                                }
                                                                                else
                                                                                {
                                                                                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                }
                                                                            }
                                                                            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=64&actores='+arrActores+'&idAccion='+idAc,true);
                                                                            
                                                                            
                                                                            
                                                                        }
                                                            },
                                                            {
                                                                text: '<?php echo $etj["lblBtnCancelar"]?>',
                                                                handler:function()
                                                                        {
                                                                        	selElemCombo(cmb,'0');
                                                                            ventanaAM.close();
                                                                        }
                                                            }
                                                        ]
                                        }
                                    );
                                    
		llenarDatosGridActores(ventanaAM,gridActores.getStore(),idAc,et);                                   
        
    
    
    }
}

function crearGridActores()
{
	dsDatos=[];
    alDatos=	new Ext.data.SimpleStore	(
                                                {
                                                    fields:	[
                                                                {name: 'idActor'},
                                                                {name: 'actor'},
                                                                {name: 'tipo'}
                                                            ]
                                                }
                                            );

    alDatos.loadData(dsDatos);
	chkRow=new Ext.grid.CheckboxSelectionModel();
	
	var cModelo= new Ext.grid.ColumnModel   	(
												 	[
													 	new  Ext.grid.RowNumberer(),
														chkRow,
														{
															header:'Actor',
															width:150,
															sortable:true,
															dataIndex:'actor'
														},
														{
															header:'Tipo',
															width:200,
															sortable:true,
															dataIndex:'tipo',
                                                            renderer:renderTipoUsuario
														}
													]
												);
                                                
	var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            
                                                            store:alDatos,
                                                            frame:true,
                                                            x:10,
                                                            y:40,
                                                            cm: cModelo,
                                                            height:260,
                                                            width:450,
                                                            sm:chkRow
                                                        }
                                                    );
	return 	tblGrid;		
}

function llenarDatosGridActores(ventana,almacen,idActor,et)
{
	var idProceso=gE('idProceso').value;
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var arrDatos=eval(arrResp[1]);
            almacen.loadData(arrDatos);
        	ventana.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=63&idActor='+idActor+'&numEtapa='+et+'&idProceso='+idProceso,true);
}

function removerDependencia(idAccion,idAccionD)
{
	function resp(btn)
    {
    	if(btn=='yes')
        {
            function funcAjax()
            {
                var resp=peticion_http.responseText;
                arrResp=resp.split('|');
                if(arrResp[0]=='1')
                {
                    recargarTabEscenario();
                }
                else
                {
                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                }
            }
            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=65&idAccion='+idAccion+'&idAccionR='+idAccionD,true);
		}
    }
    msgConfirmWin('Est&aacute; seguro de querer remover este actor como condici&oacute;n de dictamen final?',resp);            
}

function agregarDependenciaDictamen(idAc,et)
{
	var cmbDependencia=gE('cmbCondicionado_'+idAc);
    condicionadoCambio(cmbDependencia,idAc,et);
    
}

function asociarAutomaticamente(ctrl)
{
	var valor=ctrl.options[ctrl.selectedIndex].value;
    var idActor=ctrl.id.split('_')[1];
    function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
            if(ctrl.selectedIndex==1)
            	ctrl.selectedIndex=0;
            else
            	ctrl.selectedIndex=1;   
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=187&valor='+valor+'&idActor='+idActor,true);
    
}

function configurarDisparador(iP,e)
{
	var obj={};
    obj.ancho='100%';
    obj.alto='100%';
    obj.url='../modeloPerfiles/configurarDisparadores.php';
    obj.params=[['idProceso',iP],['numEtapa',e],['cPagina','sFrm=true']];
        
	window.parent.abrirVentanaFancy(obj);
}

function configurarEvaluacion(idAccion,et)
{
	var arrEtapas=[];
    var cmbPasaEtapa=crearComboExt('cmbPasaEtapa',arrEtapas);
    var dsOpciones= [];
    alOpciones=		new Ext.data.SimpleStore(
                                                {
                                                    fields:	[
                                                                <?php 
                                                                    echo $campos;
                                                                ?>
                                                            ]
                                                }
                                            );
    
    alOpciones.loadData(dsOpciones);
    var cmFrmDTD= new Ext.grid.ColumnModel   	(
                                                    [
                                                        new  Ext.grid.RowNumberer(),
                                                        {
                                                            header:'Clave',
                                                            width:100,
                                                            dataIndex:'valorOpt',
                                                            editor: new Ext.form.TextField   (
                                                                                                    {
                                                                                                      
                                                                                                       style: 'text-align:left'
                                                                                                    }
                                                                                                )
                                                        }
                                                        ,
                                                        <?php 
                                                            echo $columnas;
                                                        ?>
                                                    ]
                                                );
    
    
    
    tblOpciones=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gridOpcionesManuales',
                                                            store:alOpciones,
                                                            frame:true,
                                                            clicksToEdit: 1,
                                                            cm: cmFrmDTD,
                                                            height:300,
                                                            columnLines:true,
                                                            width:<?php echo $ancho+35 ?>,
                                                            title:'Ingrese los posibles valores de dict&aacute;men:',
                                                            tbar: [
                                                                    {
                                                                        text: 'Agregar opci&oacute;n',
                                                                        icon:'../images/add.png',
                                                                        handler : function()
                                                                                  {
                                                                                        var r=new RegistroOpciones	(
                                                                                                                        {
                                                                                                                            <?php echo $camposOpciones?>
                                                                                                                        }
                                                                                                                    ) 	
                                                                                        alOpciones.add(r);	
                                                                                        tblOpciones.startEditing(alOpciones.getCount()-1,1);
                                                                                  }
                                                                    }
                                                                    ,
                                                                    {
                                                                        text:'Eliminar Opci&oacute;n',
                                                                        icon:'../images/cancel_round.png',
                                                                        handler:function()
                                                                                {
                                                                                    var fila=tblOpciones.getSelectionModel().getSelectedCell();
                                                                                    if(fila!=null)
                                                                                    {
                                                                                        var posFila=alOpciones.getAt(fila[0]);
                                                                                        function funcConfirmDel(btn)
                                                                                        {
                                                                                        	
                                                                                            if(btn=="yes")
                                                                                            {
                                                                                                alOpciones.remove(posFila);
                                                                                            }
                                                                                        }
                                                                                       msgConfirmWin('Est&aacute; seguro de querer eliminar esta opci&oacute;n?',funcConfirmDel);
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        msgBox('Debe seleccionar la opci&oacute;n a remover');
                                                                                    }
                                                                                    
                                                                                }  
                                                                    }
                                                                    
                                                                  ]
                                                        }
                                                    );
    
    function funcEdicion(e)
    {
        if(e.field=='valorOpt')
        {
            var res=obtenerPosFila(e.grid.getStore(),'valorOpt',e.value);
            if((res!='-1')&&(e.row!=res))
            {
                function funcOK()
                {
                    e.record.set('valorOpt',e.originalValue);
                    e.grid.getView().refresh();
                    e.grid.startEditing(e.row,e.column);
                }
                Ext.MessageBox.alert('<?php echo $etj["lblAplicacion"]?>','La opci&oacute;n ingresada ya se encuentra registrada',funcOK);
            }
        }
    }
    tblOpciones.on('afteredit',funcEdicion);
    
    panelGrid=new Ext.Panel	(
                                {
                                    y:10,
                                    items:	[
                                                tblOpciones
                                            ]
                                }
                            );
                            
   
    var form = new Ext.form.FormPanel(	
                                        {
                                            baseCls: 'x-plain',
                                            layout:'absolute',
                                            defaultType: 'textfield',
                                            items: 	[
                                                        panelGrid
                                                        
                                                    ]
                                        }
                                    );
    
    

    
    
    
    btnSiguiente=new Ext.Button	(
                                    {
                                        text: 'Aceptar',
                                        minWidth:80,
                                        id:'btnAceptar',
                                        listeners:	{
                                                        click:
                                                                {
                                                                    fn:function()
                                                                    {
                                                                        var resul=validarOpciones(tblOpciones.getStore(),tblOpciones);
                                                                            
                                                                        if(resul)
                                                                        {
                                                                            var opciones=obtenerValoresOpcionesManuales();
                                                                            function funcAjax()
                                                                            {
                                                                                var resp=peticion_http.responseText;
                                                                                arrResp=resp.split('|');
                                                                                if(arrResp[0]=='1')
                                                                                {
                                                                                	ventanaPregCerradas.close();
                                                                                    recargarTabEscenario();
                                                                                }
                                                                                else
                                                                                {
                                                                                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                }
                                                                            }
                                                                            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=330&objOpciones={"opciones":'+opciones+'}&idAccion='+idAccion,true);
                                                                        }
                                                                    }
                                                                }
                                                    }
                                    }
                                )
    
    var ventanaPregCerradas = new Ext.Window(
                                            {
                                                title: 'Opciones de evaluaci&oacute;n',
                                                width: <?php echo ($ancho+65) ?> ,
                                                height:470,
                                                minWidth: 300,
                                                minHeight: 100,
                                                layout: 'fit',
                                                plain:true,
                                                modal:true,
                                                bodyStyle:'padding:5px;',
                                                buttonAlign:'center',
                                                items: 	[
                                                            form
                                                        ],
                                                listeners : {
                                                            show : {
                                                                        buffer : 10,
                                                                        fn : function() 
                                                                        {
                                                                           
                                                                        }
                                                                    }
                                                        },
                                                buttons:	[
                                                                btnSiguiente,
                                                                {
                                                                    text: 'Cancelar',
                                                                    handler:function()
                                                                    {
                                                                    	
                                                                        ventanaPregCerradas.close();
                                                                    }
                                                                }
                                                            ]
                                            }
                                        );
	
	
	obtenerEtapasDisponiblesEvaluacion(et,ventanaPregCerradas,cmbPasaEtapa.getStore(),true,idAccion);
    
}


function obtenerEtapasDisponiblesEvaluacion(et,ventana,almacen,ninguna,idAccion)
{
	var idProceso=gE('idProceso').value;
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var arrEt=eval(arrResp[1]);
            if(ninguna!=undefined)
            	arrEt.push(['0','Ninguna']);
            almacen.loadData(arrEt);
            llenarOpcionesEvaluacionSolicitud(idAccion,ventana);
            
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=51&idProceso='+idProceso+'&numEtapa='+et,true);
}

function llenarOpcionesEvaluacionSolicitud(idAccion,ventana)
{
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var arrParam=eval(arrResp[1]);
            Ext.getCmp('gridOpcionesManuales').getStore().loadData(arrParam);
        	ventana.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=230&idAccion='+idAccion,true);	
}

function cambiarAmbitoResp(ctrl,a,tO)
{
	var valor=ctrl.options[ctrl.selectedIndex].value;
    function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=231&idAccion='+a+'&tipoOpcion='+tO+'&valor='+valor,true);
}

function configurarTiempoPresupuestal(iA,tP)
{
	var arrTiempos=<?php echo $arrTiempos?>;
	var cmbTiempos=crearComboExt('cmbTiempos',arrTiempos,140,35);
    cmbTiempos.setWidth(300);
    if(tP !=undefined)
    	cmbTiempos.setValue(tP);
    
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Seleccione el tiempo presupuestal que se asignar&aacute; al presupuesto autorizado'
                                                        },
                                                        {
                                                        	x:10,
                                                            y:40,
                                                            html:'Tiempo presupuestal:'
                                                        },
                                                        cmbTiempos

													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Selecci&oacute;n de tiempo presupuestal',
										width: 470,
										height:160,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var tiempo=cmbTiempos.getValue();
                                                                        if(tiempo=='')
                                                                        {
                                                                        	msgBox('Debe seleccionar el tiempo presupuestal que se asignar&aacute; al presupuesto autorizado');
                                                                        	return;
                                                                        }
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	var spanDestino=gE('tblEtapas_'+iA);
                                                                                var etapaPasa= cmbTiempos.getRawValue();
                                                                                var cadSpan;
                                                                                cadSpan="<span class='corpo8'><font color='#000055'><b>Tiempo presupuestal: </b></font><br><font color='green'><b> "+etapaPasa+"</b></font></span>&nbsp;&nbsp;<a href='javascript:configurarTiempoPresupuestal("+iA+","+tiempo+")'><img src='../images/pencil.png' title='Modificar el tiempo presupuestal que tomar&aacute;n las partidas al ser autorizadas' alt='Modificar el tiempo presupuestal que tomar&aacute;n las partidas al ser autorizadas'></a>";
                                                                                spanDestino.innerHTML=cadSpan;
                                                                            	ventanaAM.close();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=52&idAccion='+iA+'&numEtapa='+tiempo,true);
                                                                        
                                                                        
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);	
	ventanaAM.show();                                
}

function removerUnidad(iU)
{
	function resp(btn)
    {
    	if(btn=='yes')
        {
        	function funcAjax()
            {
                var resp=peticion_http.responseText;
                arrResp=resp.split('|');
                if(arrResp[0]=='1')
                {
                    var fila=gE('filaAmbito_'+bD(iU));

                    fila.parentNode.removeChild(fila);
                }
                else
                {
                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                }
            }
            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=246&iU='+bD(iU),true);
        }
    }
    msgConfirm('Est&aacute; seguro de querer remover la Instituci&oacute;n/departamento seleccionada(o)?',resp)
}

function agregarUnidad(iA)
{

	var oConf=	{
    					idCombo:'cmbDepartamento',
                        posX:150,
                        posY:35,
                        anchoCombo:350,
                        campoDesplegar:'unidad',
                        campoID:'codigoUnidad',
                        campoHDestino:'hUnidad',
                        funcionBusqueda:248,
                        paginaProcesamiento:'../paginasFunciones/funcionesProyectos.php',
                        confVista:'<tpl for="."><div class="search-item"><b>{unidad}</b> <br><span class="letraRojaSubrayada8">Instituci&oacute;n:</span> {institucion}</div></tpl>',
                        campos:	[
                                    {name:'codigoUnidad'},
                                    {name:'unidad'},
                                    {name:'institucion'}
                                ],
                       	funcAntesCarga:function(dSet,combo)
                    				{
                                    	
                                    	gE('hUnidad').value='-1';
                                    	var aValor=combo.getRawValue();
										dSet.baseParams.criterio=aValor;
                                        
                                    },
                      	funcElementoSel:function(combo,registro)
                    				{
                                    	gE('hUnidad').value=registro.get('codigoUnidad');
                                    	
                                    }  
    				};
	var cmbDepartamento=crearComboExtAutocompletar(oConf);

	var cmbAmbito=crearComboExt('cmbAmbito',arrAmbito,80,65,300);
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
                                            			{
                                                        	x:10,
                                                            y:5,
                                                            xtype:'radio',
                                                            id:'rdo_1',
                                                            name:'rdoUnidad',
                                                            boxLabel:'Instituci&oacute;n a la que pertenece:',
                                                            listeners:	{
                                                            				'check':validarRadio
                                                            			}
                                                        },
                                                        {
                                                        	x:200,
                                                            y:5,
                                                            id:'rdo_2',
                                                            xtype:'radio',
                                                            name:'rdoUnidad',
                                                            boxLabel:'Departamento al que pertenece:',
                                                            listeners:	{
                                                            				'check':validarRadio
                                                            			}
                                                        },
                                                        {
                                                        	x:390,
                                                            y:5,
                                                            id:'rdo_3',
                                                            xtype:'radio',
                                                            checked:true,
                                                            name:'rdoUnidad',
                                                            boxLabel:'Otra instituci&oacute;n/departamento:',
                                                            listeners:	{
                                                            				'check':validarRadio
                                                            			}
                                                        },
														{
                                                        	x:10,
                                                            y:40,
                                                            html:'Instituci&oacute;n/departamento:'
                                                        },
                                                        cmbDepartamento,
                                                        {
                                                        	x:10,
                                                            y:70,
                                                            html:'&Aacute;mbito:'
                                                        },
                                                        cmbAmbito

													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Agregar Instituci&oacute;n/departamento',
										width: 650,
										height:190,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
                                                                	cmbDepartamento.focus(false,500);
																}
															}
												},
										buttons:	[
														{
															
															text: '<?php echo $etj["lblBtnAceptar"]?>',
                                                            
															handler: function()
																	{
																		var hUnidad=gE('hUnidad');
                                                                        if(gEx('rdo_3').getValue())
                                                                        {
                                                                          
                                                                            if(hUnidad.value=='-1')
                                                                            {
                                                                                function resp1()
                                                                                {
                                                                                    cmbDepartamento.focus();
                                                                                }
                                                                                msgBox('Debe indicar la Instituci&oacute;n/departamento que desea agregar',resp1);
                                                                                return;
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                        	if(gEx('rdo_2').getValue())
                                                                            {
                                                                            	gE('hUnidad').value='-2';
                                                                            }
                                                                            else
                                                                            {
                                                                            	gE('hUnidad').value='-1';
                                                                            }
                                                                        }
                                                                        if(cmbAmbito.getValue()=='')
                                                                          {
                                                                              function resp2()
                                                                              {
                                                                                  cmbAmbito.focus();
                                                                              }
                                                                              msgBox('Debe indicar el &aacute;mbito de Instituci&oacute;n/departamento que desea agregar',resp2);
                                                                              return;
                                                                           }
                                                                        
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                                var tblUnidades=gE('tblUnidades_'+bD(iA));
                                                                                var fila=tblUnidades.insertRow(tblUnidades.rows.length);
                                                                                fila.setAttribute('id','filaAmbito_'+arrResp[1]);
                                                                                var celda1=fila.insertCell(0);
                                                                                celda1.setAttribute('class','fondoGrid7');
                                                                                var unidad='';
                                                                                if(gE('hUnidad').value=='-1')
                                                                                	unidad='Instituci&oacute;n a la que pertenece';
                                                                                else
                                                                                    if(gE('hUnidad').value=='-2')
                                                                                        unidad='Departamento al que pertenece';
                                                                                    else
                                                                                		unidad=cmbDepartamento.getRawValue();
                                                                                celda1.innerHTML="<a href='javascript:removerUnidad(\""+bE(arrResp[1])+"\")'><img alt='Remover Institución/departamento' title='Remover Institución/departamento' src='../images/delete.png'></a> "+unidad;
                                                                                var celda2=fila.insertCell(1);
                                                                                celda2.setAttribute('class','fondoGrid7'); 
                                                                                celda2.innerHTML=cmbAmbito.getRawValue();
                                                                                ventanaAM.close();
                                                                            }
                                                                            
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=247&codigoUnidad='+hUnidad.value+'&ambito='+cmbAmbito.getValue()+'&idAccion='+bD(iA),true);
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();		
}

function validarRadio(chk,checked)
{
	if(!checked)
    	return;
	var arrId=chk.id.split('_');
	var cmbDepartamento=gEx('cmbDepartamento');

	switch(arrId[1])
    {
    	case '1':
        case '2':
            gE('hUnidad').value=-1;
            cmbDepartamento.reset();
			cmbDepartamento.disable();        
            
        break;
        case '3':
        	cmbDepartamento.enable();
        break;
    }
}

function recargarTabEscenario()
{
	recargarPagina();
}

function configurarModuloFirmaCertificacion(iA,e,cConf)
{

	var cmbVisualizarBoton=crearComboExt('cmbVisualizarBoton',arrSiNo,200,125,130);
    cmbVisualizarBoton.setValue('1');
	var cmbAccionCertificado=crearComboExt('cmbAccionCertificado',arrAccionesConsecuentes,350,35,300);
    cmbAccionCertificado.setValue('0');
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Etiqueta: '
                                                        },
                                                        {
                                                        	x:130,
                                                            y:5,
                                                            width:350,
                                                            xtype:'textfield',
                                                        	id:'txtEtiqueta'
                                                        },
                                                        {
                                                        	x:10,
                                                            y:40,
                                                            html:'Acción a ejecutar una vez firmado/certificado el proceso:'
                                                        },
                                                        cmbAccionCertificado,
                                                        {
                                                        	x:10,
                                                            y:70,
                                                            html:'Funci&oacute;n de  firma/certificaci&oacute;n:'
                                                        },
                                                        {
                                                        	x:200,
                                                            y:65,
                                                            width:250,
                                                            xtype:'textfield',
                                                        	id:'txtFuncionCertificacion'
                                                        },
                                                        {
                                                        	x:10,
                                                            y:100,
                                                            html:'URL m&oacute;dulo certificaci&oacute;n:'
                                                        },
                                                        {
                                                        	x:200,
                                                            y:95,
                                                            width:460,
                                                            xtype:'textfield',
                                                        	id:'txtURLModulo'
                                                        },
                                                        {
                                                        	x:10,
                                                            y:130,
                                                            html:'Visualizar bot&oacute;n de firma:'
                                                        },
                                                        cmbVisualizarBoton,
                                                        {
                                                        	xtype:'fieldset',
                                                            title:'Configuraci&oacute;n de acciones:',
                                                            width:830,
                                                            x:10,
                                                            y:150,
                                                            height:220,
                                                            layout:'absolute',
                                                            items:	[
                                                            			crearGridAccionFirma()
                                                            		]
                                                        }

													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Configurar m&oacute;dulo de certificaci&oacute;n firma',
										width: 880,
										height:450,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
                                                                	gEx('txtEtiqueta').focus(false,500);
																}
															}
												},
										buttons:	[
														{
															
															text: '<?php echo $etj["lblBtnAceptar"]?>',                                                            
															handler: function()
																	{
																		var txtEtiqueta=gEx('txtEtiqueta');
                                                                        if(txtEtiqueta.getValue()=='')
                                                                        {
                                                                        	function resp()
                                                                            {
                                                                            	txtEtiqueta.fcus();
                                                                            }
                                                                            msgBox('Debe ingresar la etiqueta del m&oacute;dulo',resp);
                                                                            return;
                                                                        }
                                                                        
                                                                        var txtFuncionCertificacion=gEx('txtFuncionCertificacion');
                                                                        if(txtFuncionCertificacion.getValue()=='')
                                                                        {
                                                                        	function resp2()
                                                                            {
                                                                            	txtFuncionCertificacion.fcus();
                                                                            }
                                                                            msgBox('Debe ingresar la funci&oacute;n del m&oacute;dulo de firma/certificaci&oacute;n',resp2);
                                                                            return;
                                                                        }
                                                                        var arrAcciones='';
                                                                        var fila;
                                                                        var x=0;
                                                                        var oAccion='';
                                                                        var gAccionesFirma=gEx('gAccionesFirma');
                                                                        for(x=0;x<gAccionesFirma.getStore().getCount();x++)
                                                                        {
                                                                        	
                                                                        	fila=gAccionesFirma.getStore().getAt(x);
                                                                            
                                                                            if(fila.data.etiquetaAccion=='')
                                                                            	fila.data.etiquetaAccion=formatearValorRenderer(arrAccionesFirma,fila[0]);
                                                                            
                                                                            oAccion='{"idAccion":"'+fila.data.accion+'","etiquetaAccion":"'+cv(fila.data.etiquetaAccion)+
                                                                            			'","etapaEnvio":"'+fila.data.etapaCambio+'","documentoFinal":"'+fila.data.documentoFinal+'"}';
                                                                            if(arrAcciones=='')
                                                                            	arrAcciones=oAccion;
                                                                            else
                                                                            	arrAcciones+=','+oAccion;    
                                                                        }
                                                                        
                                                                        var cadObj='{"visualizarBoton":"'+cmbVisualizarBoton.getValue()+'","etiqueta":"'+cv(txtEtiqueta.getValue())+'","accionEjecucion":"'+cmbAccionCertificado.getValue()+
                                                                        			'","funcionModuloFirma":"'+txtFuncionCertificacion.getValue()+'","urlModuloCertificacion":"'+gEx('txtURLModulo').getValue()+
                                                                                    '","arrAcciones":['+arrAcciones+']}';
                                                                       
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	
                                                                            	ventanaAM.close();
                                                                                recargarPagina();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=52&idAccion='+iA+'&numEtapa=NULL&objComp='+(cadObj),true);
                                                                        
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();	
    
    if(cConf)
    {
    	var cadConf='['+bD(cConf)+']';
        var oConf=eval(cadConf)[0];
        gEx('txtEtiqueta').setValue(oConf.etiqueta);
        cmbAccionCertificado.setValue(oConf.accionEjecucion);
        
        gEx('txtFuncionCertificacion').setValue(oConf.funcionModuloFirma);
        gEx('txtURLModulo').setValue(oConf.urlModuloCertificacion);
        cmbVisualizarBoton.setValue(oConf.visualizarBoton);
        var arrDatos=[];
        var x;
        var pos;
        for(x=0;x<arrAccionesFirma.length;x++)
        {
        	etiqueta=arrAccionesFirma[x][1];
            etapaEnvio='0';
            documentoFinal='0';
        	pos=existeValorArregloObjetos(oConf.arrAcciones,'idAccion',arrAccionesFirma[x][0]);    
            if(pos!=-1)
            {
            	etiqueta=oConf.arrAcciones[pos].etiquetaAccion;
                etapaEnvio=oConf.arrAcciones[pos].etapaEnvio;
                documentoFinal=oConf.arrAcciones[pos].documentoFinal;
                
            }
            
			arrDatos.push([arrAccionesFirma[x][0],etiqueta,etapaEnvio,documentoFinal]);        
        }
        
        
        /*for(x=0;x<oConf.arrAcciones.length;x++)
        {

        	arrDatos.push([oConf.arrAcciones[x].idAccion,oConf.arrAcciones[x].etiquetaAccion,oConf.arrAcciones[x].etapaEnvio,oConf.arrAcciones[x].documentoFinal]);
        }*/
        
        gEx('gAccionesFirma').getStore().loadData(arrDatos);
        
        
    }
    
}


function crearGridAccionFirma()
{
	var cmbEnvioEtapa=crearComboExt('cmbEnvioEtapa',arrEtapasNumero);
	var cmbDocumentoFinal=crearComboExt('cmbDocumentoFinal',arrSiNo);
    var dsDatos=[];
    var x;
    for(x=0;x<arrAccionesFirma.length;x++)
    {
    	dsDatos.push([arrAccionesFirma[x][0],arrAccionesFirma[x][1],'0','0']);
    }
    
    var alDatos=	new Ext.data.SimpleStore	(
                                                    {
                                                        fields:	[
                                                                    {name: 'accion'},
                                                                    {name: 'etiquetaAccion'},
                                                                    {name: 'etapaCambio'},
                                                                    {name: 'documentoFinal'}
                                                                ]
                                                    }
                                                );

    alDatos.loadData(dsDatos);
	var chkRow=new Ext.grid.CheckboxSelectionModel();
	
	var cModelo= new Ext.grid.ColumnModel   	(
												 	[
													 	
														{
															header:'Acci&oacute;n',
															width:190,
															sortable:true,
															dataIndex:'accion',
                                                            renderer:function(val)
                                                            		{
                                                                    	return formatearValorRenderer(arrAccionesFirma,val);
                                                                    }
														},
                                                        {
															header:'Etiqueta',
															width:190,
															sortable:true,
															dataIndex:'etiquetaAccion',
                                                            renderer:mostrarValorDescripcion,
                                                            editor:{xtype:'textfield'}
														},
														{
															header:'Enviar a etapa',
															width:250,
															sortable:true,
															dataIndex:'etapaCambio',
                                                            editor:cmbEnvioEtapa,
                                                            renderer:function(val)
                                                            		{
                                                                    	return formatearValorRenderer(arrEtapasNumero,val);
                                                                    }
														},
                                                        {
															header:'Documento final',
															width:115,
															sortable:true,
															dataIndex:'documentoFinal',
                                                            editor:cmbDocumentoFinal,
                                                            renderer:function(val)
                                                            		{
                                                                    	return formatearValorRenderer(arrSiNo,val);
                                                                    }
														}
													]
												);
                                                
	var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gAccionesFirma',
                                                            store:alDatos,
                                                            frame:false,
                                                            clicksToEdit:1,
                                                            x:0,
                                                            y:0,
                                                            cm: cModelo,
                                                            stripeRows :true,
                                                            loadMask:true,
                                                            stripeRows :true,
                                                            columnLines : true,
                                                            height:180
                                                            
                                                            
                                                        }
                                                    );
	                  
                                                    
	return 	tblGrid;
}


function configurarSubidaDocumento(iA,nE,obj)
{
	var objConf={};
    if(obj!='')
    {
    	objConf=eval('['+bD(obj)+']')[0];
        
    }
    
	var arrUnidad=[['KB','KB'],['MB','MB'],['GB','GB']];
	var cmbUnidad=crearComboExt('cmbUnidad',arrUnidad,260,65,110);
    cmbUnidad.setValue('MB');
    
	var cmbTipoDocumento=crearComboExt('cmbTipoDocumento',arrTiposDocumentos,210,5,280,{multiSelect:true});
    cmbTipoDocumento.setValue('0');
    if(objConf.categoriaDocumento)
    {
    	cmbTipoDocumento.setValue(objConf.categoriaDocumento);
    }
    
    if(objConf.unidadTamano)
    {
    	cmbUnidad.setValue(objConf.unidadTamano);
    }
    
    
    var cmbSiNoExpediente=crearComboExt('cmbSiNoExpediente',arrSiNo,210,95,110);
    cmbSiNoExpediente.setValue('1');
	if(objConf.asociarDocumentoExpediente)
    {
    	cmbSiNoExpediente.setValue(objConf.asociarDocumentoExpediente);
    }
    
    var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
                                            			{
                                                        	x:10,
                                                            y:10,
                                                            html:'Categor&iacute;a de documento a subir:'
                                                        },
                                                        cmbTipoDocumento,
                                                        {
                                                        	x:10,
                                                            y:40,
                                                            html:'Extensiones permitidas:'
                                                        },
                                                        {
                                                        	x:170,
                                                            y:35,
                                                            id:'txtExtensiones',
                                                            width:300,
                                                            value:objConf.extensionesPermitidas?decodeURI(objConf.extensionesPermitidas):'',
                                                            xtype:'textfield'
                                                        },
                                                        {
                                                        	x:10,
                                                            y:70,
                                                            html:'Tama&ntilde;o m&aacute;ximo permitido:'
                                                        },
                                                        {
                                                        	x:170,
                                                            y:65,
                                                            id:'txtTamano',
                                                            width:70,
                                                            value:objConf.tamanoMaximo?objConf.tamanoMaximo:'',
                                                            xtype:'numberfield',
                                                            allowNegative:false
                                                        },
                                                        cmbUnidad,
                                                        {
                                                        	x:10,
                                                            y:100,
                                                            html:'Asociar documento con expediente?:'
                                                        },
                                                        cmbSiNoExpediente,
                                                        {
                                                        	x:10,
                                                            y:130,
                                                            html:'No. Documentos Obligatorios:'
                                                        },
                                                        {
                                                        	x:210,
                                                            y:125,
                                                            width:40,
                                                            xtype:'numberfield',
                                                            allowDecimals:false,
                                                            allowNegative:false,
                                                            id:'txtNoObligatorios',
                                                            value:objConf.noDocumentosObligatorios?objConf.noDocumentosObligatorios:0
                                                        }
                                                        
                                                        
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Configuraci&oacute;n documento de subida',
										width: 540,
										height:240,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var cadObj='{"categoriaDocumento":"'+cmbTipoDocumento.getValue()+
                                                                        			'","extensionesPermitidas":"'+cv(gEx('txtExtensiones').getValue(),false,true)+
                                                                                    '","tamanoMaximo":"'+gEx('txtTamano').getValue()+
                                                                                    '","unidadTamano":"'+gEx('cmbUnidad').getValue()+'","asociarDocumentoExpediente":"'+
                                                                                    cmbSiNoExpediente.getValue()+'","noDocumentosObligatorios":"'+(gEx('txtNoObligatorios').getValue()==''?0:gEx('txtNoObligatorios').getValue())+'"}';
																	
                                                                    	function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	
                                                                                gE('btn_'+(iA)).innerHTML="<a href='javascript:configurarSubidaDocumento("+iA+","+nE+",\""+bE(cadObj)+"\")'><img src='../images/pencil.png' title='Configurar documentos de subida'  alt='Configurar documentos de subida'></a></span>";
                                                                            	ventanaAM.close();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=52&idAccion='+(iA)+'&numEtapa='+(nE)+'&objComp='+cadObj,true);
                                                                    
                                                                    }
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();
}


function removerFuncionControlEscenario(tipo)
{
	var control='';
    switch(tipo)
    {
    	case 1:
	    	control=gEx('txtFuncionAplicacionDictamenFinal');
    	break;
       case 2:
	    	control=gEx('txtFuncionVisualizacionDictamenFinal');
    	break;
        case 3:
	    	control=gEx('txtFuncionAplicacionArranqueScript');
    	break;
    }
    control.idConsulta='';
    control.setValue('');
}

function agregarFuncionControlEscenario(tipo)
{

	var control='';
	switch(tipo)
    {
    	case 1:
	    	control=gEx('txtFuncionAplicacionDictamenFinal');
    	break;
        case 2:
	    	control=gEx('txtFuncionVisualizacionDictamenFinal');
    	break;
        case 3:
	    	control=gEx('txtFuncionAplicacionArranqueScript');
    	break;
        
       
    }
    
    
    
    asignarFuncionNuevoConceptoInyeccion=function(idConsulta,nombre,ventana)
                                            {
                                             	control.idConsulta=idConsulta;
                                                control.setValue(nombre);
                                                
                                                if(gEx('vAgregarExp'))
	                                                gEx('vAgregarExp').close();
                                            }
    window.parent.mostrarVentanaExpresion(function(filaSelec,ventana)
    						{
                            	control.idConsulta=filaSelec.data.idConsulta;
                                control.setValue(filaSelec.data.nombreConsulta);
                                
                                
                                ventana.close();
                            }
    						,true);
    
}



function configurarArranqueProceso(iP,et,lblEtapa)
{
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'border',
											defaultType: 'label',
											items: 	[
                                            			crearGridAdministracionProcesosArranque(iP,et)
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Arranque de Procesos (Administraci&oacute;n), <span style="color:#000"><b>Etapa:</b></span>&nbsp;'+bD(lblEtapa),
										width: 850,
										height:400,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
                                                        show : {
                                                                    buffer : 10,
                                                                    fn : function() 
                                                                    {
                                                                    }
                                                                }
                                                    },
										buttons:	[
														{
															
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();	

}


function crearGridAdministracionProcesosArranque(iP,nE)
{
	 var lector= new Ext.data.JsonReader({
                                            
                                            totalProperty:'numReg',
                                            fields: [
                                               			{name:'idRegistro'},
		                                                {name: 'nombreProceso'},
		                                                {name:'etapaIngreso'},
                                                        {name: 'idProcesoDestino'},
                                                        {name:'lblEtapaIngreso'},
                                                        {name: 'funcionAplicacion'},
                                                        {name: 'lblFuncionAplicacion'},
                                                        {name: 'mostrarVentanaProceso'}
                                            		],
                                            root:'registros'
                                            
                                        }
                                      );
	 
                                                                                      
	var alDatos=new Ext.data.GroupingStore({
                                                            reader: lector,
                                                            proxy : new Ext.data.HttpProxy	(

                                                                                              {

                                                                                                  url: '../paginasFunciones/funcionesProyectos.php'

                                                                                              }

                                                                                          ),
                                                            sortInfo: {field: 'nombreProceso', direction: 'ASC'},
                                                            groupField: 'nombreProceso',
                                                            remoteGroup:false,
				                                            remoteSort: false,
                                                            autoLoad:true
                                                            
                                                        }) 
	alDatos.on('beforeload',function(proxy)
    								{
                                    	proxy.baseParams.funcion='355';
                                        proxy.baseParams.iP=iP;
                                        proxy.baseParams.nE=nE;
                                        
                                    }
                        )   
       
        var cModelo= new Ext.grid.ColumnModel   	(
                                                        [
                                                            new  Ext.grid.RowNumberer(),
                                                            
                                                            {
                                                                header:'Proceso',
                                                                width:300,
                                                                sortable:true,
                                                                renderer:mostrarValorDescripcion,
                                                                dataIndex:'nombreProceso'
                                                            },
                                                            {
                                                                header:'Etapa de Ingreso',
                                                                width:180,
                                                                sortable:true,
                                                                dataIndex:'lblEtapaIngreso'
                                                            },
                                                            {
                                                                header:'Aperturar Ventana de Proceso',
                                                                width:180,
                                                                align:'center',
                                                                sortable:true,
                                                                renderer:function(val)
                                                                		{
                                                                        	return formatearValorRenderer(arrSiNo,val);
                                                                        },
                                                                dataIndex:'mostrarVentanaProceso'
                                                            },
                                                            {
                                                                header:'Funci&oacute;n de Aplicaci&oacute;n',
                                                                width:290,
                                                                sortable:true,
                                                                renderer:mostrarValorDescripcion,
                                                                dataIndex:'lblFuncionAplicacion'
                                                            }
                                                        ]
                                                    );
                                                    
        var tblGrid=	new Ext.grid.GridPanel	(
                                                            {
                                                                id:'gProcesosArranque',
                                                                store:alDatos,
                                                                region:'center',
                                                                frame:false,
                                                                cm: cModelo,
                                                                stripeRows :true,
                                                                loadMask:true,
                                                                tbar:	[
                                                                            {
                                                                                icon:'../images/add.png',
                                                                                cls:'x-btn-text-icon',
                                                                                text:'Agregar Arranque de Proceso',
                                                                                handler:function()
                                                                                        {
                                                                                         	mostrarVentanaConfiguracionArranqueProceso(iP,nE)	   
                                                                                        }
                                                                                
                                                                            },'-',
                                                                            {
                                                                                icon:'../images/pencil.png',
                                                                                cls:'x-btn-text-icon',
                                                                                text:'Modificar Arranque de Proceso',
                                                                                handler:function()
                                                                                        {
                                                                                         	var fila=gEx('gProcesosArranque').getSelectionModel().getSelected();
                                                                                            if(!fila)
                                                                                            {
                                                                                            	msgBox('Debe seleccionar el proceso cuyo arranque desea modificar');
                                                                                            	return;
                                                                                            }
                                                                                            mostrarVentanaConfiguracionArranqueProceso(iP,nE,fila);   
                                                                                        }
                                                                                
                                                                            },'-',
                                                                            {
                                                                                icon:'../images/delete.png',
                                                                                cls:'x-btn-text-icon',
                                                                                text:'Remover Arranque de Proceso',
                                                                                handler:function()
                                                                                        {
                                                                                            var fila=gEx('gProcesosArranque').getSelectionModel().getSelected();
                                                                                            if(!fila)
                                                                                            {
                                                                                            	msgBox('Debe seleccionar el proceso cuyo arranque desea remover');
                                                                                            	return;
                                                                                            }
                                                                                            
                                                                                            
                                                                                            function resp(btn)
                                                                                            {
                                                                                            	if(btn=='yes')
                                                                                                {
                                                                                                	function funcAjax()
                                                                                                    {
                                                                                                        var resp=peticion_http.responseText;
                                                                                                        arrResp=resp.split('|');
                                                                                                        if(arrResp[0]=='1')
                                                                                                        {
                                                                                                         	gEx('gProcesosArranque').getStore().remove(fila);   
                                                                                                        }
                                                                                                        else
                                                                                                        {
                                                                                                            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                                        }
                                                                                                    }
                                                                                                    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=356&iR='+fila.data.idRegistro,true);
                                                                                                    
                                                                                                }
                                                                                            }
                                                                                            msgConfirm('¿Est&aacute; seguro de querer remover el arranque del proceso seleccionado?',resp);
                                                                                            
                                                                                            
                                                                                            
                                                                                        }
                                                                                
                                                                            }
                                                                            
                                                                        ],
     
                                                                columnLines : true,                                                                
                                                                view:new Ext.grid.GroupingView({
                                                                                                    forceFit:false,
                                                                                                    showGroupName: false,
                                                                                                    enableGrouping :false,
                                                                                                    enableNoGroups:false,
                                                                                                    enableGroupingMenu:false,
                                                                                                    hideGroupedColumn: false,
                                                                                                    startCollapsed:false
                                                                                                })
                                                            }
                                                        );
        return 	tblGrid;
}


function mostrarVentanaConfiguracionArranqueProceso(iP,nE,filaProceso)
{
	var cmbEtapaInicioProceso=crearComboExt('cmbEtapaInicioProceso',[],190,35,350);
	var cmbProcesos=crearComboExt('cmbProcesos',arrProcesosActivos,190,5,350);


	cmbProcesos.on('select',function(cmb,registro)
    						{
                            	gEx('cmbEtapaInicioProceso').setValue('');
                                gEx('cmbEtapaInicioProceso').getStore().loadData(registro.data.valorComp);
                                recargarGridCamposArrancaProceso()
                            }
    			)    
                
	             
	var cmbAperturarVentana=crearComboExt('cmbAperturarVentana',arrSiNo,190,65,110);                

	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
                                            			{
                                                        	x:10,
                                                            y:10,
                                                            html:'Nombre del Proceso:'
                                                        },
                                                        cmbProcesos,
                                                        {
                                                        	x:10,
                                                            y:40,
                                                            html:'Iniciar en Etapa:'
                                                        },
                                                        cmbEtapaInicioProceso,
                                                        
                                                        {
                                                        	x:10,
                                                            y:70,
                                                            html:'Aperturar Venta de Proceso?:'
                                                        },
                                                        cmbAperturarVentana,
                                                        {
                                                        	x:10,
                                                            y:100,
                                                            html:'Funci&oacute;n de Aplicaci&oacute;n:'
                                                        },
                                                        {
                                                            xtype:'textfield',
                                                            id:'txtFuncionAplicacion',
                                                            x:190,
                                                            y:95,
                                                            readOnly:true,
                                                            width:250
                                                        },
                                                        {
                                                            x:450,
                                                            y:93,
                                                            html:'<a href="javascript:abrirVentanaFuncion(1)"><img src="../images/pencil.png" /></a>&nbsp;&nbsp;&nbsp;<a href="javascript:removerFuncion(1)"><img src="../images/cross.png" /></a>'
                                                        },
                                                        crearGridCamposProcesoArranque(iP,nE,filaProceso?filaProceso.data.idRegistro:-1)
                                                        
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Arranque de Proceso',
										width: 900,
										height:470,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															
															text: '<?php echo $etj["lblBtnAceptar"]?>',                                                            
															handler: function()
																	{
                                                                    	
                                                                        if(cmbProcesos.getValue()=='')
                                                                        {
                                                                        	function respAux()
                                                                            {
                                                                            	cmbProcesos.focus();
                                                                            }
                                                                            msgBox('Debe indicar el nombre del proceso a arrancar',respAux);
                                                                        	return;
                                                                        }
                                                                        
                                                                        if(cmbEtapaInicioProceso.getValue()=='')
                                                                        {
                                                                        	function respAux()
                                                                            {
                                                                            	cmbEtapaInicioProceso.focus();
                                                                            }
                                                                            msgBox('Debe indicar la etapa en la cual arrancar&aacute; el proceso',respAux);
                                                                        	return;
                                                                        }
                                                                    
                                                                    	var gCamposTablero=gEx('gCamposTablero');
                                                                        var x;
																		var fila;
                                                                        var aRegistros='';
                                                                        for(x=0;x<gCamposTablero.getStore().getCount();x++)
                                                                        {
                                                                        	fila=gCamposTablero.getStore().getAt(x);
                                                                            
                                                                            if(fila.data.tipoLlenado=='')
                                                                            {
                                                                            	function resp()
                                                                                {
                                                                                	gCamposTablero.startEditing(x,3);
                                                                                }
                                                                                msgBox('Debe indicar el tipo de llenado del campo',resp)
                                                                            	return;
                                                                            }
                                                                            
                                                                            if((fila.data.tipoLlenado!='0')&&(fila.data.valor==''))
                                                                            {
                                                                            	function resp2()
                                                                                {
                                                                                	if(fila.data.tipoLlenado!='7')
	                                                                                	gCamposTablero.startEditing(x,3);
                                                                                }
                                                                                msgBox('Debe indicar el valor a asignar al campo destino',resp2)
                                                                            	return;
                                                                            }
                                                                            
                                                                            obj='{"campoDestino":"'+fila.data.nombreCampo+'","tipoLlenado":"'+fila.data.tipoLlenado+'","valor":"'+cv(fila.data.valor)+'"}';
                                                                            
                                                                            if(aRegistros=='')
                                                                            {
                                                                            	aRegistros=obj;
                                                                            }
                                                                            else
                                                                            {
                                                                            	aRegistros+=','+obj;
                                                                            }
                                                                        }
                                                                        
                                                                        var cadObj='{"idProcesoOrigen":"'+bD(iP)+'","idProcesoDestino":"'+cmbProcesos.getValue()+'","numEtapaOrigen":"'+bD(nE)+
                                                                        			'","numEtapaDestino":"'+cmbEtapaInicioProceso.getValue()+'","funcionAplicacion":"'+
                                                                                    gEx('txtFuncionAplicacion').idFuncion+'","registros":['+aRegistros+
                                                                                    '],"aperturarVentanaProceso":"'+cmbAperturarVentana.getValue()+'","idRegistro":"'+
                                                                                    (filaProceso?filaProceso.data.idRegistro:-1)+'"}';
                                                                        

																	
                                                                    	function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	gEx('gProcesosArranque').getStore().reload();
                                                                                ventanaAM.close();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=354&cadObj='+cadObj,true);
                                                                        
                                                                    
                                                                    }
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();
    gEx('txtFuncionAplicacion').idFuncion=-1;
    if(filaProceso)
    {
    	
    	cmbProcesos.setValue(filaProceso.data.idProcesoDestino);
        dispararEventoSelectCombo('cmbProcesos');
        gEx('cmbEtapaInicioProceso').setValue(parseFloat(filaProceso.data.etapaIngreso));
    	cmbAperturarVentana.setValue(filaProceso.data.mostrarVentanaProceso);
    }   	
}


function crearGridCamposProcesoArranque(iP,nE,iR)
{
	var cmbLlenado=crearComboExt('cmbLlenado',tiposLlenado,0,0);
  
	var lector= new Ext.data.JsonReader({
                                            
                                            totalProperty:'numReg',
                                            fields: [
                                               			{name:'nombreCampo'},
                                                        {name:'tipoDato'},
		                                                {name: 'tipoLlenado'},
                                                        {name: 'etiquetaValor'},
		                                                {name:'valor'},
                                                        {name: 'esCampoDefault'}
                                            		],
                                            root:'registros'
                                            
                                        }
                                      );
	 
                                                                                      
	var alDatos=new Ext.data.GroupingStore({
                                                            reader: lector,
                                                            proxy : new Ext.data.HttpProxy	(

                                                                                              {

                                                                                                  url: '../paginasFunciones/funcionesProyectos.php'

                                                                                              }

                                                                                          ),
                                                            
                                                            remoteGroup:false,
				                                            remoteSort: false,
                                                            autoLoad:false
                                                            
                                                        }) 
	alDatos.on('beforeload',function(proxy)
    								{
                                    	proxy.baseParams.funcion='353';
                                        proxy.baseParams.idProcesOrigen=iP;
                                        proxy.baseParams.numEtapa=nE;
                                        proxy.baseParams.idRegistro=bE(iR);
                                    }
                        )   
       
    var cModelo= new Ext.grid.ColumnModel   	(
                                                    [
                                                        new  Ext.grid.RowNumberer(),
                                                        
                                                        {
                                                            header:'Campo de Formulario Base<br>(Proceso Origen)',
                                                            width:200,
                                                            sortable:true,
                                                            dataIndex:'nombreCampo',
                                                            renderer:function(val,meta,registro)
                                                            		{
                                                                    	var color='000';
                                                                        if(registro.data.esCampoDefault=='1')
                                                                        {
                                                                        	color='900';
                                                                        }
                                                                    	return '<span style="color:#'+color+'">'+val+'</span>';
                                                                    }
                                                        },
                                                        {
                                                            header:'Tipo de dato',
                                                            width:150,
                                                            sortable:true,
                                                            dataIndex:'tipoDato'
                                                        },
                                                        {
                                                            header:'Tipo de llenado',
                                                            width:180,
                                                            sortable:true,
                                                            dataIndex:'tipoLlenado',
                                                            editor:cmbLlenado,
                                                            renderer:function(val)
                                                            		{
                                                                    	return formatearValorRenderer(tiposLlenado,val);
                                                                    }
                                                        },
                                                        {
                                                            header:'Valor',
                                                            width:280,
                                                            sortable:true,
                                                            editor:{xtype:'textfield'},
                                                            dataIndex:'valor',
                                                            renderer:function(val,meta,registro)
                                                            		{
                                                                    	var comp='';
                                                                        switch(registro.data.tipoLlenado)
                                                                        {
                                                                        	case '4':
                                                                            	comp='<a href=\'javascript:mostrarVentanaAlmacenDatosTableroControl("'+bE(registro.data.nombreCampo)+'")\'><img src="../images/pencil.png" width="14" height="14" title="Modificar" alt="Modificar"></a> ';
                                                                            break;
                                                                            case '7':
                                                                            	comp='<a href=\'javascript:mostrarVentanaFuncionSistemaTableroControl("'+bE(registro.data.nombreCampo)+'")\'><img src="../images/pencil.png" width="14" height="14" title="Modificar" alt="Modificar"></a> ';
                                                                            break;
                                                                        }
                                                                    	return comp+mostrarValorDescripcion(registro.data.etiquetaValor);
                                                                    }
                                                        }
                                                    ]
                                                );
                                                    
    var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gCamposTablero',
                                                            store:alDatos,
                                                            x:10,
                                                            y:130,
                                                            frame:false,
                                                            height:265,
                                                           	border:true,
                                                            cm: cModelo,
                                                            clicksToEdit:1,
                                                            stripeRows :true,
                                                            loadMask:true,
                                                            columnLines : true, 
                                                            view:new Ext.grid.GroupingView({
                                                                                                forceFit:false,
                                                                                                showGroupName: false,
                                                                                                enableGrouping :false,
                                                                                                enableNoGroups:false,
                                                                                                enableGroupingMenu:false,
                                                                                                hideGroupedColumn: false,
                                                                                                startCollapsed:false
                                                                                            })
                                                        }
                                                    );
                                                    
                                                    
    tblGrid.on('beforeedit',function(e)
    						{
                            	
                                
                                
                                if((e.field=='valor'))
                                {
                                	var control=null;
                                    
									switch(e.record.data.tipoLlenado)
                                    {
                                    	case '1': //Valor de sesión
                                        	control=crearComboExt('ctrlValor',arrValorSesionGlobal,0,0);
                                        break;
                                        case '2': //Valor de sistema
                                        	control=crearComboExt('ctrlValor',arrValorSistemaGlobal,0,0);
                                        break;
                                        /*case '3': //Consulta auxiliar
                                        	var arrAlmacenDatos=obtenerAlmacenesDatosDisponibles(2);
                                            control=crearComboExt('ctrlValor',arrAlmacenDatos,0,0);
                                        break;
                                        case '4': //Almacen de datos
                                        	
                                        break;
                                        case '5': //Valor de parámetro
                                        	control=crearComboExt('ctrlValor',arrParametrosGenerales,0,0);
                                        break;*/
                                        case '6':  //Valor de formulario base
                                        	control=crearComboExt('ctrlValor',arrCamposFormularioBaseOrigen,0,0);
                                        break;
                                        case '7':  //Función de sistema
                                        	
                                        break;
                                        case '8':  //Valor manual
                                        	control=new Ext.form.TextField({id:'ctrlValor'});
                                        break;
                                        
                                    }
                                    
                                    
                                    e.grid.getColumnModel().setEditor(4,control);
                                    
                                }
                                
                                
                                	
                                
                                
                            }
    			)
                
                
	tblGrid.on('afteredit',function(e)
    						{
                            	if(e.field=='tipoLlenado')
                                {
                                	e.record.set('valor','');
                                    e.record.set('etiquetaValor','');
                                }
                                
                                
                                if(e.field=='valor')
                                {
                                
                                	var control=gEx('ctrlValor');
                                	if(control)
                                    {
                                    	switch(e.record.data.tipoLlenado)
                                        {
                                            case '1': //Valor de sesión
                                               
                                            case '2': //Valor de sistema
                                               
                                            case '3': //Consulta auxiliar
                                            case '5': //Valor de parámetro    
                                            case '6':  //Valor de formulario base
                                            var etiquetaValor='';
                                            
                                            var pos=obtenerPosFila(control.getStore(),'id',e.record.data.valor);
                                            etiquetaValor=control.getStore().getAt(pos).data.nombre;
                                            e.record.set('etiquetaValor',etiquetaValor);
                                            
                                            break;
                                            case '4': //Almacen de datos
                                                
                                            break;
                                            case '7':  //Función de sistema
                                                
                                            break;
                                            case '8':  //Valor manual
                                                e.record.set('etiquetaValor',e.value);
                                            break;
                                            
                                        }
                                        
                                            
	                                	
                                    }
                                }
                                
                            }
    			)                
    
                                                    
    return 	tblGrid;	
}

function recargarGridCamposArrancaProceso()
{

	gEx('gCamposTablero').getStore().load	(
    											{
                                                	url:'../paginasFunciones/funcionesProyectos.php',
                                                    params:	{
                                                    			idProcesoDestino:bE(gEx('cmbProcesos').getValue())
                                        
                                                    		}
                                                                                                    
												}
    										);
}


function mostrarVentanaFuncionSistemaTableroControl(iCampo)
{
	
    asignarFuncionNuevoConceptoInyeccion=function(idConsulta,nombre,ventana)
                                            {
                                             	var pos=obtenerPosFila(gEx('gCamposTablero').getStore(),'nombreCampo',bD(iCampo));
                                                var fila=gEx('gCamposTablero').getStore().getAt(pos);
                                                fila.set('valor',idConsulta);
                                                fila.set('etiquetaValor',nombre);
                                                if(gEx('vAgregarExp'))
	                                                gEx('vAgregarExp').close();
                                            }
    mostrarVentanaExpresion(function(filaSelec,ventana)
    						{
                            	var pos=obtenerPosFila(gEx('gCamposTablero').getStore(),'nombreCampo',bD(iCampo));
                                var fila=gEx('gCamposTablero').getStore().getAt(pos);
                                fila.set('valor',filaSelec.data.idConsulta);
                                fila.set('etiquetaValor',filaSelec.data.nombreConsulta);
                                
                                ventana.close();
                            }
    						,true);
    
}

function configurarCambioEtapaProceso(iP,et,lblEtapa)
{
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'border',
											defaultType: 'label',
											items: 	[
                                            			crearGridAdministracionProcesosAsociado(iP,et)
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Cambiar de Etapa a Proceso Asociado (Administraci&oacute;n), <span style="color:#000"><b>Etapa:</b></span>&nbsp;'+bD(lblEtapa),
										width: 850,
										height:400,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
                                                        show : {
                                                                    buffer : 10,
                                                                    fn : function() 
                                                                    {
                                                                    }
                                                                }
                                                    },
										buttons:	[
														{
															
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();	

}


function crearGridAdministracionProcesosAsociado(iP,nE)
{
	var cmbEditor=crearComboExt('cmbEditor',[]);
	 var lector= new Ext.data.JsonReader({
                                            
                                            totalProperty:'numReg',
                                            fields: [
                                               			{name:'idRegistro'},
		                                                {name: 'nombreProceso'},
		                                                {name:'etapaCambio'},
                                                        {name: 'funcionAplicacion'},
                                                        {name: 'lblFuncionAplicacion'},
                                                        {name: 'relacionProceso'},
                                                        {name: 'etapasProceso'},
                                                        {name: 'valor'},
                                                        {name: 'idProcesoDestino'}
                                                        
                                            		],
                                            root:'registros'
                                            
                                        }
                                      );
	 
                                                                                      
	var alDatos=new Ext.data.GroupingStore({
                                                            reader: lector,
                                                            proxy : new Ext.data.HttpProxy	(

                                                                                              {

                                                                                                  url: '../paginasFunciones/funcionesProyectos.php'

                                                                                              }

                                                                                          ),
                                                            sortInfo: {field: 'nombreProceso', direction: 'ASC'},
                                                            groupField: 'relacionProceso',
                                                            remoteGroup:false,
				                                            remoteSort: false,
                                                            autoLoad:true
                                                            
                                                        }) 
	alDatos.on('beforeload',function(proxy)
    								{
                                    	proxy.baseParams.funcion='357';
                                        proxy.baseParams.iP=iP;
                                        proxy.baseParams.nE=nE;
                                        
                                    }
                        )   
       
        var cModelo= new Ext.grid.ColumnModel   	(
                                                        [
                                                            new  Ext.grid.RowNumberer(),
                                                            
                                                            {
                                                                header:'Proceso',
                                                                width:300,
                                                                sortable:true,
                                                                renderer:mostrarValorDescripcion,
                                                                dataIndex:'nombreProceso'
                                                            },
                                                            {
                                                                header:'Relaci&oacute;n Proceso',
                                                                width:170,
                                                                dataIndex:'relacionProceso',
                                                                sortable:true,
                                                                renderer:function(val)
                                                                		{
                                                                        	return val=='1'?'Proceso Derivado':'Proceso Padre';
                                                                        }
                                                                
                                                            },
                                                            {
                                                                header:'Cambiar a Etapa',
                                                                width:180,
                                                                sortable:true,
                                                                dataIndex:'etapaCambio',
                                                                editor:cmbEditor,
                                                                renderer:function (val,meta,registro)
                                                                		{
                                                                        	return mostrarValorDescripcion(formatearValorRenderer(registro.data.etapasProceso,val,1,true));	
                                                                        }
                                                            },
                                                            {
                                                                header:'Funci&oacute;n de Aplicaci&oacute;n',
                                                                width:290,
                                                                sortable:true,
                                                                renderer:mostrarValorDescripcion,
                                                                dataIndex:'lblFuncionAplicacion',
                                                                renderer:function(val,meta,registro,numFila)
                                                                		{
                                                                        	if(parseFloat(registro.data.etapaCambio)!=0)
	                                                                        	return '<a href="javascript:registrarFuncionAplicacionCambioEtapa(\''+bE(numFila)+'\',\''+bE(registro.data.idRegistro)+'\')"><img height="14" width="14" src="../images/pencil.png" title="Agregar Funci&oacute;n de Aplicaci&oacute;n"></a>'+
                                                                                		'&nbsp;<a href="javascript:removerFuncionAplicacionCambioEtapa(\''+bE(numFila)+'\',\''+bE(registro.data.idRegistro)+'\')"><img height="14" width="14"  src="../images/cross.png" title="Remover Funci&oacute;n de Aplicaci&oacute;n"></a>&nbsp;&nbsp;'+mostrarValorDescripcion(val);
                                                                        }
                                                            }
                                                        ]
                                                    );
                                                    
        var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                            {
                                                                id:'gProcesosCambioEtapa',
                                                                store:alDatos,
                                                                region:'center',
                                                                frame:false,
                                                                cm: cModelo,
                                                                clicksToEdit:1,
                                                                stripeRows :true,
                                                                loadMask:true,
                                                                columnLines : true,                                                                
                                                                view:new Ext.grid.GroupingView({
                                                                                                    forceFit:false,
                                                                                                    showGroupName: false,
                                                                                                    enableGrouping :true,
                                                                                                    enableNoGroups:false,
                                                                                                    enableGroupingMenu:false,
                                                                                                    hideGroupedColumn: true,
                                                                                                    startCollapsed:false
                                                                                                })
                                                            }
                                                        );


		tblGrid.on('beforeedit',function(e)
        						{
                                	gEx('cmbEditor').getStore().loadData(e.record.data.etapasProceso);
                                }
        			)
	
    	tblGrid.on('afteredit',function(e)
        						{
                                	function funcAjax()
                                    {
                                        var resp=peticion_http.responseText;
                                        arrResp=resp.split('|');
                                        if(arrResp[0]=='1')
                                        {
                                            gEx('gProcesosCambioEtapa').getStore().reload();
                                        }
                                        else
                                        {
                                            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                        }
                                    }
                                    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=358&tR='+bE(e.record.data.relacionProceso)+'&iP='+iP+'&nE='+nE+'&iPD='+bE(e.record.data.idProcesoDestino)+'&v='+bE(e.value),true);
                                    
                                }
        			)
    
        return 	tblGrid;
}

function abrirVentanaFuncion(tipo)
{
	mostrarVentanaExpresion(	function(fila,ventana)
    							{
                                	if(tipo==1)
                                    {
                                        gEx('txtFuncionAplicacion').setValue(fila.get('nombreConsulta'));
                                        gEx('txtFuncionAplicacion').idFuncion=fila.get('idConsulta');
                                    }
                                    else
                                    {
                                        //gEx('txtFuncionVisualizacion').setValue(fila.get('nombreConsulta'));
                                        //gEx('txtFuncionVisualizacion').idFuncion=fila.get('idConsulta');
                                    }
                                    ventana.close();
                            	}
    							,true
                          );
}

function removerFuncion(tipo)
{
	if(tipo==1)
    {
        gEx('txtFuncionAplicacion').setValue('');
        gEx('txtFuncionAplicacion').idFuncion=-1;
    }
    else
    {
        //gEx('txtFuncionVisualizacion').setValue('');
        //gEx('txtFuncionVisualizacion').idFuncion=-1;
    }
}


function registrarFuncionAplicacionCambioEtapa(numFila,iR)
{


	asignarFuncionNuevoConceptoInyeccion=function(idConsulta,nombre,ventana)
                                            {
                                            	function funcAjax()
                                                {
                                                    var resp=peticion_http.responseText;
                                                    arrResp=resp.split('|');
                                                    if(arrResp[0]=='1')
                                                    {
                                                        var pos=parseInt(bD(numFila));
                                                        var fila=gEx('gProcesosCambioEtapa').getStore().getAt(pos);
                                                        fila.set('valor',idConsulta);
                                                        fila.set('lblFuncionAplicacion',nombre);
                                                        if(gEx('vAgregarExp'))
                                                            gEx('vAgregarExp').close();
                                                    }
                                                    else
                                                    {
                                                        msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                    }
                                                }
                                                obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=359&iR='+iR+'&iF='+bE(idConsulta),true);

                                            
                                            
                                             	
                                            }
    mostrarVentanaExpresion(function(filaSelec,ventana)
    						{
                            	
                                function funcAjax()
                                {
                                	 var resp=peticion_http.responseText;
                                    arrResp=resp.split('|');
                                    if(arrResp[0]=='1')
                                    {
                                        var pos=parseInt(bD(numFila));
                                        var fila=gEx('gProcesosCambioEtapa').getStore().getAt(pos);
                                        fila.set('valor',filaSelec.data.idConsulta);
                                        fila.set('lblFuncionAplicacion',filaSelec.data.nombreConsulta);                                
                                        ventana.close();
                                    }
                                    else
                                    {
                                        msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                    }
                                }
                                obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=359&iR='+iR+'&iF='+bE(filaSelec.data.idConsulta),true);
                            }
    						,true);
    
}

function removerFuncionAplicacionCambioEtapa(numFila,iR)
{
	var pos=parseInt(bD(numFila));
	var fila=gEx('gProcesosCambioEtapa').getStore().getAt(pos);
    fila.set('valor','');
	fila.set('lblFuncionAplicacion','');
    
    function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
            var pos=parseInt(bD(numFila));
            var fila=gEx('gProcesosCambioEtapa').getStore().getAt(pos);
            fila.set('valor',filaSelec.data.idConsulta);
            fila.set('lblFuncionAplicacion',filaSelec.data.nombreConsulta);                                
            ventana.close();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=359&iR='+iR+'&iF=',true);

}

function dispararScript(iP,et,lblEtapa,objVal)
{	
	var oVal=eval(bD(objVal));
	var oReg=null;
    
    if(oVal.length>0)
    {
    	oReg=oVal[0];
    }
    
	var cmbImprimir=crearComboExt('cmbImprimir',arrSiNo,180,35,140);
	if(oReg)
    {
    	cmbImprimir.setValue(oReg.imprimirScript);
    }
    
    
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
                                            			{
                                                        	x:10,
                                                            y:10,
                                                            html:'URL de Script a Ejecutar:'
                                                        },
                                                        {
                                                        	x:180,
                                                            y:5,
                                                            xtype:'textfield',
                                                            width:480,
                                                            id:'txtURLScript',
                                                            value:oReg?oReg.urlScript:''
                                                        },
                                                        {
                                                        	x:10,
                                                            y:40,
                                                            html:'Imprimir al ejecutar el Script?:'
                                                        },
                                                        cmbImprimir
                                                        ,
                                                        {
                                                        	x:10,
                                                            y:70,
                                                            html:'Funci&oacute;n de Aplicaci&oacute;n:'
                                                        },
                                                        {
                                                          xtype:'textfield',
                                                          width:350,
                                                          x:180,
                                                          y:65,
                                                          id:'txtFuncionAplicacionArranqueScript',
                                                          readOnly:true,
                                                          value:oReg?oReg.lblFuncionAplicacion:''
                                                      },
                                                      {
                                                          xtype:'label',
                                                          x:550,
                                                          y:63,
                                                          html:'<a href="javascript:agregarFuncionControlEscenario(3)"><img src="../images/pencil.png"></a>&nbsp;&nbsp;<a href="javascript:removerFuncionControlEscenario(3)"><img src="../images/cross.png"></a>'
                                                      }
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Disparar Script, <span style="color:#900; font-weight:bold">Etapa:</span> '+bD(lblEtapa),
										width: 750,
										height:200,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															
															text: '<?php echo $etj["lblBtnAceptar"]?>',
                                                            
															handler: function()
																	{
																		var txtURLScript=gEx('txtURLScript');
                                                                        var cmbImprimir=gEx('cmbImprimir');
                                                                        var txtFuncionAplicacionArranqueScript=gEx('txtFuncionAplicacionArranqueScript');
                                                                        
                                                                       
                                                                        if(cmbImprimir.getValue()=='')
                                                                        {
                                                                        	function resp2()
                                                                            {
                                                                            	cmbImprimir.focus();
                                                                            }
                                                                            msgBox('Debe indicar si se imprimira una vez ejecutado el Script',resp2)
                                                                            return;
                                                                        }
                                                                        
                                                                        
                                                                        var cadObj='{"urlScript":"'+cv(txtURLScript.getValue())+'","imprimir":"'+cmbImprimir.getValue()+
                                                                        			'","funcionAplicacion":"'+(txtFuncionAplicacionArranqueScript.idConsulta?txtFuncionAplicacionArranqueScript.idConsulta:-1)+
                                                                                    '","idProceso":"'+bD(iP)+'","numEtapa":"'+bD(et)+'"}';
                                                                                    
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	function resp()
                                                                                {
                                                                                	var objBtn='[{"functionAplicacion":"'+txtFuncionAplicacionArranqueScript.idConsulta+'","imprimirScript":"'+cmbImprimir.getValue()+'","lblFuncionAplicacion":"'+cv(txtFuncionAplicacionArranqueScript.getValue())+'","urlScript":"'+txtURLScript.getValue()+'"}]';
                                                                                	gE('btnScriptEjecutar_'+bD(iP)+'_'+bD(et)).innerHTML= "<a href='javascript:dispararScript(\""+iP+"\",\""+et+"\",\""+lblEtapa+"\",\""+bE(objBtn)+"\")'><img src=\"../images/script_go.png\" title='Disparar Script' alt='Disparar Script'/></a></td>";
                                                                                    
                                                                                    
                                                                                    
                                                                                	 ventanaAM.close();
                                                                                }
                                                                                msgBox('Se ha guardado satisfactoriamente la configuraci&oacute;n del Script',resp);
                                                                                return;
                                                                            	  
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=360&cadObj='+cadObj,true);
                                                                        
                                                                                    
                                                                                    
                                                                        
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();
    
    
   	gEx('txtFuncionAplicacionArranqueScript').idConsulta=oReg?oReg.functionAplicacion:-1;
}