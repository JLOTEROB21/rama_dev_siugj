<?php session_start();
include("configurarIdiomaJS.php");
$idDocumento=bD($_GET["iD"]);
$consulta="select pc.idProyectoVSComite,c.idComite,c.nombreComite,pc.agregarFrm from 235_proyectosVSComites pc,
		2006_comites c where c.idComite=pc.idComite and idProyecto=".$idDocumento;
$arrComites=uEJ($con->obtenerFilasArreglo($consulta));
$consulta="select nombreFormulario,idFormulario from 900_formularios where idProceso=".$idDocumento." and formularioBase=1";
$filaFormulario=$con->obtenerPrimeraFila($consulta);
$nombreFormulario=$filaFormulario[0];
$idFormulario=$filaFormulario[1];
$consulta="select valor,texto from 1004_siNo where idIdioma=".$_SESSION["leng"];
$arrSiNo=uEJ($con->obtenerFilasArreglo($consulta));


$consulta="select valor,texto from 1004_siNo where idIdioma=".$_SESSION["leng"];
$arrSiNo=$con->obtenerFilasArreglo($consulta);


$consulta="select concat(idRol,'_',extensionRol),nombreGrupo from 8001_roles where idIdioma=".$_SESSION["leng"]." and situacion=1 order by nombreGrupo";
$arrRolesSistema=uEJ($con->obtenerFilasArreglo($consulta));




?>
var arrRolesParticipantesProceso=[];
var arrRolesSistema=<?php echo $arrRolesSistema?>;
var arrSiNo=<?php echo $arrSiNo?>;
var arrTipoNotificaciones=[];
Ext.onReady(inicializar);
var nodoSel=null;
var nodoSelComite=null;
var nodoSelRol=null;
var idProceso;
var tProceso;
var recargarTab=true;
var recargarTabLita=true;
function inicializar()
{
	Ext.Updater.defaults.loadScripts=true;
	idProceso=gE('idDocumento').value;
    var iP=idProceso;
    tProceso=gE('tProceso').value;
	Ext.QuickTips.init();
   	var arbol=	generarArbol(<?php echo $idDocumento?>);
    var gridOtrasSeccion=crearGridOtrasSecciones(<?php echo $idDocumento?>);
    new   Ext.TabPanel (	{
                                    renderTo:'divArbol',
                                    id:'tArbol',
                                    activeTab:0,
                                    frame:false,
                                    border:false,
                                    height:450,
                                    items:	[
                                    			{
                                                	xtype:'panel'
                                                },
                                             	{
                                                	xtype:'panel',
                                                    title:'Elementos del proceso',
                                                    items:[arbol]
                                                }  ,
                                                {
                                                	xtype:'panel',
                                                    title:'Otras secciones disponibles',
                                                    items:[gridOtrasSeccion]
                                                } 
                                            ]
                                }
                             )
    

    var arrPaneles=new Array();
    var nPanel=1;
    
    arrPaneles.push({id:'tab'+nPanel,contentEl:'divElementos', title:nPanel+'.- Configuraci&oacute;n Gral.'});
    
    nPanel++;
  /*  arrPaneles.push({id:'tab'+nPanel,contentEl:'divSelComites', title:nPanel+'.- Selecci&oacute;n de comit&eacute;s participantes'});
    nPanel++;*/
    arrPaneles.push({id:'tab'+nPanel,contentEl:'divSelRoles', title:nPanel+'.- Selecci&oacute;n de roles participantes'});
    nPanel++;
    arrPaneles.push(	{
    						id:'tab'+nPanel,
                            height:450,
                            title:nPanel+'.- Configuraci&oacute;n de Notificaciones',
                            listeners:	{
                                            activate:function(p)
                                                    {
                                                        
                                                        if(!p.activado)
                                                        {
                                                            p.activado=true;
                                                            gEx('gNotificaciones').getView().refresh();
                                                        }  
                                                    }
                                        },
                            items:	[
                            			crearGridNotificaciones()
                                     ]
                         }
                    );
    nPanel++;  
    /*arrPaneles.push({id:'tab'+nPanel,contentEl:'divComites', title:nPanel+'.- Configuraci&oacute;n de comit&eacute;s'});
    nPanel++;  */  
   	
    arrPaneles.push(	
    
    					{
                        	
                        	xtype:'panel',
                            border:false,
                            id:'panel_'+nPanel,
                            title:nPanel+'.- Configuraci&oacute;n de escenario',
                            listeners:	{
                            				activate:function(p)
                                            		{
                                                    	if(!p.activado)
                                                        {
                                                        	var arrId=p.id.split('_');
                                                            
                                                        	gEx('tab'+arrId[1]).load(
                                                                                        {
                                                                                            url:'../modeloPerfiles/configuracionEscenario.php',
                                                                                            params:	{
                                                                                                        idProceso:+iP,
                                                                                                        cPagina:'sFrm=true|gConfS=true',
                                                                                                        scripts:true
                                                                                                     }
                                                                                        }
                                                                                    )
                                                        	p.activado=true;
                                                        }
                                                    }
                            			},
                            items:	[
                            			new Ext.ux.IFrameComponent({ 
                
                                                                        id: 'tab'+nPanel, 
                                                                        anchor:'100% 100%',
                                                                        loadFuncion:function(iFrame)
                                                                                    {
                                                                                        window.scrollTo(0,0);
                                                                                        autofitIframe(iFrame);
                                                                                    },

                                                                        url: '../paginasFunciones/white.php',
                                                                        style: 'width:100%;height:100%' 
                                                                })
                                       /* {
                                            id:'tab'+nPanel,
                                            xtype:'panel',
                                            border:false,
                                            
                                            autoLoad:	{
                                                            url:'../modeloPerfiles/configuracionEscenario.php',
                                                            params:	{
                                                                        idProceso:+iP,
                                                                        cPagina:'sFrm=true|gConfS=true',
                                                                        scripts:true
                                                                     }
                                                        }
                                            
                                        }*/
                                    ]
						}                                    
                   );
	nPanel++; 
    
    
 /*   arrPaneles.push({id:'tab'+nPanel,contentEl:'divConfParticipantes', title:nPanel+'.- Selecci&oacute;n de permisos de participantes'});
    nPanel++;*/

    arrPaneles.push(crearGridHASHRegistro());
    nPanel++; 
    
    var tabs = new Ext.TabPanel	(
                                      {
                                      	  id:'tabPanel',
                                          enableTabScroll:true,
                                          renderTo: 'divPanel',
                                          activeTab: 0,
                                          width:980,
                                          listeners:	{
                                          					tabchange:function(tp,panel)
                                                            		{
                                                                    	switch(panel.id)
                                                                        {
                                                                        	case 'tab2':
                                                                            	gEx('gridComitesAsoc').getView().refresh();
                                                                            break;
                                                                        }
                                                                    	
                                                                    }
                                          				},
                                          autoScroll:true,
                                          autoHeight:true,
                                          padding:1,
                                          items:arrPaneles	
                                      }
                                  );
	         
	generarArbolComites();  
    crearGridComites();
    crearArbolRoles();
    generarArbolPartipantes();
    gEx('tArbol').setActiveTab(1);
    gEx('tArbol').hideTabStripItem(0);
    
}

function crearGridHASHRegistro()
{
	var lector= new Ext.data.JsonReader({
                                            
                                            totalProperty:'numReg',
                                            fields: [
                                               			{name:'nombreCampo'},
                                                        {name:'tipoDato'},
                                                        {name: 'esCampoDefault'},
                                                        {name: 'campoHash'}
                                            		],
                                            root:'registros'
                                            
                                        }
                                      );
	 
                                                                                      
	var alDatos=new Ext.data.GroupingStore({
                                                            reader: lector,
                                                            proxy : new Ext.data.HttpProxy	(

                                                                                              {

                                                                                                  url: '../paginasFunciones/funcionesProyectos.php'

                                                                                              }

                                                                                          ),
                                                            
                                                            remoteGroup:false,
				                                            remoteSort: false,
                                                            autoLoad:true
                                                            
                                                        }) 
	alDatos.on('beforeload',function(proxy)
    								{
                                    	proxy.baseParams.funcion='362';
                                        proxy.baseParams.idProceso=gE('idDocumento').value;
                                        
                                    }
                        )   
       
       
	var checkColumn = new Ext.grid.CheckColumn	(
	 												{
													   header: 'Considerar HASH',
													   dataIndex: 'campoHash',
													   width: 120
													}
												);
                                                       
    var cModelo= new Ext.grid.ColumnModel   	(
                                                    [
                                                        new  Ext.grid.RowNumberer(),
                                                        
                                                        {
                                                            header:'Campo de Formulario',
                                                            width:200,
                                                            sortable:true,
                                                            dataIndex:'nombreCampo',
                                                            renderer:function(val,meta,registro)
                                                            		{
                                                                    	var color='000';
                                                                        if(registro.data.esCampoDefault=='1')
                                                                        {
                                                                        	color='900';
                                                                        }
                                                                    	return '<span style="color:#'+color+'">'+val+'</span>';
                                                                    }
                                                        },
                                                        {
                                                            header:'Tipo de dato',
                                                            width:150,
                                                            sortable:true,
                                                            dataIndex:'tipoDato'
                                                        },
                                                        checkColumn
                                                        
                                                    ]
                                                );
                                                    
    var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gCamposTablero',
                                                            store:alDatos,
                                                            frame:false,
                                                            region:'center',
                                                           	border:true,
                                                            height:400,
                                                            title:'Campos HASH',
                                                            cm: cModelo,
                                                            clicksToEdit:1,
                                                            stripeRows :true,
                                                            loadMask:true,
                                                            plugins:[checkColumn],
                                                            columnLines : true, 
                                                            tbar: 	[
                                                            			{
                                                                        	xtype:'label',
                                                                            html:'Minutos de Diferencia (0 para ignorar):&nbsp;&nbsp;'
                                                                        },
                                                                        {
                                                                        	xtype:'numberfield',
                                                                            width:50,
                                                                            id:'minutosDiferencia',
                                                                            value:gE('hashDiferenciaTiempo').value,
                                                                            allowDecimals:false,
                                                                            allowNegative:false
                                                                        },'-',
                                                            			{
                                                                        	icon:'../images/guardar.PNG',
                                                                            cls:'x-btn-text-icon',
                                                                            text:'Guardar',
                                                                            handler:function()
                                                                            		{
                                                                                    	var fila;
                                                                                        var x;
                                                                                        var arrRegistros='';
                                                                                        var o='';
                                                                                    	for(x=0;x<gEx('gCamposTablero').getStore().getCount();x++)
                                                                                        {
                                                                                        	fila=gEx('gCamposTablero').getStore().getAt(x);
                                                                                            
                                                                                            if(fila.data.campoHash)
                                                                                            {
                                                                                            	o='{"campo":"'+fila.data.nombreCampo+'"}';
                                                                                                if(arrRegistros=='')
                                                                                                	arrRegistros=o;
                                                                                                else  
                                                                                                	arrRegistros+=','+o;                                                                                          }
                                                                                            
                                                                                        }
                                                                                        
                                                                                        
                                                                                        var cadObj='{"minutosDiferencia":"'+(gEx('minutosDiferencia').getValue()==''?'0':gEx('minutosDiferencia').getValue())+
                                                                                        			'","idProceso":"'+gE('idDocumento').value+'","arrRegistros":['+arrRegistros+']}';
                                                                                    
                                                                                    	function funcAjax()
                                                                                        {
                                                                                            var resp=peticion_http.responseText;
                                                                                            arrResp=resp.split('|');
                                                                                            if(arrResp[0]=='1')
                                                                                            {
                                                                                            	msgBox('La Informaci&oacute;n ha sido almacenada correctamente');    
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                            }
                                                                                        }
                                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=363&cadObj='+cadObj,true);
                                                                                    
                                                                                    }
                                                                            
                                                                        }
                                                            		],
                                                            view:new Ext.grid.GroupingView({
                                                                                                forceFit:false,
                                                                                                showGroupName: false,
                                                                                                enableGrouping :false,
                                                                                                enableNoGroups:false,
                                                                                                enableGroupingMenu:false,
                                                                                                hideGroupedColumn: false,
                                                                                                startCollapsed:false
                                                                                            })
                                                        }
                                                    );
	return tblGrid;
}
 
//Funcion para llenar treeview

var panelArbol;
var arbol=Ext.tree;

function cargarConfEscenario(idP)
{
    var iFrame=gE('frameDestino');
    iFrame.src='../modeloPerfiles/configuracionEscenario.php?idProceso='+idP+'&cPagina='+cv('sFrm=true');
}

function cargarConfEscenarioLita(idP)
{
    var iFrame=gE('frameDestinoLita');
    iFrame.src='../modeloPerfiles/configuracionEscenarioLita.php?idProceso='+idP+'&cPagina='+cv('sFrm=true');
}


function recargarArbolSecciones()
{
	gEx('arbolSecciones').getRootNode().reload();
}

function generarArbol(idPadre)
{
	 var cmbOrden=crearComboExt('cmbOrden',[],0,0);
	var idProceso=gE('idDocumento').value;
	var cargadorArbol=new Ext.tree.TreeLoader(
												{
                                                	autoLoad:false,
													baseParams:{
																	funcion:'22',
																	idProyecto:idProceso
																},
													dataUrl:'../paginasFunciones/funcionesProyectos.php'
												}
											)	
    
    cargadorArbol.on('beforeload',function(proxy)
    							{
    								gEx('btnOpcionesControl').disable();
                                }
    				)
                    
	               
                    
    var raiz=new  Ext.tree.AsyncTreeNode	(
                                                  {
                                                      id:idPadre,
                                                      text:'<?php echo uEJ($nombreFormulario) ?>',
                                                      draggable:false,
                                                      tipo:0,
                                                      orden:0,
                                                      idFormulario:'<?php echo $idFormulario?>',
                                                      expanded :true,
                                                      icon:'../images/Icono_txt.gif'
                                                  }
                                            )
	
	panelArbol=new Ext.ux.tree.EditorGrid	(
                                              {
                                              	  id:'arbolSecciones',
												  height:450,
                                                  width:700,
                                                  enableSort:false,
                                                  loadMask: {msg: 'Cargando...' },
                                                  enableHdMenu:false,
                                                  columns:	[
                                                                  {
                                                                      header:'Formulario',
                                                                      width:300,
                                                                      dataIndex:'text'
                                                                  },
                                                                  {
                                                                      header:'Orden',
                                                                      width:50,
                                                                      sortable:false,
                                                                      dataIndex:'orden',
                                                                      editor:cmbOrden
                                                                  },
                                                                  {
                                                                      header:'No. etapa',
                                                                      width:70,
                                                                      sortable:false,
                                                                      dataIndex:'noEtapa'
                                                                  },
                                                                  {
                                                                      header:'Obligatorio',
                                                                      width:85,
                                                                      align:'center',
                                                                      dataIndex:'obl'
                                                                  },
                                                                  {
                                                                      header:'Funci&oacute;n de visualizaci&oacute;n',
                                                                      width:200,
                                                                      dataIndex:'lblFuncionVisualizacion'
                                                                  },
                                                                  {
                                                                      header:'Funci&oacute;n de edici&oacute;n',
                                                                      width:200,
                                                                      dataIndex:'lblFuncionEdicion'
                                                                  }
                                                              ],
                                                  loader: cargadorArbol,
                                                  tbar:	[
                                                  			{
                                                            	text:'Elementos DTD',
                                                                menu:	[
                                                                			{
                                                                                text:'Agregar elemento',
                                                                                icon:'../images/add.png',
                                                                                cls:'x-btn-text-icon',
                                                                                handler:function()
                                                                                        {
                                                                                            agregarElemento();
                                                                                        }
                                                                            },
                                                                            {
                                                                                text:'Remover elemento',
                                                                                icon:'../images/delete.png',
                                                                                cls:'x-btn-text-icon',
                                                                                handler:function()
                                                                                        {
                                                                                            quitarElemento();
                                                                                        }
                                                                            },
                                                          
                                                                            {
                                                                                id:'btnNOObligatorio',
                                                                                text:'Marcar elemento como <font color="red"><b>NO</b></font> obligatorio',
                                                                                icon:'../images/update_nw.gif',
                                                                                cls:'x-btn-text-icon',
                                                                                hidden:true,
                                                                                handler:function()
                                                                                        {
                                                                                            cambiarCondicionElemento(0);
                                                                                        }
                                                                            },
                                                                            {
                                                                                id:'btnObligatorio',
                                                                                text:'Marcar elemento como Obligatorio',
                                                                                icon:'../images/update_nw.gif',
                                                                                cls:'x-btn-text-icon',
                                                                                hidden:true,
                                                                                handler:function()
                                                                                        {
                                                                                            cambiarCondicionElemento(1);
                                                                                        }
                                                                            },
                                                                            
                                                                            {
                                                                            	id:'btnOpcionesControl',
                                                                                text:'Opciones de control',
                                                                                disabled:true,
                                                                                icon:'../images/process_accept.png',
                                                                                handler:function()
                                                                                        {
                                                                                        	mostrarVentanaOpcionesControl();
                                                                                        }
                                                                            }
                                                                		]
                                                            }
                                                  			
                                                  			,
                                                            {
                                                            	id:'btnConfModulo',
                                                            	text:'Modificar configuraci&oacute;n del m&oacute;dulo',
                                                                icon:'../images/cog.png',
																cls:'x-btn-text-icon',
                                                                hidden:true,
                                                                handler:function()
                                                                        {
                                                                        	if((nodoSel.attributes.conf)&&(nodoSel.attributes.conf!=''))
                                                                            {
                                                                                var objConf={};
                                                                                objConf.ancho='100%';
                                                                                objConf.alto='100%';
                                                                                objConf.url=nodoSel.attributes.conf;
                                                                                objConf.params=[['idFormularioProceso',nodoSel.attributes.idFormulario],['idProceso',idProceso],['cPagina','sFrm=true']];
                                                                                abrirVentanaFancy(objConf);
                                                                            }
                                                                            else
                                                                            {
                                                                                function funcAjax()
                                                                                {
                                                                                    var resp=peticion_http.responseText;
                                                                                    arrResp=resp.split('|');
                                                                                    if(arrResp[0]=='1')
                                                                                    {
                                                                                        var conf=null;
                                                                                        var arrConf=eval(arrResp[1]);
                                                                                        if(arrConf.length>0)
                                                                                            conf=arrConf[0];
                                                                                        mostrarVentanaConfiguracionModulo(conf);
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                    }
                                                                                }
                                                                                obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=323&idModulo='+nodoSel.attributes.idModulo+'&idProceso='+gE('idProceso').value,true);					
																			}

                                                                        	
                                                                        }
                                                            },
                                                            {
                                                                icon:'../images/mas.gif',
                                                                cls:'x-btn-text-icon',
                                                                text:'Administrar secciones',
                                                                hidden:true,
                                                                handler:function()
                                                                        {
                                                                        	mostrarVentanaSecciones();
                                                                        }
                                                            }
                                                            
                                                            
                                                           
                                                  		]
                                              }
                                          );                                                 	  
      
      //raiz.expand();

      panelArbol.on('beforeedit',function(e)
      							{
                                	var numHijos=gEx('arbolSecciones').getRootNode().childNodes[0].childNodes.length;
                                    var arrElementos=[];
                                    var ct;
                                    for(ct=1;ct<=numHijos;ct++)
                                    {
                                    	arrElementos.push([ct,ct]);
                                   	}
                                    gEx('cmbOrden').getStore().loadData(arrElementos);

                                }
                   ) 
      panelArbol.on('afteredit',function(e)
      							{
                                	var idElemento=e.node.id;
                                	switch(e.field)
                                    {
                                    	case 'orden':
                                        	var cadObj='{"idProceso":"'+gE('idProceso').value+'","idElemento":"'+idElemento+'","orden":"'+e.value+'"}';
                                        	function funcAjax2()
                                            {
                                                var resp=peticion_http.responseText;
                                                arrResp=resp.split('|');
                                                if(arrResp[0]=='1')
                                                {
                                                    gEx('arbolSecciones').getRootNode().reload();
                                                }
                                                else
                                                {
                                                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                }
                                            }
                                            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax2, 'POST','funcion=342&cadObj='+cadObj,true);	
                                        
                                        
                                        break;
                                        case 'noEtapa':
                                        	var cadObj='{"idElemento":"'+idElemento+'","noEtapa":"'+e.value+'"}';
                                        	function funcAjax()
                                            {
                                                var resp=peticion_http.responseText;
                                                arrResp=resp.split('|');
                                                if(arrResp[0]=='1')
                                                {
                                                    
                                                }
                                                else
                                                {
                                                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                }
                                            }
                                            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=341&cadObj='+cadObj,true);

                                        break;
                                    }
                                }
      				)
      
      
      panelArbol.expandAll();
      panelArbol.on('click',funcClikArbol);
      panelArbol.on('movenode',funcNodoMovido);
      return panelArbol;
     
}

function cambiarCondicionElemento(obligatorio)
{
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	gEx('btnObligatorio').hide();
            gEx('btnNOObligatorio').hide();
            Ext.getCmp('arbolSecciones').getRootNode().reload();
            
            nodoSel=null;
            
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=36&idElemento='+nodoSel.id+'&obligatorio='+obligatorio,true);
}

function funcClikArbol(nodo, evento)
{
	
	nodoSel=nodo;
    gEx('btnOpcionesControl').disable();
	if(!nodoSel.isRoot)
    	gEx('btnOpcionesControl').enable();
    if(nodoSel.attributes.obligatorio!=undefined)
    {
    	if(nodoSel.attributes.obligatorio=='1')
        {
        	Ext.getCmp('btnObligatorio').hide();   	
     		Ext.getCmp('btnNOObligatorio').show();
        }
        else
        {
        	Ext.getCmp('btnNOObligatorio').hide(); 
     		Ext.getCmp('btnObligatorio').show();
        }
    }
    else
    {
        Ext.getCmp('btnNOObligatorio').hide();
        Ext.getCmp('btnObligatorio').hide();   	
   }
   
  // alert(nodoSel.attributes.tipo);
   
		
   var idModulo=parseInt(nodoSel.attributes.idModulo);
  
   
   if((!nodoSel.attributes.conf)||(nodoSel.attributes.conf==''))
   {
       switch(idModulo)
       {
       
            case 9:
            case 3:
            case 11:            
                Ext.getCmp('btnConfModulo').show();
            break;
            default:
                if(idModulo<0)
                    Ext.getCmp('btnConfModulo').show();
                else
                    Ext.getCmp('btnConfModulo').hide();
            break;
       }
	}
    else
    {
    	
        Ext.getCmp('btnConfModulo').show();
    }   
   
   
   
}

function funcNodoMovido(arbol,nodo,padreAnt,PadreAct,posicion)
{
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=13&idElemento='+nodo.id+'&posicion='+posicion,true);
}

function agregarElemento()
{
	var arbolSecciones=Ext.getCmp('arbolSecciones');
	var nodo=arbolSecciones.getRootNode();
	mostrarmenuAgregar(nodo);
    return;
}

function mostrarVentanaConfiguracionModulo(conf)
{
	
    switch(parseInt(nodoSel.attributes.idModulo))
    {
        case 3:
            vConfiguracionAutores(nodoSel.attributes.id);
        break;
        case 9:
        	mostrarVentanaConfiguracionPrespuesto();
        	//mostrarVentanaObjetosGasto();
        break;
        case 11: //fechas convocatorias
        	mostrarVentanaConfFechas(conf);
        break;
        case 12: //datos complementarios
        	mostrarVentanaConfDatosComplementarios();
        break;
        default:
        	if(parseInt(nodoSel.attributes.idModulo)<0)
	  	    	vConfigurarModuloProceso();
        break;
    }
    
    
}

function vConfiguracionAutores(idModulo)
{
	var externo=0;
    var perfil=-1;
    var participacion=-1;
    var singular='Autor';
    var plural='Autores';
    var tituloModulo=nodoSel.attributes.tituloO;
    var responsable='Responsable registro';
    var mOrden='1';
    var mCResp='1';
    var mAfil='1';
    var listRoles=eval(bD(nodoSel.attributes.arrRoles));
    var cadConf=nodoSel.attributes.objConf;
    var objConf=null;

    if((cadConf!='')&&(cadConf!=null))
    	objConf=eval('['+bD(cadConf)+']')[0];
      
	if(nodoSel.attributes.complementario!='')
    {
    	var arrValores=nodoSel.attributes.complementario.split(',');
        if(arrValores.length>0)
        	perfil=arrValores[0];
        if(arrValores.length>1)
        	participacion=arrValores[1];
        if(arrValores.length>2)
	        externo=arrValores[2];	
        if(arrValores.length>3)
	        singular=arrValores[3];
        if(arrValores.length>4)
	        plural=arrValores[4];
        if(arrValores.length>5)
	        responsable=arrValores[5];
        if(arrValores.length>6)
	        mOrden=arrValores[6];
        if(arrValores.length>7)
	        mCResp=arrValores[7];
        if(arrValores.length>8)
	        mAfil=arrValores[8];
    }
	var arrEsquemas=[];
	var cmbEsquema=crearComboExt('cmbEsquema',arrEsquemas,150,60);
	cmbEsquema.setWidth(300);
    cmbEsquema.on('select',selectChange)
    if(perfil!=-1)
    	cmbEsquema.setValue(perfil);
    var cmbParticipacionP=crearComboExt('cmbParticipacionP',[],150,245);
    var gridElementos=crearGridElementos();
    
    var cmbExternos=crearComboExt('cmbExternos',arrSiNo,450,275);
    cmbExternos.setWidth(120);
    cmbExternos.setValue(externo);
    var cmbMostrarOrden=crearComboExt('cmbMostrarOrden',arrSiNo,350,400);
    cmbMostrarOrden.setValue(mOrden);
    cmbMostrarOrden.setWidth(120);
    var cmbMostrarResp=crearComboExt('cmbMostrarResp',arrSiNo,350,425);
    cmbMostrarResp.setValue(mCResp);
    cmbMostrarResp.setWidth(120);
    var cmbMostrarAfiliacion=crearComboExt('cmbMostrarAfiliacion',arrSiNo,350,450);
    cmbMostrarAfiliacion.setValue(mAfil);
    cmbMostrarAfiliacion.setWidth(120);
	var cmbSiNo=crearComboExt('cmbSiNo',arrSiNo,130,220);
    cmbSiNo.setValue('0');
    cmbSiNo.setWidth(115);
    
    
    
    
    var cmbSinoMas1Participacion=crearComboExt('cmbSinoMas1Participacion',arrSiNo,285,250);
    cmbSinoMas1Participacion.setWidth(115);
    var funcionAgregar='';
    var funcionRemover='';
    var arrFormato=[['1','Nombre - Ap. Paterno - Ap. Materno'],['2','Ap. Paterno - Ap. Materno - Nombre']];
    var cmbFormatoUsuario=crearComboExt('cmbFormatoUsuario',arrFormato,250,340,350);
    var arrOrdenUsr=[['1','Nombre'],['2','Ap. Paterno'],['3','Ap. Materno'],['4','Participacion - Nombre'],['5','Participacion - Ap. Paterno'],['6','Participacion - Ap. Materno']];
    var cmbOrdenUsuario=crearComboExt('cmbOrdenUsuario',arrOrdenUsr,250,370);
    
    var cmbMostrarEmail=crearComboExt('cmbMostrarEmail',arrSiNo,250,400);
    cmbMostrarEmail.setValue('0');
    cmbMostrarEmail.setWidth(115);
    
    var cmbMostrarTel=crearComboExt('cmbMostrarTel',arrSiNo,250,430);
    cmbMostrarTel.setValue('0');
    cmbMostrarTel.setWidth(115);
    
    if(objConf==null)
    {
    	cmbFormatoUsuario.setValue('1');
        cmbOrdenUsuario.setValue('1');
	    cmbSinoMas1Participacion.setValue('0');
    }
    else
    {	
    	cmbFormatoUsuario.setValue(objConf.formatoUsuario);
        cmbOrdenUsuario.setValue(objConf.ordenUsuario);
    	cmbSinoMas1Participacion.setValue(objConf.mas1Participacion);
        funcionAgregar=objConf.funcionAgregar;
        funcionRemover=objConf.funcionRemover;
        
        if(objConf.mostrarMail!=undefined)
            cmbMostrarEmail.setValue(objConf.mostrarMail);
        if(objConf.mostrarMail!=undefined)
            cmbMostrarTel.setValue(objConf.mostrarTel);
        
    }
    
    
    cmbSiNo.on('select',function(combo,registro)
    					{
                        	var lblConfiguraFormulario=gEx('lblConfiguraFormulario');
                        	if(registro.get('id')=='0')
                            	lblConfiguraFormulario.hide();
                            else
                            {
                            	if(gEx('ventanaAM').tieneForm)
                                	lblConfiguraFormulario.show();
                                else
                                	lblConfiguraFormulario.hide();
                            	
                            }
                        }
    			)
                
	
                
    var lblConfFrm='Para configurar el formulario de evaluaci&oacute;n de click <a href="javascript:mostrarFormulario(\'@param\')"><span class="letraRoja">AQU&Iacute;</span></a>';
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:0,
                                                            y:0,
                                                            id:'tab1',
                                                        	xtype:'tabpanel',
                                                            baseCls: 'x-plain',
                                                            height:580,
                                                            activeTab: 1,
                                                            items:	[
                                                            			{
                                                                        	xtype:'panel',
                                                                            baseCls: 'x-plain',
                                                                            title:'Configuraci&oacute;n b&aacute;sica',
                                                                            layout:'absolute',
                                                                            defaultType: 'label',
                                                                            height:550,
                                                                            items:[
                                                                                        {
                                                                                            html:'Este m&oacute;dulo requiere indique el tipo de esquema de participaci&oacute;n que utilizar&aacute;, por favor elija un esquema.',
                                                                                            x:10,
                                                                                            y:40
                                                                                        },
                                                                                        {
                                                                                            x:10,
                                                                                            y:10,
                                                                                            html:'T&iacute;tulo del m&oacute;dulo: '
                                                                                        },
                                                                                         {
                                                                                            id:'txtTitulo',
                                                                                            xtype:'textfield',
                                                                                            x:150,
                                                                                            y:5,
                                                                                            width:220,
                                                                                            value:tituloModulo
                                                                                        },
                                                                                        {
                                                                                        
                                                                                            html:'Esquema:',
                                                                                            x:10,
                                                                                            y:65
                                                                                        },
                                                                                        cmbEsquema,
                                                                                        gridElementos,
                                                                                        {
                                                                                            html:'Participaci&oacute;n principal:',
                                                                                            y:250,
                                                                                            x:10
                                                                                        },
                                                                                        cmbParticipacionP,
                                                                                        {
                                                                                            x:10,
                                                                                            y:280,
                                                                                            html:'Usuarios externos a la instituci&oacute;n pueden obstentar la participaci&oacute;n principal?'
                                                                                        },
                                                                                        cmbExternos,
                                                                                        {
                                                                                            x:10,
                                                                                            y:310,
                                                                                            html:'Nombre asignado a los usuarios de este m&oacute;dulo: '
                                                                                        },
                                                                                        {
                                                                                            x:290,
                                                                                            y:325,
                                                                                            html:'<b>Singular:</b> '
                                                                                        },
                                                                                        {
                                                                                            id:'txtSingular',
                                                                                            xtype:'textfield',
                                                                                            x:350,
                                                                                            y:320,
                                                                                            value:singular
                                                                                            
                                                                                        },
                                                                                        {
                                                                                            x:290,
                                                                                            y:350,
                                                                                            html:'<b>Plural:</b> '
                                                                                        },
                                                                                        {
                                                                                            id:'txtPlural',
                                                                                            xtype:'textfield',
                                                                                            x:350,
                                                                                            y:345,
                                                                                            value:plural
                                                                                            
                                                                                        },
                                                                                         {
                                                                                            x:10,
                                                                                            y:380,
                                                                                            html:'Nombre asignado al usuario responsable del registro: '
                                                                                        },
                                                                                         {
                                                                                            id:'txtUsuarioResponsable',
                                                                                            xtype:'textfield',
                                                                                            x:350,
                                                                                            y:375,
                                                                                            width:220,
                                                                                            value:responsable
                                                                                        },
                                                                                        
                                                                                        {
                                                                                            x:10,
                                                                                            y:405,
                                                                                            html:'Mostrar orden de participaci&oacute;n:'
                                                                                        },
                                                                                        cmbMostrarOrden,
                                                                                        {
                                                                                            x:10,
                                                                                            y:430,
                                                                                            html:'Mostrar columna de responsable:'
                                                                                        },
                                                                                        cmbMostrarResp,
                                                                                        {
                                                                                            x:10,
                                                                                            y:455,
                                                                                            html:'Mostrar afiliaci&oacute;n:'
                                                                                        },
                                                                                        cmbMostrarAfiliacion
                                                                                  ]
                                                                       },
                                                                       {
                                                                        	xtype:'panel',
                                                                            baseCls: 'x-plain',
                                                                            title:'Reglas de operaci&oacute;n',
                                                                            layout:'absolute',
                                                                            defaultType: 'label',
                                                                            height:550,
                                                                            items:	[
                                                                            			{
                                                                                        	xtype:'label',
                                                                                            html:'Usuarios creados a trav&eacute;s de este m&oacute;dulo se les asignaran los siguientes roles:',
                                                                                            x:10,
                                                                                            y:10
                                                                                        },
                                                                                        {
                                                                                        	xtype:'label',
                                                                                            x:10,
                                                                                            y:35,
                                                                                            html:'<table>'+
                                                                                                 '<tr>'+
                                                                                                        '<td width="20"></td>'+
                                                                                                        '<td>'+
                                                                                                            '<select size="10" style="width:250px" id="listRoles" >'+
                                                                                                            '</select>'+
                                                                                                            '<input type="hidden" name="listadoRoles" id="listadoRoles" value="" />'+
                                                                                                        '</td>'+
                                                                                                        '<td width="10">'+
                                                                                                        '</td>'+
                                                                                                       ' <td valign="top">'+
                                                                                                       '<table>'+
                                                                                                        '<tr>'+
                                                                                                            '<td><a href="javascript:agregarRolModulo()"><img src="../images/accept_green.png" alt="Agregar Rol" title="Agregar Rol"/></a></td>'+
                                                                                                            '<td class="corpo8">&nbsp;&nbsp;<a href="javascript:agregarRolModulo()">Agregar Rol</a></td>'+
                                                                                                        '</tr>'+
                                                                                                        '<tr>'+
                                                                                                            '<td><a href="javascript:removerRolModulo()"><img src="../images/cancel_round.png" alt="Remover Rol" title="Remover Rol"/></a></td>'+
                                                                                                            '<td class="corpo8">&nbsp;&nbsp;<a href="javascript:removerRolModulo()">Remover Rol</a></td>'+
                                                                                                        '</tr>'+
                                                                                                        '</table>'+
                                                                                                        '</td>'+
                                                                                                    '</tr>'+
                                                                                                    '</table>'
                                                                                        },
                                                                                        
                                                                                        {
                                                                                        	x:10,
                                                                                            y:225,
                                                                                            html:'Evaluar a participantes?'
                                                                                        },
                                                                                        cmbSiNo,
                                                                                        {
                                                                                        	x:255,
                                                                                            y:225,
                                                                                        	xtype:'label',
                                                                                            id:'lblConfiguraFormulario',
                                                                                            html:lblConfFrm,
                                                                                            hidden:true
                                                                                        },
                                                                                        {
                                                                                        	x:10,
                                                                                            y:255,
                                                                                            xtype:'label',
                                                                                            html:'Una persona puede obstentar m&aacute;s de una participaci&oacute;n?'
                                                                                        },
                                                                                        cmbSinoMas1Participacion,
                                                                                        {
                                                                                        	x:10,
                                                                                            y:285,
                                                                                            xtype:'label',
                                                                                            html:'Funci&oacute;n a ejecutar al agregar un usuario:'
                                                                                        },
                                                                                        {
                                                                                        	xtype:'textfield',
                                                                                            width:300,
                                                                                            x:250,
                                                                                            y:280,
                                                                                            id:'txtFuncionAgregar',
                                                                                            value:funcionAgregar
                                                                                            
                                                                                        },
                                                                                        {
                                                                                        	x:10,
                                                                                            y:315,
                                                                                            xtype:'label',
                                                                                            html:'Funci&oacute;n a ejecutar al remover un usuario:'
                                                                                        },
                                                                                        {
                                                                                        	xtype:'textfield',
                                                                                            width:300,
                                                                                            x:250,
                                                                                            y:310,
                                                                                            id:'txtFuncionRemover',
                                                                                            value:funcionRemover
                                                                                            
                                                                                        },
                                                                                        {
                                                                                        	x:10,
                                                                                            y:345,
                                                                                            html:'Formato a emplear en nombre de usuario:'
                                                                                        },
                                                                                        cmbFormatoUsuario,
                                                                                         {
                                                                                        	x:10,
                                                                                            y:375,
                                                                                            html:'Ordenar usuarios por:'
                                                                                        },
                                                                                        cmbOrdenUsuario,
                                                                                        {
                                                                                        	x:10,
                                                                                            y:405,
                                                                                            xtype:'label',
                                                                                            html:'Mostrar E-mail de usuario:'
                                                                                        },
                                                                                        cmbMostrarEmail,
                                                                                        {
                                                                                        	x:10,
                                                                                            y:435,
                                                                                            xtype:'label',
                                                                                            html:'Mostrar tel&eacute;fono de usuario:'
                                                                                        },
                                                                                        cmbMostrarTel
                                                                                        
                                                                            		]
                                                                       }
                                                                            
                                                            		]
                                                        }

													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
                                    	id:'ventanaAM',
										title: 'Configuraci&oacute;n de m&oacute;dulo',
										width: 660,
										height:590,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 100,
																fn : function() 
																{
                                                                	
                                                                	llenarCombo(gE('listRoles'),listRoles);
                                                                    gEx('tab1').setActiveTab(0);
                                                                    if(nodoSel.attributes.evaluarParticipante!='')
                                                                    {
                                                                        var arrDatosExtra=nodoSel.attributes.evaluarParticipante.split("|");
                                                                        cmbSiNo.setValue(arrDatosExtra[0]);
                                                                        var cadena=str_replace('@param',bE(arrDatosExtra[1]),lblConfFrm);
                                                                        gEx('lblConfiguraFormulario').setText(cadena,false);
                                                                        gEx('lblConfiguraFormulario').show();
                                                                        ventanaAM.tieneForm=true;  
                                                                    }
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var principal=cmbParticipacionP.getValue();
                                                                        var idPerfil=cmbEsquema.getValue();
                                                                        if(idPerfil=='')
                                                                        {
                                                                        	msgBox('Debe seleccionar el perfil a utilizar en este m&oacute;dulo');
                                                                            return;
                                                                        }
                                                                        if(principal=='')
                                                                        {
                                                                        	msgBox('Debe indicar cual es la participaci&oacute;n principal en este m&oacute;dulo');
                                                                            return;
                                                                        }
                                                                        
                                                                        var txtSingular=Ext.getCmp('txtSingular');
                                                                        if(txtSingular.getValue()=='')
                                                                        {
                                                                        	function respS()
                                                                            {
                                                                            	txtSingular.focus();
                                                                            }
                                                                        	msgBox('Debe ingresar el nombre del usuario en singular',respS);
                                                                        	return;
                                                                        }
                                                                        var txtPlural=Ext.getCmp('txtPlural');
                                                                        if(txtPlural.getValue()=='')
                                                                        {
                                                                        	function respP()
                                                                            {
                                                                            	txtPlural.focus();
                                                                            }
                                                                        	msgBox('Debe ingresar el nombre del usuario en plural',respP);
                                                                        	return;
                                                                        }
                                                                        
                                                                        var externo=cmbExternos.getValue();
                                                                        
                                                                        var idElemento=nodoSel.id;
                                                                        
                                                                        var txtUsuarioResponsable=Ext.getCmp('txtUsuarioResponsable');
                                                                        
                                                                        if(txtUsuarioResponsable.getValue()=='')
                                                                        {
                                                                        	function respT()
                                                                            {
                                                                            	txtUsuarioResponsable.focus();
                                                                            }
                                                                            msgBox('Debe ingresar el titulo asignado al usuario responsable del registro',resT);
                                                                            return;
                                                                        }
                                                                        var txtTitulo=Ext.getCmp('txtTitulo');
                                                                        if(txtTitulo.getValue()=='')
                                                                        {
                                                                        	function respTitulo()
                                                                            {
                                                                            	txtTitulo.focus();
                                                                            }
                                                                            msgBox('Debe ingresar el titulo del m&oacute;dulo',respTitulo);
                                                                            return;
                                                                        }
                                                                        
                                                                        var listRoles=prepararComboRoles();
                                                                        
                                                                        var cadObj='{"mostrarMail":"'+cmbMostrarEmail.getValue()+'","mostrarTel":"'+cmbMostrarTel.getValue()+'","formatoUsuario":"'+cmbFormatoUsuario.getValue()+'","ordenUsuario":"'+cmbOrdenUsuario.getValue()+'","mas1Participacion":"'+cmbSinoMas1Participacion.getValue()+'","funcionAgregar":"'+cv(gEx('txtFuncionAgregar').getValue())+'","funcionRemover":"'+cv(gEx('txtFuncionRemover').getValue())+'"}';
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	Ext.getCmp('arbolSecciones').getRootNode().reload();
                                                                                msgBox('Los datos han sido guardados satisfactoriamente');
                                                                                var idEvaluacion=arrResp[1];
                                                                                if(cmbSiNo.getValue()=='1')
                                                                                {
                                                                                	var leyenda=lblConfFrm;
                                                                                    leyenda=str_replace('@param',bE(arrResp[1]),leyenda);
                                                                                    var lblConfiguraFormulario=gEx('lblConfiguraFormulario');
                                                                                	lblConfiguraFormulario.setText(leyenda,false);
                                                                                    lblConfiguraFormulario.show();
                                                                                    ventanaAM.tieneForm=true;  
                                                                                }
                                                                                else
                                                                                {
                                                                                	gEx('lblConfiguraFormulario').hide();
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        var idProceso=gE('idProceso').value;
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=68&idProceso='+idProceso+'&principal='+principal+'&idPerfil='+idPerfil+'&externo='+externo+'&idElemento='+
                                                                        				idElemento+'&singular='+cv(txtSingular.getValue())+'&plural='+cv(txtPlural.getValue())+'&tituloResp='+cv(txtUsuarioResponsable.getValue())+'&tituloModulo='+cv(txtTitulo.getValue())+
                                                                                        '&idModulo='+nodoSel.id+'&mostrarOrden='+cmbMostrarOrden.getValue()+'&mostrarResp='+cmbMostrarResp.getValue()+'&mostrarAfil='+cmbMostrarAfiliacion.getValue()+
                                                                                        '&listRoles='+listRoles+'&evaluarParticipante='+cmbSiNo.getValue()+'&objConf='+cadObj,true);
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	                          
    if(perfil==-1)
    {
    	ventanaAM.tieneForm=false;  
		ventanaAM.show();
        
    }
    else
    
    	llenarDatosPerfilAutores(ventanaAM,participacion,perfil,listRoles)
}

function prepararComboRoles()
{
	var comboRoles=gE('listRoles');
    var x;
    var roles='';
    
    for(x=0;x<comboRoles.options.length;x++)
    {
    	if(roles=='')
        	roles=comboRoles.options[x].value;
        else
    		roles+=','+comboRoles.options[x].value;
    }
    return roles;
    
}

function selectChange(combo,registro,indice)
{
	var idEsquema=registro.get('id');
    function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var arrDatos=eval(arrResp[1]);
            Ext.getCmp('gridEsquemas').getStore().loadData(arrDatos);
            Ext.getCmp('cmbParticipacionP').getStore().loadData(arrDatos);
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=67&idEsquema='+idEsquema,true);
}

function llenarDatosPerfilAutores(ventanaAM,participacion,perfil,listRoles)
{
	var idEsquema=perfil;
    function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	var arrDatos=eval(arrResp[1]);
            Ext.getCmp('gridEsquemas').getStore().loadData(arrDatos);
            Ext.getCmp('cmbParticipacionP').getStore().loadData(arrDatos);
            Ext.getCmp('cmbParticipacionP').setValue(participacion);
           
            ventanaAM.show();
            
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=67&idEsquema='+idEsquema,true);
}

function crearGridElementos()
{
	dsDatos=[];
    alDatos=	new Ext.data.SimpleStore	(
                                                {
                                                    fields:	[
                                                    			{name:'idElemento'},
                                                    			{name: 'descParticipacion'},
                                                                {name: 'clave'}
                                                                
                                                            ]
                                                }
                                            );

    alDatos.loadData(dsDatos);
	chkRow=new Ext.grid.CheckboxSelectionModel();
	
	var cModelo= new Ext.grid.ColumnModel   	(
												 	[
													 	new  Ext.grid.RowNumberer(),
														{
															header:'Clave',
															width:150,
															sortable:true,
															dataIndex:'clave'
														},
														{
															header:'Participaci&oacute;n',
															width:300,
															sortable:true,
															dataIndex:'descParticipacion'
														}
													]
												);
                                                
	var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gridEsquemas',
                                                            store:alDatos,
                                                            frame:true,
                                                            x:20,
                                                            y:90,
                                                            cm: cModelo,
                                                            height:150,
                                                            width:540,
                                                            sm:chkRow
                                                        }
                                                    );
	return 	tblGrid;	
}

function mostrarmenuAgregar(nodo)
{
	function generarFormAgregar()
	{
		var ctEstandares=0;
		var ctNoEstandares=0;
		var resp=eval(peticion_http.responseText)[0];
        var vModal;
        
		var raiz=new arbol.AsyncTreeNode(
                                            {
                                                id:'raiz',
                                                text:'',
                                                draggable:false,
                                                icon:"../images/s.gif",
                                                children:resp.modulos
                                            }
                                        )
                                        
		var raizNoEstandar=new arbol.AsyncTreeNode	(
                                                        {
                                                            id:'raizNoEstandar',
                                                            text:'',
                                                            draggable:false,
                                                            icon:"../images/s.gif",
                                                            children:resp.formularios
                                                        }
                                                    )
		
		var arbolElemStandard=new Ext.tree.TreePanel	(
															{
																id:'arbolAgregarE',
																title:'',
																rootVisible:false,
																lines:false,
                                                                height:300,
																autoScroll:true,
																root: raiz
															}
														)
		var arbolElemNoEstandar=new Ext.tree.TreePanel	(
															{
																id:'arbolElemNoEstardar',
																title:'',
																rootVisible:false,
																lines:false,
                                                                height:300,
																autoScroll:true,
																root: raizNoEstandar
															}
														)
	
	
		
		var tabs = new Ext.TabPanel	(
										{
											width:500,
                                            height:330,
                                            baseCls: 'x-plain',
											activeTab: 0,
											frame:true,
											border:true,
											items:	[
												
														{
															title:'M&oacute;dulos predefinidos',
                                                            id:'Modulos',
                                                            baseCls: 'x-plain',
                                                            items:
															[
																arbolElemStandard
															]
														},
                                                        {
															title:'Formularios del proceso',
                                                            id:'Formularios',
                                                            baseCls: 'x-plain',
                                                            items:
															[
																arbolElemNoEstandar
															]
														}
                                                        
														
											]
										}
									);
		
        
		var formulario=new Ext.FormPanel	(
												{
													baseCls: 'x-plain',
													layout:'absolute',
													defaultType: 'textfield',
													items: [
																tabs,
                                                                {
                                                                	xtype:'label',
                                                                    x:10,
                                                                    y:335,
                                                                    html:'Si desea agregar un proceso como parte del DTD de click <a href="javascript:agregarProceso()"> <font color="red"><b>AQU&Iacute;</b></font></a>'
                                                                }
															]
												}
											)
		var vModal=new Ext.Window	(
										{
                                        	id:'vAgregarElemento',
											title: '<?php echo $etj["lblTitAddNuevoElem"] ?>',
											width: 530,
											height:440,
											minWidth: 300,
											minHeight: 200,
											layout: 'fit',
											plain:true,
											bodyStyle:'padding:5px;',
											buttonAlign:'center',
											modal:true,
											items:[formulario],
											buttons:	[
															{
																id:'btnAgregar',
																text: '<?php echo $etj["lblBtnAceptar"] ?>',
																handler:	function()
																			{
                                                                                agregarElementosDTD(arbolElemStandard,arbolElemNoEstandar,vModal);
																			}
															},
															{
																id:'btnCancelar',
																text: '<?php echo $etj["lblBtnCancelar"] ?>',
																handler: 	function()
																			{
																				vModal.close();
																			}
															}
														]
										}
									);
		vModal.show();
	}
	obtenerDatosWeb("../paginasFunciones/funcionesProyectos.php",generarFormAgregar,'POST','funcion=2&idProceso=<?php echo $idDocumento ?>',true);

    function agregarElementosDTD(raizModulosP,raizFormProceso,vModal)
    {
    	var elementos='';
        var raiz=raizModulosP.getChecked();
        var raizNoEstandar=raizFormProceso.getChecked();
        for(x=0;x<raiz.length;x++)
        {
            objElemento='{"idModulo":"'+raiz[x].attributes.idModulo+'","tipo":"1","conf":"'+raiz[x].attributes.conf+'"}';
            if(elementos=='')
                elementos=objElemento;
            else
                elementos+=','+objElemento;
        }
        
        for(x=0;x<raizNoEstandar.length;x++)
        {
            objElemento='{"idFormulario":"'+raizNoEstandar[x].attributes.id+'", "tipo":"0"}';
            if(elementos=='')
                elementos=objElemento;
            else
                elementos+=','+objElemento;
        }
        var idProceso=gE('idDocumento').value;
        var obj='{"idProceso":"'+idProceso+'","elementos":['+elementos+']}';    
    	
    	function funcAjax()
        {
            var resp=peticion_http.responseText;
            arrResp=resp.split('|');
            if(arrResp[0]=='1')
            {
            	Ext.getCmp('arbolSecciones').getRootNode().reload();
                vModal.close();		
            }
            else
            {
                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
            }
        }
        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=1&elementosDTD='+obj,true);
    }
}

function quitarElemento()
{
	var arbolSecciones=Ext.getCmp('arbolSecciones');
	var sModel=arbolSecciones.getSelectionModel();
	var nodo=sModel.getSelectedNode();
	if(nodo==null)
	{
		msgBox('<?php echo $etj["lblMsgErrDelElem"]?>');
	}
	else
	{	
		var prof=nodo.getDepth();
		if(prof==0)
		{
			msgBox('<?php echo $etj["lblMsgErrDelRaiz"]?>');
			return;
		}
        
        
        function resp(btn)
        {
        	if(btn=='yes')
            {
                function funcAjax()
                {
                    var resp=peticion_http.responseText;
                    arrResp=resp.split('|');
                    if(arrResp[0]=='1')
                    {
               		 	nodo.remove() ;
                    }
                    else
                    {
                        msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                    }
                }
                obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=14&idElemento='+nodo.id,true);
        	}
		}		 
        Ext.MessageBox.confirm('<?php echo $etj["lblAplicacion"]?>','Est&aacute; seguro de querer eliminar el elemento seleccionado?',resp);
	}
}

var rgIdiomas = Ext.data.Record.create	
(
	[
			{name: 'idioma'},
			{name: 'idIdioma'},
			{name: 'nombreDTD'},
			{name: 'descripcion'},
			{name: 'idDescripcion'}	
	  ]
 );

function llenarDatos(datos)
{
	
	for (x=0;x<datos.length;x++)
	{
		
		var FilaRegistro = new rgIdiomas(
                                            {
                                                    idioma:datos[x].imagen,
                                                    idIdioma: datos[x].idIdioma,
                                                    nombreDTD: datos[x].nombreDTD,
                                                    descripcion: datos[x].descripcion,
													idDescripcion: datos[x].idDescripcion

                                               }
                                          );
                                                  
        alNameDTD.add(FilaRegistro); 
	}
}

function cambiarColor(val)
{
	 return '<img src="../images/banderas/'+val+'" />';
}

function mostrarMenuDTD()
{
	var tablaDatos=[];
	var origenD= new Ext.data.SimpleStore	(
											 	{
													fields:	[
															 	{name:'id'},
																{name:'nombre'},
																{name:'descripcion'}
															]
												}
											)
	origenD.loadData(tablaDatos);	
	cargarDatos(origenD);
	
	var comboDocs=document.createElement('select');
	
	
	var comboDTD=new Ext.form.ComboBox	(
											{
												x:<?php echo $etj["posX"]?>,
												y:5,
												id:'IDcomboDTD',
												mode:'local',
												emptyText:'<?php echo $etj["lblElijaOpcion"]?>',
											   	store:origenD,
												displayField:'nombre',
												valueField:'id',
												transform:comboDocs,
												editable:false,
												typeAhead: true,
												triggerAction: 'all',
												lazyRender:true
												
											}
										)

	var form = new Ext.form.FormPanel(	
										 	{
												baseCls: 'x-plain',
												layout:'absolute',
												defaultType: 'textfield',
												items: 	[
														 	new Ext.form.Label	(
																				 	{
																						x:5,
																						y:10,
																						text:'<?php echo $etj["lblSeleccioneDTD"]?>'
																					}
																				)
															,
															comboDTD
															
															
														]
											}
										);
	
	
	var ventanaElegirDTD = new Ext.Window	(
									{
										title: '<?php echo $etj["lblTituloCNombre"]?>',
										width: <?php echo $etj["ancho"]?>,
										height:150,
										width:370,
										minHeight: 100,
										layout: 'fit',
										plain:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										modal:true,
										items: form,
										buttons:	[
														{
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler:function()
																	{
																		if(comboDTD.getValue()!="")
																		{
																			cambiarTipoDoc(comboDTD.getValue());
																			ventanaElegirDTD.close();
																		}
																		else
																			msgBox('<?php echo $etj["lblDebeElegir"]?>');

																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaElegirDTD.close();
																	}
														}
													]
    								}
								);

    	ventanaElegirDTD.show();
	
}

Registro =Ext.data.Record.create	
(
	[
		{name:'id'},
		{name:'nombre'},
		{name:'descripcion'}
	]
)

function cargarDatos(origen)
{
	obtenerDatosWeb("../paginasFunciones/funcionesRevistaE.php",insertarDatos,'POST','funcion=4',true);
	function insertarDatos()
	{
		var DocXML=peticion_http.responseXML;
		var raiz=DocXML.getElementsByTagName("docXML");
		var nodos=raiz[0].childNodes;
		for(x=0;x<nodos.length;x++)
		{
			var n=nodos[x];
			var r=new Registro	(
									{
										id:n.childNodes[0].firstChild.nodeValue,
										nombre:n.childNodes[1].firstChild.nodeValue
									}
								);
			origen.add(r);
		}
	}
}

function eliminarDTD()
{
	Ext.Msg.confirm('<?php echo $etj["lblTitDelDTD"]?>','<?php echo $etj["lblMsgDelDTD"]?>',funcEliminarDTD);
	function funcEliminarDTD(btn)
	{
		if(btn=='yes')
		{
			
			function respEliminacion()
			{
				var resp=peticion_http.responseText;
				if(resp=='OK')
					window.location='tblDTD.php';
				else
				{
					msgBox('<?php echo $etj["lblErrorDel"]?> '+resp);
				
				}
			}
			obtenerDatosWeb("../paginasFunciones/guardarXML.php",respEliminacion,'POST','accion=5',true);
		}
	}
}

function enviarCuestionarioEvaluacion()
{
	var idDocumento=gE('idDocumento').value;
	var arrParam=[['idDTD',idDocumento]];
    enviarFormularioDatos('../modeloProyectos/tblCuestionario.php',arrParam);
}

var regComite = Ext.data.Record.create	
(
	[
			{name: 'idComite'},
			{name: 'comite'}
	]
);

function agregarComite()
{
    var gridComites=crearGridComitesParticipantes('cmbComitesDisponibles');
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Seleccione los comit&eacute;s que desee incluir en la etapa seleccionada:'
                                                        },
														gridComites
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Agregar comit&eacute; a etapa seleccionada',
										width: 510,
										height:400,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var filas=gridComites.getSelectionModel().getSelections();
                                                                        if(filas.length==0)
                                                                        {
                                                                        	msgBox('Al meno debe seleccionar un comit&eacute; a agregar');
                                                                            return;
                                                                        }
                                                                        var x;
                                                                        var comites='';
                                                                        for(x=0;x<filas.length;x++)
                                                                        {
                                                                        	if(comites=='')
                                                                            	comites=filas[x].get('idComite');
                                                                            else
                                                                            	comites+=','+filas[x].get('idComite');
                                                                        }
                                                                        
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                                Ext.getCmp('arbolComites').getRootNode().reload();
                                                                                Ext.getCmp('arbolComites').expandAll();
                                                                                ventanaAM.close();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=16&idProyecto='+idProceso+'&comites='+comites+'&numEtapa='+nodoSelComite.attributes.numEtapa,true);
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	                              
	llenarDatosComites(ventanaAM,gridComites.getStore());
}

function llenarDatosComites(ventanaAM,almacen)
{
	var idProyecto=gE('idDocumento').value;	
	function funcAjax()
	{
		var resp=peticion_http.responseText;
		arrResp=resp.split('|');
		if(arrResp[0]=='1')
		{
			almacen.loadData(eval(arrResp[1]));
		}
		else
		{
			msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
		}
	}
	obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=12&idProyecto='+idProyecto+'&numEtapa='+nodoSelComite.attributes.numEtapa,true);
	ventanaAM.show();
}

function nodoCheck(nodo, estado)
{
	if(estado)
	{

		var arrFunciones=[['0','S\u00F3lo ver'],['1','Ver y dictaminar']];
		var funcionesC=crearComboExt('cmbFuncionesC',arrFunciones,365,5);
		funcionesC.setValue('0');
		funcionesC.setWidth(130);
		
		var form = new Ext.form.FormPanel(	
											{
												baseCls: 'x-plain',
												layout:'absolute',
												defaultType: 'textfield',
												items: 	[
															{
																x:10,
																y:10,
																xtype:'label',
																html:'Las funciones que el comite tendr&aacute; sobre dicho elemento son:'
															},
															funcionesC														
														]
											}
										);
		
		var ventanaAM = new Ext.Window(
										{
											title: 'Agregar comit&eacute;',
											width: 550,
											height:150,
											
											layout: 'fit',
											plain:true,
											modal:true,
											bodyStyle:'padding:5px;',
											buttonAlign:'center',
											items: form,
											listeners : {
														show : {
																	buffer : 10,
																	fn : function() 
																	{
																	}
																}
													},
											buttons:	[
															{
																id:'btnAceptar',
																text: '<?php echo $etj["lblBtnAceptar"]?>',
																handler: function()
																		{
																			var funciones=funcionesC.getValue();
																			nodo.attributes.funciones=funciones;
																			nodo.setText(nodo.attributes.tituloO+' (<font color="blue"><b>Funciones:</b></font> '+funcionesC.getRawValue()+')');
																			ventanaAM.close();
																		}
															},
															{
																text: '<?php echo $etj["lblBtnCancelar"]?>',
																handler:function()
																		{
																			ventanaAM.close();
																		}
															}
														]
										}
									);
		ventanaAM.show();			
	}
	else
	{
		nodo.setText(nodo.attributes.tituloO);
		nodo.attributes.funciones='';
	}		
}



function crearGridComites()
{
	
	var cmbSiNo=crearComboExt('cmbSiNo',arrSiNo);
	
	dsNameDTD=<?php echo $arrComites ?>;
    alNameDTD=	new Ext.data.SimpleStore	(
                                                {
                                                    fields:	[
                                                                {name: 'idProyectoVSComite'},
                                                                {name: 'idComite'},
                                                                {name: 'comite'},
                                                                {name: 'agregarFrm'}
                                                            ]
                                                }
                                            );

    alNameDTD.loadData(dsNameDTD);
	chkRow=new Ext.grid.CheckboxSelectionModel();
	
	var cmComites= new Ext.grid.ColumnModel   	(
												 	[
													 	new  Ext.grid.RowNumberer(),
														chkRow,
														{
															header:'Comite',
															width:320,
															sortable:true,
															dataIndex:'comite'
														},
														{
															header:'&iquest;Puede agregar formularios?',
															width:180,
															sortable:true,
															dataIndex:'agregarFrm',
                                                            editor:cmbSiNo,
                                                            renderer:funcRenderizar,
                                                            hidden:true
														}
													]
												);
                                                
	var tblComites=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:'gridComitesAsoc',
                                                            store:alNameDTD,
                                                            frame:false,
                                                            cm: cmComites,
                                                            height:350,
                                                            width:600,
                                                            sm:chkRow,
                                                            clicksToEdit:1,
                                                            renderTo:'tblComitesParticipantes',
                                                            tbar:	[
                                                            			{
                                                                        	text:'Agregar comit&eacute;',
                                                                            icon:'../images/add.png',
																			cls:'x-btn-text-icon',
                                                                            handler:function()
                                                                            		{
                                                                                    	mostrarVentanaAgregarComiteParticipante();
                                                                                    }
                                                                        },'-',
                                                                        {
                                                                        	text:'Remover comit&eacute;',
                                                                            icon:'../images/delete.png',
																			cls:'x-btn-text-icon',
                                                                            handler:function()
                                                                            		{
                                                                                    	var filas=tblComites.getSelectionModel().getSelections();
                                                                                        if(filas.length==0)
                                                                                        {
                                                                                        	msgBox('Debe seleccionar al menos un comit&eacute; para eliminar');
                                                                                            return;
                                                                                        }
                                                                                       
                                                                                       function resp(btn)
                                                                                       {
                                                                                            if(btn=='yes')
                                                                                            {
                                                                                            	var comites='';
                                                                                                var x;
                                                                                                for(x=0;x<filas.length;x++)
                                                                                                {
                                                                                                	if(comites=='')
                                                                                                    	comites=filas[x].get('idProyectoVSComite');
                                                                                                    else
                                                                                                    	comites+=','+filas[x].get('idProyectoVSComite');
                                                                                                }
                                                                                            	function funcAjax()
                                                                                                {
                                                                                                    var resp=peticion_http.responseText;
                                                                                                    arrResp=resp.split('|');
                                                                                                    if(arrResp[0]=='1')
                                                                                                    {
                                                                                                    	tblComites.getStore().remove(filas);
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                                    }
                                                                                                }
                                                                                                obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=34&comites='+comites,true);

                                                                                            	
                                                                                            }
                                                                                       }
                                                                                       Ext.MessageBox.confirm('<?php echo $etj["lblAplicacion"]?>','Est&aacute; seguro de querer eliminar los registros seleccionados?',resp);
                                                                                    }
                                                                        }
                                                            		]
                                                        }
                                                    );
	tblComites.on('afteredit',funcEditado);                                                    
									
}

function funcEditado(e)
{
	var idProyectoVSComite=e.record.get('idProyectoVSComite');
    var valor=e.value;
    function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=35&idProyectoVSComite='+idProyectoVSComite+'&valor='+valor,true);

}

function funcRenderizar(val)
{
	var pos=existeValorMatriz(arrSiNo,val,0);
    
	return arrSiNo[pos][1];
}

function mostrarVentanaAgregarComiteParticipante()
{
	var gridComites=crearGridComitesParticipantes();
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Seleccione los comit&eacute;s que desee incluir en el proceso:'
                                                        },
														gridComites
													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Agregar comit&eacute; participante',
										width: 420,
										height:400,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var filas=gridComites.getSelectionModel().getSelections();
                                                                        if(filas.length==0)
                                                                        {
                                                                        	msgBox('Al meno debe seleccionar un comit&eacute; a agregar');
                                                                            return;
                                                                        }
                                                                        var x;
                                                                        var comites='';
                                                                        for(x=0;x<filas.length;x++)
                                                                        {
                                                                        	if(comites=='')
                                                                            	comites=filas[x].get('idComite');
                                                                            else
                                                                            	comites+=','+filas[x].get('idComite');
                                                                        }
                                                                        
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	Ext.getCmp('gridComitesAsoc').getStore().loadData(eval(arrResp[1]));
                                                                                ventanaAM.close();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=33&idProyecto='+idProceso+'&comites='+comites,true);

                                                                        
                                                                        
                                                                        
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	llenarComitesDisponibles(ventanaAM,gridComites.getStore());                                
	
}

function llenarComitesDisponibles(ventanaAM,almacen)
{
    function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	almacen.loadData(eval(arrResp[1]));	
            ventanaAM.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=32&idProyecto='+idProceso,true);
}

function crearGridComitesParticipantes(idGridComite)
{
	var idGrid='idGridP';
	if(idGridComite!=undefined)
    	idGrid=idGridComite;
      
	dsDatos=[];
    alDatos=	new Ext.data.SimpleStore	(
                                                {
                                                    fields:	[
                                                                {name: 'idComite'},
                                                                {name: 'nombreComite'}
                                                            ]
                                                }
                                            );

    alDatos.loadData(dsDatos);
	chkRow=new Ext.grid.CheckboxSelectionModel();
	
	var cModelo= new Ext.grid.ColumnModel   	(
												 	[
													 	new  Ext.grid.RowNumberer(),
														chkRow,
														{
															header:'Comit&eacute;',
															width:250,
															sortable:true,
															dataIndex:'nombreComite'
														}
													]
												);
                                                
	var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            id:idGrid,
                                                            store:alDatos,
                                                            frame:false,
                                                            y:40,
                                                            cm: cModelo,
                                                            height:260,
                                                            width:390,
                                                            sm:chkRow
                                                        }
                                                    );
	return 	tblGrid;
}

function removerComite()
{
	var fila=nodoSelComite;
    if(fila==null)
    {
    	msgBox('Debe seleccionar el Comit&eacute;/Elemento DTD a remover');
    	return;
    }
    else
    {
		var msg;
		if(fila.attributes.tipo=='1')
			msg='&iquest;Est&aacute; seguro de querer remover el comit&eacute; seleccionado?';
		else
			msg='&iquest;Est&aacute; seguro de querer remover el elemento de DTD seleccionado?';
	
    	function resp(btn)
        {
        	if(btn=='yes')
            {
				function funcAjax()
				{
					var resp=peticion_http.responseText;
					arrResp=resp.split('|');
					if(arrResp[0]=='1')
					{
						nodoSelComite.remove();
						nodoSelComite=null;
						Ext.getCmp('btnRemoverCE').disable();
						Ext.getCmp('btnCambiarComite').hide();
						Ext.getCmp('btnCambiarElemento').hide();

					}
					else
					{
						msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
					}
				}
				obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=17&tProceso='+tProceso+'&id='+fila.id+'&tipo='+fila.attributes.tipo,true);
			}
        }
        Ext.MessageBox.confirm('<?php echo $etj["lblAplicacion"]?>',msg,resp);
    }
}

function generarArbolComites()
{
	var idProceso=gE('idDocumento').value;
	var cargadorArbol=new Ext.tree.TreeLoader(
												{
													baseParams:{
																	funcion:'18',
																	idProyecto:idProceso
																},
													dataUrl:'../paginasFunciones/funcionesProyectos.php'
												}
											)	

    var raiz=new  Ext.tree.AsyncTreeNode	(
                                                  {
                                                      id:'comites',
                                                      text:'comites',
                                                      draggable:false,
                                                      expanded :true
                                                  }
                                            )

	panelArbol=new Ext.tree.TreePanel	(
                                              {
                                              	  id:'arbolComites',
                                                  el:'tblComites',
                                                  useArrows:true,
                                                  autoScroll:true,
                                                  animate:false,
                                                  enableDD:true,
                                                  containerScroll:true,
                                                  height:550,
												  width:700,
                                                  root:raiz,
                                                  rootVisible:false,
												  loader: cargadorArbol,
                                                  tbar:	[
                                                  			{
                                                            	id:'btnAgregarComite',
                                                            	tooltip:'Agregar Comit&eacute; a la etapa seleccionada',
                                                                icon:'../images/user_add.png',
																cls:'x-btn-text-icon',
                                                                disabled:true,
                                                                handler:function()
                                                                        {
                                                                        	agregarComite();
                                                                        }
                                                            },'-',
                                                            {
																id:'btnAgregarCEDTD',
                                                            	tooltip:'Agregar Elemento al comit&eacute; seleccionado',
                                                                icon:'../images/brick_add.jpg',
																cls:'x-btn-text-icon',
                                                                disabled:true,
                                                                handler:function()
                                                                        {
                                                                        	switch(tProceso)
                                                                            {
                                                                            	case '9':
                                                                                	agregarConceptosEvaluacion();
                                                                                break
                                                                                default:
                                                                        			agregarCElementoDTD();
                                                                                break;
                                                                            }
                                                                        }
                                                            },'-',
                                                            {
																id:'btnRemoverCE',
                                                            	tooltip:'Remover Comit&eacute;/Elemento seleccionado',
                                                                icon:'../images/delete.png',
																cls:'x-btn-text-icon',
																disabled:true,
                                                                handler:function()
                                                                        {
                                                                        	removerComite();
                                                                        }
                                                            },
															'-',
															{
																id:'btnCambiarComite',	
																text:'Cambiar funci&oacute;n del Comit&eacute; a:',
																cls:'x-btn-text-icon',
																icon:'../images/update_nw.gif',
																hidden:true,
																menu:	[
																			{
																				text:'Permitir crear formularios',
																				handler:function()
																						{
																							cambiarFunciones(1,'1');
																						}
																			},
																			{
																				text:'No permitir crear formularios',
																				handler:function()
																						{
																							cambiarFunciones(1,'0');
																						}
																			}		
																		]
															},
															{
																id:'btnCambiarElemento',	
																text:'Cambiar funci&oacute;n sobre el Elemento a:',
																hidden:true,
																cls:'x-btn-text-icon',
																icon:'../images/update_nw.gif',
																menu:	[
																			{
																				text:'S&oacute;lo Ver',
																				handler:function()
																						{
																							cambiarFunciones(2,'0');
																						}
																			},
																			{
																				text:'Ver y dictaminar',
																				handler:function()
																						{
																							cambiarFunciones(2,'1');
																						}
																			}		
																		]
															}
                                                           
                                                  		]
                                              }
                                          );                                                 	  
    panelArbol.render();
    panelArbol.expandAll();
    panelArbol.on('click',funcClikArbolComite);
}

function funcClikArbolComite(nodo, evento)
{
	nodoSelComite=nodo;
	Ext.getCmp('btnRemoverCE').enable();
    switch(nodoSelComite.attributes.tipo)
    {
    	case '0':
            //Ext.getCmp('btnCambiarComite').hide();
            Ext.getCmp('btnAgregarComite').disable();
            Ext.getCmp('btnAgregarCEDTD').disable();
            Ext.getCmp('btnCambiarElemento').hide();
        break;
        case '1':
        	//Ext.getCmp('btnCambiarComite').show();
            Ext.getCmp('btnCambiarElemento').hide();
            Ext.getCmp('btnAgregarCEDTD').enable();
            Ext.getCmp('btnRemoverCE').enable();
            Ext.getCmp('btnAgregarComite').disable();
        break;
        case '2':
        	Ext.getCmp('btnAgregarComite').enable();
            Ext.getCmp('btnAgregarCEDTD').disable();
            Ext.getCmp('btnRemoverCE').disable();
            Ext.getCmp('btnCambiarComite').hide();
            Ext.getCmp('btnCambiarElemento').hide();
        break;
    }
}

function agregarEtapa()
{
	var tblGridEtapas=crearGridEtapas();
	
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'label',
											items: 	[
														{
                                                        	x:10,
                                                            y:10,
                                                            html:'Seleccione las etapas del proyecto en las cuales el comit&eacute; seleccionado participar&aacute;:'
                                                        },
                                                        tblGridEtapas

													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Agregar etapas a comit&eacute;',
										width: 420,
										height:420,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var filas=tblGridEtapas.getSelectionModel().getSelections();
                                                                        if(filas.length==0)
                                                                        {
                                                                        	msgBox('Al menos debe seleccionar una etapa en la que el comit&eacute; participar&aacute;');
                                                                            return;
                                                                        }
                                                                        
                                                                        var numEtapas='';
                                                                        var x;
                                                                        for(x=0;x<filas.length;x++)
                                                                        {
                                                                        	if(numEtapas=='')
                                                                            	numEtapas=filas[x].get('numEtapa');
                                                                            else
                                                                            	numEtapas+=','+filas[x].get('numEtapa');
                                                                        }
                                                                        
                                                                        function funcAjax()
                                                                        {
                                                                            var resp=peticion_http.responseText;
                                                                            arrResp=resp.split('|');
                                                                            if(arrResp[0]=='1')
                                                                            {
                                                                            	Ext.getCmp('arbolComites').getRootNode().reload();
                                                                                ventanaAM.close();
                                                                            }
                                                                            else
                                                                            {
                                                                                msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                            }
                                                                        }
                                                                        obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=31&idProceso='+idProceso+'&idComite='+nodoSelComite.id+'&numEtapas='+numEtapas,true);
                                                                        
                                                                        
                                                                        
                                                                        
                                                                        
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
                                
       
    function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	tblGridEtapas.getStore().loadData(eval(arrResp[1]));
        	ventanaAM.show();
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=30&idProceso='+idProceso+'&idProyectoComite='+nodoSelComite.id,true);                         
}

function crearGridEtapas()
{
	dsDatos=[];
    alDatos=	new Ext.data.SimpleStore	(
                                                {
                                                    fields:	[
                                                                {name: 'numEtapa'},
                                                                {name: 'nombreEtapa'}
                                                            ]
                                                }
                                            );

    alDatos.loadData(dsDatos);
	chkRow=new Ext.grid.CheckboxSelectionModel();
	
	var cModelo= new Ext.grid.ColumnModel   	(
												 	[
													 	new  Ext.grid.RowNumberer(),
														chkRow,
														{
															header:'No. Etapa',
															width:100,
															sortable:true,
															dataIndex:'numEtapa'
														},
														{
															header:'Etapa',
															width:200,
															sortable:true,
															dataIndex:'nombreEtapa'
														}
													]
												);
                                                
	var tblGrid=	new Ext.grid.EditorGridPanel	(
                                                        {
                                                            store:alDatos,
                                                            frame:true,
                                                            x:10,
                                                            y:50,
                                                            cm: cModelo,
                                                            height:260,
                                                            width:380,
                                                            sm:chkRow
                                                        }
                                                    );
	return 	tblGrid;		
}

function cambiarFunciones(tipo,funcion)
{
	if(funcion==nodoSelComite.attributes.funciones)
		return;

	function funcAjax()
	{
		var resp=peticion_http.responseText;
		arrResp=resp.split('|');
		if(arrResp[0]=='1')
		{
			var titulo='';
			var color='';
			var texto='';
			if(tipo==1)
			{
				switch(funcion)
				{
					case '0':
						color='gray';
						texto='No puede crear formularios';
					break;
					case '1':
						color='green';
						texto='Puede crear formularios';
					break;
				}
			}
			else
			{
				switch(funcion)
				{
					case '0':
						color='darkred';
						texto='S&oacute;lo Ver';
					break;
					case '1':
						color='blue';
						texto='Ver y dictaminar';
					break;
				}
			}
			titulo=nodoSelComite.attributes.tituloO+" <b>Funci&oacute;n:</b> <font color='"+color+"'><b>"+texto+"</b></font>";					
			nodoSelComite.setText(titulo);
			nodoSelComite.attributes.funciones=funcion;
/*			var panel=Ext.getCmp('arbolComites');
			panel.getRootNode().reload();
			panel.expandAll();*/
		}
		else
		{
			msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
		}
	}
	obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=21&tipo='+tipo+'&valorFuncion='+funcion+'&id='+nodoSelComite.id,true);
}

function agregarCElementoDTD()
{

	var arbolSecciones=crearArbolSecciones();
	var form = new Ext.form.FormPanel(	
										{
											baseCls: 'x-plain',
											layout:'absolute',
											defaultType: 'textfield',
											items: 	[
														{
															x:10,
															y:10,
															xtype:'label',
															html:'Seleccione los elementos del DTD a los que tendr&aacute; acceso el comit&eacute; seleccionado:'
														},
														arbolSecciones

													]
										}
									);
	
	var ventanaAM = new Ext.Window(
									{
										title: 'Agregar Elementos DTD',
										width: 500,
										height:450,
										layout: 'fit',
										plain:true,
										modal:true,
										bodyStyle:'padding:5px;',
										buttonAlign:'center',
										items: form,
										listeners : {
													show : {
																buffer : 10,
																fn : function() 
																{
																}
															}
												},
										buttons:	[
														{
															id:'btnAceptar',
															text: '<?php echo $etj["lblBtnAceptar"]?>',
															handler: function()
																	{
																		var nodos=arbolSecciones.getChecked();
																		var x;
																		var listadoE='';
																		for(x=0;x<nodos.length;x++)
																		{
																			if(listadoE=='')
																				listadoE=nodos[x].id;
																			else
																				listadoE+=','+nodos[x].id;
																		}
																		
																		
																		function funcAjax()
																		{
																			var resp=peticion_http.responseText;
																			arrResp=resp.split('|');
																			if(arrResp[0]=='1')
																			{
																				var panel=Ext.getCmp('arbolComites');
																				panel.getRootNode().reload();
																				panel.expandAll();
																				ventanaAM.close();
																			}
																			else
																			{
																				msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
																			}
																		}
																		obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=20&idProyectoComite='+nodoSelComite.id+'&listadoE='+listadoE,true);
																	}
														},
														{
															text: '<?php echo $etj["lblBtnCancelar"]?>',
															handler:function()
																	{
																		ventanaAM.close();
																	}
														}
													]
									}
								);
	ventanaAM.show();		
}

function crearArbolSecciones()
{
	var idProceso=gE('idDocumento').value;
	

	var cargadorArbol=new Ext.tree.TreeLoader(
												{
													baseParams:{
																	funcion:'19',
																	idProyecto:idProceso,
																	idProyectoComite:nodoSelComite.id
																},
													dataUrl:'../paginasFunciones/funcionesProyectos.php'
												}
											)	
	
    var raizV=new  Ext.tree.AsyncTreeNode	(
                                                  {
                                                      id:'raizVentana',
                                                      text:'',
                                                      draggable:false,
                                                      expanded :true
													  
                                                  }
                                            )
                     
    
	panelArbolV=new Ext.tree.TreePanel	(
                                                  {
												  	  x:10,
													  y:50,
                                                      id:'panelArbolVentana',
                                                      height:300,
                                                      width:450,
                                                      useArrows:true,
                                                      autoScroll:true,
                                                      animate:true,
                                                      enableDD:true,
                                                      containerScroll: true,
                                                      root:raizV,
                                                      rootVisible:false,
                                                      draggable:false,
													  loader: cargadorArbol
                                                  }
                                          );   
    return panelArbolV;
    
}

function validarSituacion(combo)
{

    var situacion=combo.options[combo.selectedIndex].value;
    var idProceso=gE('idDocumento').value;
    function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=40&idProceso='+idProceso+'&situacion='+situacion,true);

    
}

function asignarEtapa(combo)
{
	var numEtapa=combo.options[combo.selectedIndex].value;
    var idProceso=gE('idDocumento').value;
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        	
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=41&idProceso='+idProceso+'&numEtapa='+numEtapa,true);

}

function crearArbolRoles()
{
	var idProceso=gE('idDocumento').value;
	var cargadorArbol=new Ext.tree.TreeLoader(
												{
													baseParams:{
																	funcion:'42',
																	idProceso:idProceso
																},
													dataUrl:'../paginasFunciones/funcionesProyectos.php'
												}
											)	

	cargadorArbol.on('load',function(raiz,node)
    						{
                            	var x;
                                var nodo;
                                arrRolesParticipantesProceso=[['0','Actor de s\xF3lo lectura']];
                                for(x=0;x<node.childNodes.length;x++)
                                {
                                	nodo=node.childNodes[x];
                                    arrRolesParticipantesProceso.push([nodo.id,Ext.util.Format.stripTags(nodo.text)]);
                                }
                            	
                            }
    				)

    var raiz=new  Ext.tree.AsyncTreeNode	(
                                                  {
                                                      id:'roles',
                                                      text:'Roles',
                                                      draggable:false,
                                                      expanded :true
                                                  }
                                            )

	var panelRol=new Ext.tree.TreePanel	(
                                              {
                                              	  id:'arbolRoles',
                                                  el:'spanSelRoles',
                                                  useArrows:true,
                                                  autoScroll:true,
                                                  animate:false,
                                                  enableDD:true,
                                                  containerScroll:true,
                                                  height:280,
												  width:520,
                                                  root:raiz,
                                                  rootVisible:false,
												  loader: cargadorArbol,
                                                  tbar:	[
                                                  			{
                                                            	id:'btnAgregarRol',
                                                            	tooltip:'Agregar Rol',
                                                                icon:'../images/user_add.png',
																cls:'x-btn-text-icon',
                                                               
                                                                handler:function()
                                                                        {
                                                                        	agregarRol();
                                                                        }
                                                            },'-',
                                                            {
                                                            	id:'btnRemoverRol',
                                                            	tooltip:'Remover Rol',
                                                                icon:'../images/user_remove.png',
																cls:'x-btn-text-icon',
                                                               
                                                                handler:function()
                                                                        {
                                                                        	removerRol();
                                                                        }
                                                            }
                                                           
                                                  		]
                                              }
                                          );                                                 	  
    panelRol.render();
    panelRol.expandAll();
    panelRol.on('click',funcClikArbolRol);                                                 
									
}

function funcClikArbolRol(nodo, evento)
{
	nodoSelRol=nodo;
	
}

function agregarRol()
{
	<?php
		if(!existeRol("'1_0'"))
			$consulta="select concat(idRol,'_',extensionRol),nombreGrupo from 8001_roles where vistosAdmin=1 and idIdioma=".$_SESSION["leng"]." and situacion=1 order by nombreGrupo";
		else
			$consulta="select concat(idRol,'_',extensionRol),nombreGrupo from 8001_roles where idIdioma=".$_SESSION["leng"]." and situacion=1 order by nombreGrupo";
		$arrRoles=uEJ($con->obtenerFilasArreglo($consulta));
	?>
    var idProceso=gE('idDocumento').value;
    var arrRoles=<?php echo $arrRoles;?>;
    var cmbExtensiones=crearComboExt('cmbExtensiones',[],75,35,250);
	cmbExtensiones.hide();
	var cmbRoles=crearComboExt('cmbRoles',arrRoles,75,5,360);
    function rolSeleccionado(combo,registro,indice)
    {
    	cmbExtensiones.reset();
    	var idRegistro=registro.get('id');
        var arrId=idRegistro.split('_');
        if(arrId[1]!=0)
        {
        	function funcAjax()
            {
                var resp=peticion_http.responseText;
                arrResp=resp.split('|');
                if(arrResp[0]=='1')
                {
					var arrExtensiones=eval(arrResp[1]);
                    cmbExtensiones.getStore().loadData(arrExtensiones);                
                	cmbExtensiones.show();
		            Ext.getCmp('lblExtension').show();
                }
                else
                {
                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                }
            }
            obtenerDatosWeb('../paginasFunciones/funcionesUsuarios.php',funcAjax, 'POST','funcion=20&extension='+arrId[1],true);
        }
        else
        {
        	cmbExtensiones.hide();
            Ext.getCmp('lblExtension').hide();
        }
        
    }
    
    cmbRoles.on('select',rolSeleccionado);
    
	var form=new Ext.form.FormPanel(
										{
											baseCls: 'x-plain',
											layout:'absolute',
											disabled:false,
											items:
													[
													 	{
                                                        	id:'lblRol',
                                                            x:10,
                                                            y:10,
                                                            xtype:'label',
                                                            html:'Rol:'
                                                        },
                                                        cmbRoles,
                                                        {
                                                        	id:'lblExtension',
                                                        	x:10,
                                                            y:40,
                                                            xtype:'label',
                                                            html:'Extensi&oacute;n:',
                                                            hidden:true
                                                        },
                                                        cmbExtensiones
													]
										}
									)
	var ventana=new Ext.Window(
							   		{
										title:'Agregar rol',
										width:480,
										height:150,
										layout:'fit',
										buttonAlign:'center',
										items:[form],
										modal:true,
										plain:true,
										listeners:
											{
												show:
												{
													buffer:10,fn:function()
															{
																
															}
												}
											},
										buttons:
												[
												 	{
														text:'Aceptar',
														handler:function ()
															{
                                                            	var rol=cmbRoles.getValue();
                                                                var arrId=rol.split('_');
                                                                var extension='0';
                                                                if(arrId[1]!=0)
                                                                	extension=cmbExtensiones.getValue();	
                                                                if(extension=='')
                                                                {
                                                                	function resp()
                                                                    {
                                                                    	cmbExtensiones.focus();
                                                                    }
                                                                	Ext.MessageBox.alert('<?php echo $etj["lblAplicacion"]?>','Debe seleccionar una extensi&oacute;n del rol',resp);
                                                                    return;
                                                                }
                                                                
                                                                var codigoRolN=arrId[0]+'_'+extension;
                                                                
                                                                var rolPanel=Ext.getCmp('arbolRoles');
                                                                var nodoRol=rolPanel.getNodeById(codigoRolN);
                                                                if(nodoRol!=null)
                                                                {
                                                                	ventana.close();
                                                                    return;
                                                                }
                                                                function funcAjax()
                                                                {
                                                                    var resp=peticion_http.responseText;
                                                                    arrResp=resp.split('|');
                                                                    if(arrResp[0]=='1')
                                                                    {
                                                                    	rolPanel.getRootNode().reload();
                                                                        ventana.close();
                                                                    }
                                                                    else
                                                                    {
                                                                        msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                    }
                                                                }
                                                                obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=43&idProceso='+idProceso+'&rol='+codigoRolN,true);
                                                                
																
															}
													},
													{
														text:'Cancelar',
														handler:function ()
															{
																ventana.close();
															}
													}
												 ]
									}
							   )
	ventana.show();
}

function removerRol()
{
	 var idProceso=gE('idDocumento').value;
	if(nodoSelRol==null)
    {
    	msgBox('Debe seleccionar el rol a remover');
        return;
    }
    
    function resp(btn)
    {
    	if(btn=='yes')
        {
        	var rol=nodoSelRol.id;
        	function funcAjax()
            {
                var resp=peticion_http.responseText;
                arrResp=resp.split('|');
                if(arrResp[0]=='1')
                {
                    nodoSelRol.remove();
                }
                else
                {
                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                }
            }
            obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=44&idProceso='+idProceso+'&rol='+rol,true);
        
        }
    }
    msgConfirm('Esta seguro de querer remover el rol seleccionado?',resp);
}

function redimensionarIframe(iFrame)
{
    iFrame.height='110%';
    if(Ext.isGecko)
    	var the_height=iFrame.contentWindow.innerHeight+iFrame.contentWindow.scrollMaxY+30;
    else
    	var the_height=iFrame.contentWindow.document.body.scrollHeight;
    
    iFrame.scrolling='no';
    var tabPanel= Ext.getCmp('tabPanel');
    if(tabPanel!=null)
    {
        if(the_height>530)
            tabPanel.setHeight(the_height+20);
        else
            tabPanel.setHeight(530);
    }
}

function actualizaPrefijo(ctrl)
{
	var idProceso=gE('idDocumento').value;
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=212&accion=1&idProceso='+idProceso+'&valor='+cv(ctrl.value),true);

}

function actualizaSeparador(ctrl)
{
	var idProceso=gE('idDocumento').value;
	function funcAjax()
    {
        var resp=peticion_http.responseText;
        arrResp=resp.split('|');
        if(arrResp[0]=='1')
        {
        }
        else
        {
            msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
        }
    }
    obtenerDatosWeb('../paginasFunciones/funcionesProyectos.php',funcAjax, 'POST','funcion=212&accion=2&idProceso='+idProceso+'&valor='+cv(ctrl.value),true);
}

function recargarTabEscenario()
{
	var tab5=Ext.getCmp('tab5');
    var iP=idProceso;
    tab5.load({url:'../modeloPerfiles/configuracionEscenario.php',params:{idProceso:+iP,cPagina:'sFrm=true|gConfS=true',scripts:true}});
}

function topePresChange(combo)
{
	var idTope=combo.options[combo.selectedIndex].value;
    if(idTope==4)
    	mE('filaTopePorc');
    else
    {
    	oE('filaTopePorc');
        gE('margenCre').value='';
    }
}


function recargarEscenarioLita()
{
	var iP=gE('idProceso').value;
	Ext.getCmp('tab6').load({url:'../procesoPOA/configuracionEscenarioLitaPOA.php',params:{idProceso:+iP,cPagina:'sFrm=true|gConfS=true',scripts:true}});

}

function generarArbolPartipantes()
{
	var idProceso=gE('idDocumento').value;
	var cargadorArbol=new Ext.tree.TreeLoader(
												{
													baseParams:{
																	funcion:'167',
																	idProyecto:idProceso
																},
													dataUrl:'../paginasFunciones/funcionesProyectos.php'
												}
											)	

    var raiz=new  Ext.tree.AsyncTreeNode	(
                                                  {
                                                      id:'participantes',
                                                      text:'Participantes',
                                                      draggable:false,
                                                      expanded :true
                                                  }
                                            )

	

	panelArbol=new Ext.tree.TreePanel	(
                                              {
                                              	  id:'arbolParticipantes',
                                                  el:'tblParticipantesAccion',
                                                  useArrows:true,
                                                  autoScroll:true,
                                                  animate:false,
                                                  enableDD:true,
                                                  containerScroll:true,
                                                  height:280,
												  width:520,
                                                  root:raiz,
                                                  rootVisible:false,
												  loader: cargadorArbol,
                                                  tbar:	[
                                                  			{
                                                            	id:'btnAgregarParticipante',
                                                            	tooltip:'Agregar Participante a la etapa seleccionada',
                                                                icon:'../images/user_add.png',
																cls:'x-btn-text-icon',
                                                                disabled:true,
                                                                handler:function()
                                                                        {
                                                                        	agregarParticipante();
                                                                        }
                                                            },'-',
                                                            {
																id:'btnAgregarCEDTDPart',
                                                            	tooltip:'Agregar Elemento al participante seleccionado',
                                                                icon:'../images/brick_add.jpg',
																cls:'x-btn-text-icon',
                                                                disabled:true,
                                                                handler:function()
                                                                        {
                                                                        	agregarCElementoDTDParticipante();
                                                                        }
                                                            },'-',
                                                            {
																id:'btnAgregarAccion',
                                                            	tooltip:'Agregar una acci&oacute;n al participante seleccionado',
                                                                icon:'../images/lightning_add.png',
																cls:'x-btn-text-icon',
                                                                disabled:true,
                                                                handler:function()
                                                                        {
																			agregarAccionParticipante();
                                                                        }
                                                            },'-',
                                                            {
																id:'btnRemoverParticipante',
                                                            	tooltip:'Remover elemento seleccionado',
                                                                icon:'../images/delete.png',
																cls:'x-btn-text-icon',
																disabled:true,
                                                                handler:function()
                                                                        {
                                                                        	removerParticipante();
                                                                        }
                                                            },
															'-',
															
															{
																id:'btnCambiarElementoParticipante',	
																text:'Cambiar funci&oacute;n sobre el Elemento a:',
																hidden:true,
																cls:'x-btn-text-icon',
																icon:'../images/update_nw.gif',
																menu:	[
																			{
																				text:'S&oacute;lo Ver',
																				handler:function()
																						{
																							cambiarFuncionesParticipante('0');
																						}
																			},
																			{
																				text:'Ver y modificar',
																				handler:function()
																						{
																							cambiarFuncionesParticipante('1');
																						}
																			}		
																		]
															},'-',
                                                            {
																id:'btnModifEnvioEtapa',
                                                                text:'Modificar env&iacute;o de etapa',
                                                            	tooltip:'Modificar env&iacute;o de etapa',
                                                                icon:'../images/pencil.png',
																cls:'x-btn-text-icon',
																hidden:true,
                                                                handler:function()
                                                                        {
                                                                        	modificarPasoEtapaParticipante();
                                                                        }
                                                            }
                                                           
                                                  		]
                                              }
                                          );                                                 	  
    panelArbol.render();
    panelArbol.expandAll();
    panelArbol.on('click',funcClikArbolParticipantes);
}

function funcClikArbolParticipantes(nodo, evento)
{
	nodoSelParticipante=nodo;
	Ext.getCmp('btnRemoverParticipante').enable();
    switch(nodoSelParticipante.attributes.tipo)
    {
    	case '0':
            Ext.getCmp('btnAgregarParticipante').disable();
            Ext.getCmp('btnAgregarCEDTDPart').disable();
            Ext.getCmp('btnAgregarAccion').disable();
            Ext.getCmp('btnCambiarElementoParticipante').show();
        break;
        case '1':
            Ext.getCmp('btnCambiarElementoParticipante').hide();
            Ext.getCmp('btnAgregarCEDTDPart').disable();
            Ext.getCmp('btnAgregarAccion').disable();
            Ext.getCmp('btnRemoverParticipante').enable();
            Ext.getCmp('btnAgregarParticipante').disable();
        break;
        case '2':
        	Ext.getCmp('btnAgregarParticipante').enable();
            Ext.getCmp('btnAgregarCEDTDPart').disable();
            Ext.getCmp('btnAgregarAccion').disable();
            Ext.getCmp('btnRemoverParticipante').disable();
            Ext.getCmp('btnCambiarElementoParticipante').hide();
        break;
        case '3':
        	Ext.getCmp('btnAgregarParticipante').disable();
            Ext.getCmp('btnAgregarAccion').disable();
            Ext.getCmp('btnAgregarCEDTDPart').enable();
            Ext.getCmp('btnRemoverParticipante').disable();
            Ext.getCmp('btnCambiarElementoParticipante').hide();
        break;
         case '4':
        	Ext.getCmp('btnAgregarParticipante').disable();
            Ext.getCmp('btnAgregarCEDTDPart').disable();
            Ext.getCmp('btnRemoverParticipante').disable();
            Ext.getCmp('btnAgregarAccion').enable();
            Ext.getCmp('btnCambiarElementoParticipante').hide();
        break;
        case '5':
        	Ext.getCmp('btnAgregarParticipante').disable();
            Ext.getCmp('btnAgregarCEDTDPart').disable();
            Ext.getCmp('btnRemoverParticipante').enable();
            Ext.getCmp('btnAgregarAccion').disable();
            Ext.getCmp('btnCambiarElementoParticipante').hide();
        break;
    }
    
    if(nodoSelParticipante.attributes.modifEtapa!=undefined)
    	gEx('btnModifEnvioEtapa').show();
    else
    	gEx('btnModifEnvioEtapa').hide();
}


function agregarRolModulo()
{

	<?php
		$consulta="select concat(idRol,'_',extensionRol),nombreGrupo from 8001_roles where  idIdioma=".$_SESSION["leng"]." order by nombreGrupo";
		$arrRoles=uEJ($con->obtenerFilasArreglo($consulta));
	?>
    var arrRoles=<?php echo $arrRoles;?>;
    var cmbExtensiones=crearComboExt('cmbExtensiones',[],100,35,250);
	cmbExtensiones.hide();
	var cmbRoles=crearComboExt('cmbRoles',arrRoles,100,5,360);
    function rolSeleccionado(combo,registro,indice)
    {
    	cmbExtensiones.reset();
    	var idRegistro=registro.get('id');
        var arrId=idRegistro.split('_');
        if(arrId[1]!=0)
        {
        	function funcAjax()
            {
                var resp=peticion_http.responseText;
                arrResp=resp.split('|');
                if(arrResp[0]=='1')
                {
					var arrExtensiones=eval(arrResp[1]);
                    cmbExtensiones.getStore().loadData(arrExtensiones);     
                    
                	cmbExtensiones.show();
		            Ext.getCmp('lblExtension').show();
                }
                else
                {
                    msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                }
            }
            obtenerDatosWeb('../paginasFunciones/funcionesUsuarios.php',funcAjax, 'POST','funcion=20&noTodos=true&extension='+arrId[1],true);
        
        	
        }
        else
        {
        	cmbExtensiones.hide();
            Ext.getCmp('lblExtension').hide();
        }
        
    }
    
    cmbRoles.on('select',rolSeleccionado);
    
	var form=new Ext.form.FormPanel(
										{
											baseCls: 'x-plain',
											layout:'absolute',
											disabled:false,
											items:
													[
													 	{
                                                        	id:'lblRol',
                                                            x:10,
                                                            y:10,
                                                            xtype:'label',
                                                            html:'Rol:'
                                                        },
                                                        cmbRoles,
                                                        {
                                                        	id:'lblExtension',
                                                        	x:10,
                                                            y:40,
                                                            xtype:'label',
                                                            html:'Extensi&oacute;n:',
                                                            hidden:true
                                                        },
                                                        cmbExtensiones
													]
										}
									)
	var ventana=new Ext.Window(
							   		{
										title:'Agregar rol',
										width:480,
										height:150,
										layout:'fit',
										buttonAlign:'center',
										items:[form],
										modal:true,
										plain:true,
										listeners:
											{
												show:
												{
													buffer:10,fn:function()
															{
																
															}
												}
											},
										buttons:
												[
												 	{
														text:'Aceptar',
														handler:function ()
															{
                                                            	var rol=cmbRoles.getValue();
                                                                var arrId=rol.split('_');
                                                                var extension='0';
                                                                if(arrId[1]!=0)
                                                                	extension=cmbExtensiones.getValue();	
                                                                if(extension=='')
                                                                {
                                                                	function resp()
                                                                    {
                                                                    	cmbExtensiones.focus();
                                                                    }
                                                                	msgBox('Debe seleccionar una extensi&oacute;n del rol',resp);
                                                                    return;
                                                                }
                                                                var listRoles=gE('listRoles');
                                                                var codigoRol=arrId[0]+'_'+extension;
                                                                var rolExiste=existeRol('listRoles',codigoRol);
                                                                
                                                                if(!rolExiste)
                                                                {
                                                                	
                                                                	var option=document.createElement('option');
                                                                    option.value=codigoRol;
                                                                    var nExtension=cmbExtensiones.getValue();
                                                                    var txtExtension='';
                                                                    if(nExtension!='')
                                                                    {
                                                                    	txtExtension=' ('+cmbExtensiones.getRawValue()+')';
                                                                    }
                                                                    option.text=cmbRoles.getRawValue()+txtExtension;
                                                                    listRoles.options[listRoles.options.length]=option;
                                                                }
                                                                else
                                                                {
                                                                	msgBox('El rol seleccionado ya ha sido agregado previamente')
                                                                    return;
                                                                }
                                                                
                                                                ventana.close();
																
															}
													},
													{
														text:'Cancelar',
														handler:function ()
															{
																ventana.close();
															}
													}
												 ]
									}
							   )
	ventana.show();

}

function existeRol(idCombo,valor)
{
	var combo=gE(idCombo);
    var x;
    for(x=0;x<combo.options.length;x++)
    {
    	if(combo.options[x].value==valor)
        	return true;
    }
    return false;
}

function removerRolModulo()
{
	var cmbRoles=gE('listRoles');
	var rol=cmbRoles.selectedIndex;
	if(rol==-1)
	{
		Ext.MessageBox.alert('<?php echo $etj["lblAplicacion"]?>','Debe elegir el rol a remover');
        return;
	}
    
    function resp(btn)
    {
    	if(btn=='yes')
        	cmbRoles[cmbRoles.selectedIndex]=null;
    }
   msgConfirm('Est&aacute; seguro de querer remover este rol',resp);
    
    
}

function mostrarFormulario(idFormulario)
{
	var arrDatos=[['oCamposComp','1'],['idFormulario',bD(idFormulario)],['cPagina','mR1=false|mI=false']];
	window.open('',"vAuxiliar", "toolbar=no,directories=no,menubar=no,status=no,scrollbars=yes,fullscreen=yes");
    enviarFormularioDatosV('../modeloPerfiles/formularios.php',arrDatos,'POST','vAuxiliar');

}


var arrElementos;

function abrirEscenarioActor()
{
	var obj={};
    obj.url='../procesos/tblEscenarioActor.php';
    obj.title='Perfiles de escenarios';
    obj.params=[['idProceso',gE('idDocumento').value]];
    obj.ancho='90%';
    obj.alto='95%'
    abrirVentanaFancy(obj);
    
}

function crearGridNotificaciones(e)
{
	   var lector= new Ext.data.JsonReader({
                                            
                                            totalProperty:'numReg',
                                            fields: [
                                               			{name:'idNotificacion'},
		                                                {name: 'tituloNotificacion'},
		                                                {name:'descripcion'}
                                            		],
                                            root:'registros'
                                            
                                        }
                                      );
	 
                                                                                      
	var alDatos=new Ext.data.GroupingStore({
                                                            reader: lector,
                                                            proxy : new Ext.data.HttpProxy	(

                                                                                              {

                                                                                                  url: '../paginasFunciones/funcionesFormulario.php'

                                                                                              }

                                                                                          ),
                                                            sortInfo: {field: 'tituloNotificacion', direction: 'ASC'},
                                                            groupField: 'tituloNotificacion',
                                                            remoteGroup:false,
				                                            remoteSort: false,
                                                            autoLoad:true
                                                            
                                                        }) 
	alDatos.on('beforeload',function(proxy)
    								{
                                    	proxy.baseParams.funcion='232';
                                        proxy.baseParams.idProceso=idProceso;
                                       
                                    }
                        )   
    
    
    alDatos.on('load',function(proxy,registros)
    								{
                                    	arrTipoNotificaciones=[];
                                        var x;
                                        var fila;
                                        for(x=0;x<registros.length;x++)
                                        {
                                        	fila=registros[x];
                                            arrTipoNotificaciones.push([fila.data.idNotificacion,fila.data.tituloNotificacion]);
                                        }
                                        
                                        if(gEx('gConfiguracionNotificaciones'))
                                        {
                                        	gEx('gConfiguracionNotificaciones').getStore().reload();
                                        }
                                       
                                    }
                        )   
       
    var cModelo= new Ext.grid.ColumnModel   	(
                                                    [
                                                        new  Ext.grid.RowNumberer(),
                                                        
                                                        {
                                                            header:'T&iacute;tulo notificaci&oacute;n',
                                                            width:300,
                                                            sortable:true,
                                                            dataIndex:'tituloNotificacion'
                                                        },
                                                        {
                                                            header:'Descripci&oacute;n',
                                                            width:450,
                                                            sortable:true,
                                                            dataIndex:'descripcion',
                                                            renderer:mostrarValorDescripcion
                                                        }
                                                    ]
                                                );
                                                    
    var tblGrid=	new Ext.grid.GridPanel	(
                                                        {
                                                            id:'gNotificaciones',
                                                            store:alDatos,
                                                            region:'center',
                                                            frame:false,
                                                            height:450,
                                                            cm: cModelo,
                                                            stripeRows :true,
                                                            loadMask:true,
                                                            columnLines : true,                                                            
                                                            tbar:	[
                                                            			{
                                                                        	icon:'../images/add.png',
                                                                            cls:'x-btn-text-icon',
                                                                            text:'Crear notificaci&oacute;n',
                                                                            handler:function()
                                                                            		{
                                                                                    	var obj={};
                                                                                        obj.ancho='95%';
                                                                                        obj.alto='95%';
                                                                                        obj.openEffect='fade';
                                                                                        obj.titulo='Crear notificaci&oacute;n';
                                                                                        obj.url='../modeloPerfiles/notificacionProceso.php';
                                                                                        obj.params=[['idNotificacion','-1'],['cPagina','sFrm=true'],['idProceso',idProceso]];
                                                                                        abrirVentanaFancy(obj);
                                                                                        
                                                                                        
                                                                                    }
                                                                            
                                                                        },'-',
                                                                        {
                                                                        	icon:'../images/pencil.png',
                                                                            cls:'x-btn-text-icon',
                                                                            text:'Modificar notificaci&oacute;n',
                                                                            handler:function()
                                                                            		{
                                                                                    	var fila=tblGrid.getSelectionModel().getSelected();
                                                                                        
                                                                                        if(!fila)
                                                                                        {
                                                                                        	msgBox('Debe seleccionar la notificaci&oacute;n que desea modificar');
                                                                                        	return;
                                                                                        }
                                                                                        
                                                                                    	var obj={};
                                                                                        obj.ancho='95%';
                                                                                        obj.alto='95%';
                                                                                        obj.openEffect='fade';
                                                                                        obj.titulo='Modificar notificaci&oacute;n';
                                                                                        obj.url='../modeloPerfiles/notificacionProceso.php';
                                                                                        obj.params=[['idNotificacion',fila.data.idNotificacion],['cPagina','sFrm=true'],['idProceso',idProceso]];
                                                                                        abrirVentanaFancy(obj);
                                                                                        
                                                                                    }
                                                                            
                                                                        },'-',
                                                                        {
                                                                        	icon:'../images/delete.png',
                                                                            cls:'x-btn-text-icon',
                                                                            text:'Remover notificaci&oacute;n',
                                                                            handler:function()
                                                                            		{
                                                                                    	var fila=tblGrid.getSelectionModel().getSelected();
                                                                                        
                                                                                        if(!fila)
                                                                                        {
                                                                                        	msgBox('Debe seleccionar la notificaci&oacute;n que desea remover');
                                                                                        	return;
                                                                                        }	
                                                                                        
                                                                                        function resp(btn)
                                                                                        {
                                                                                            if(btn=='yes')
                                                                                            {
                                                                                                function funcAjax()
                                                                                                {
                                                                                                    var resp=peticion_http.responseText;
                                                                                                    arrResp=resp.split('|');
                                                                                                    if(arrResp[0]=='1')
                                                                                                    {
                                                                                                        
                                                                                                        gEx('gNotificaciones').getStore().reload();
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        msgBox('<?php echo $etj["errOperacion"]?>'+' <br />'+arrResp[0]);
                                                                                                    }
                                                                                                }
                                                                                                obtenerDatosWeb('../paginasFunciones/funcionesFormulario.php',funcAjax, 'POST','funcion=238&idNotificacion='+fila.data.idNotificacion,true);
                                                                                            }
                                                                                        }
                                                                                        msgConfirm('Est&aacute; seguro de querer remover la notificaci&oacute;n seleccionada?',resp);
                                                                                        
                                                                                        
                                                                                    }
                                                                            
                                                                        }
                                                                        
                                                            		],
                                                            view:new Ext.grid.GroupingView({
                                                                                                forceFit:false,
                                                                                                showGroupName: false,
                                                                                                enableGrouping :false,
                                                                                                enableNoGroups:false,
                                                                                                enableGroupingMenu:false,
                                                                                                hideGroupedColumn: false,
                                                                                                startCollapsed:false
                                                                                            })
                                                        }
                                                    );
        return 	tblGrid;	
}


function recargarGridNotificaciones()
{
	gEx('gNotificaciones').getStore().reload();
}